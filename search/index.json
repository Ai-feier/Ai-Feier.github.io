[{"content":"Redis ç®€ä»‹ Redisï¼ˆå…¨ç§°ä¸ºRemote Dictionary Serverï¼‰æ˜¯ä¸€ä¸ªå¼€æºçš„é«˜æ€§èƒ½é”®å€¼å¯¹å­˜å‚¨ç³»ç»Ÿï¼Œå…·æœ‰å¿«é€Ÿã€çµæ´»å’Œå¯æ‰©å±•çš„ç‰¹æ€§ã€‚å®ƒæ˜¯ä¸€ä¸ªåŸºäºå†…å­˜çš„æ•°æ®ç»“æ„å­˜å‚¨ç³»ç»Ÿï¼Œå¯ä»¥ç”¨ä½œæ•°æ®åº“ã€ç¼“å­˜å’Œæ¶ˆæ¯ä»£ç†ã€‚\näºŒè¿›åˆ¶ç¼–è¯‘å®‰è£… åˆ° å®˜ç½‘ è·å–äºŒè¿›åˆ¶åŒ… è·å–æºç åŒ… 1 2 3 4 5 # å®‰è£…ä¾èµ– apt install -y make gcc wget VERSION=7.0.9 wget https://download.redis.io/releases/redis-$VERSION.tar.gz tar zxvf redis-$VERSION.tar.gz ç¼–è¯‘å®‰è£… 1 2 3 4 cd redis-$VERSION make cd src make install PREFIX=/usr/local/redis ç§»åŠ¨é…ç½®æ–‡ä»¶åˆ°å®‰è£…ç›®å½•ä¸‹ 1 2 3 cd ../ mkdir /usr/local/redis/etc mv redis.conf /usr/local/redis/etc é…ç½® redis ä¸ºåå°å¯åŠ¨ 1 2 # å°†daemonize no æ”¹æˆdaemonize yes sed -i \u0026#39;s/daemonize no/daemonize yes/\u0026#39; /usr/local/redis/etc/redis.conf å°† redis åŠ å…¥åˆ°å¼€æœºå¯åŠ¨ 1 2 # åœ¨é‡Œé¢æ·»åŠ å†…å®¹ï¼š/usr/local/redis/bin/redis-server /usr/local/redis/etc/redis.conf (æ„æ€å°±æ˜¯å¼€æœºè°ƒç”¨è¿™æ®µå¼€å¯redisçš„å‘½ä»¤) echo \u0026#34;/usr/local/redis/bin/redis-server /usr/local/redis/etc/redis.conf\u0026#34; \u0026gt;\u0026gt; /etc/rc.local è®¾ç½® redis å¯†ç  (å¯é€‰) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 vim /usr/local/redis/etc/redis.conf ä¿®æ”¹ requirepass æ ¼å¼å¦‚ä¸‹: # command, these will cause requirepass to be ignored. # requirepass 123456 # New users are initialized with restrictive permissions by default, via the # æ–¹å¼äºŒ a.è¿è¡Œå‘½ä»¤ï¼šredis-cli b.æŸ¥çœ‹ç°æœ‰çš„ redis å¯†ç (å¯é€‰æ“ä½œï¼Œå¯ä»¥æ²¡æœ‰) è¿è¡Œå‘½ä»¤ï¼šconfig get requirepassÂ å¦‚æœæ²¡æœ‰è®¾ç½®è¿‡å¯†ç çš„è¯è¿è¡Œç»“æœä¼šå¦‚ä¸‹å›¾æ‰€ç¤º c.è®¾ç½® redis å¯†ç  è¿è¡Œå‘½ä»¤ï¼šconfig set requirepass ****(****ä¸ºä½ è¦è®¾ç½®çš„å¯†ç )ï¼Œè®¾ç½®æˆåŠŸçš„è¯ä¼šè¿”å›â€˜OKâ€™å­—æ · d.æµ‹è¯•è¿æ¥ é‡å¯ redis æœåŠ¡ //ï¼ˆredis-cli -h 127.0.0.1 -p 6379 -a ****ï¼ˆ****ä¸ºä½ è®¾ç½®çš„å¯†ç ï¼‰ï¼‰ è¾“å…¥Â redis-cli è¿›å…¥å‘½ä»¤æ¨¡å¼ï¼Œä½¿ç”¨ auth \u0026#39;*****\u0026#39; ï¼ˆ****ä¸ºä½ è®¾ç½®çš„å¯†ç ï¼‰ç™»é™† ä¿®æ”¹ bind 1 2 3 4 5 6 7 8 9 vim /usr/local/redis/etc/redis.conf ä¿®æ”¹ bind ä¸ºå®¿ä¸»æœº ip # é˜²ç«å¢™ç›¸å…³ a.é…ç½®é˜²ç«å¢™:Â **firewall-cmd --zone=public --add-port=6379/tcp --permanent**ï¼ˆå¼€æ”¾**6379**ç«¯å£ï¼‰ systemctl restart firewalldï¼ˆé‡å¯é˜²ç«å¢™ä»¥ä½¿é…ç½®å³æ—¶ç”Ÿæ•ˆï¼‰ æŸ¥çœ‹ç³»ç»Ÿæ‰€æœ‰å¼€æ”¾çš„ç«¯å£ï¼šfirewall-cmd --zone=public --list-ports å°† redis-cli, redis-server æ‹·è´åˆ° bin ä¸‹ï¼Œè®© redis-cli æŒ‡ä»¤å¯ä»¥åœ¨ä»»æ„ç›®å½•ä¸‹ç›´æ¥ä½¿ç”¨\n1 2 cp /usr/local/redis/bin/redis-server /usr/local/bin/ cp /usr/local/redis/bin/redis-cli /usr/local/bin/ å¯åŠ¨ redis 1 2 3 4 5 redis-server /usr/local/redis/etc/redis.conf ps -ef | grep redis root 11074 1 0 11:24 ? 00:00:00 redis-server 127.0.0.1:6379 root 11296 1443 0 11:32 pts/0 00:00:00 grep --color=auto redis apt å®‰è£… ubuntu ç‰ˆæœ¬: 20.04\næ›´æ¢é˜¿é‡Œæº(å¯é€‰) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 mv /etc/apt/sources.list /etc/apt/sources.list.bak cat \u0026lt;\u0026lt;EOF \u0026gt; /etc/apt/sources.list deb https://mirrors.aliyun.com/ubuntu/ focal main restricted universe multiverse deb-src https://mirrors.aliyun.com/ubuntu/ focal main restricted universe multiverse deb https://mirrors.aliyun.com/ubuntu/ focal-security main restricted universe multiverse deb-src https://mirrors.aliyun.com/ubuntu/ focal-security main restricted universe multiverse deb https://mirrors.aliyun.com/ubuntu/ focal-updates main restricted universe multiverse deb-src https://mirrors.aliyun.com/ubuntu/ focal-updates main restricted universe multiverse # deb https://mirrors.aliyun.com/ubuntu/ focal-proposed main restricted universe multiverse # deb-src https://mirrors.aliyun.com/ubuntu/ focal-proposed main restricted universe multiverse deb https://mirrors.aliyun.com/ubuntu/ focal-backports main restricted universe multiverse deb-src https://mirrors.aliyun.com/ubuntu/ focal-backports main restricted universe multiverse EOF apt update å®‰è£… redis apt æºä¸­çš„ redis ç›®å‰ç‰ˆæœ¬åœç•™åœ¨ 5.x.x\n1 2 apt-cache madison redis apt install -y redis è®¾ç½®å¼€æœºè‡ªå¯\n1 systemctl enable --now redis-server ä¿®æ”¹é…ç½®æ–‡ä»¶\nä¿®æ”¹bindä¸ºå®¿ä¸»æœº ip ä¿®æ”¹requirepassä»¥æ·»åŠ å¯†ç  ä¿®æ”¹daemonizeè®©å¯åŠ¨çš„ redis åå°è¿è¡Œ (sed -i 's/daemonize no/daemonize yes/' /etc/redis/redis.conf) å¦‚ä½•æ‰¾åˆ° redis é…ç½®æ–‡ä»¶ä½ç½®: systemctl status redis-server.service ä¼šç»™å‡º redis å¯åŠ¨çš„é…ç½®å‚æ•°, å¸¦æœ‰é…ç½®æ–‡ä»¶ä½ç½®\n","date":"2024-01-13T19:54:38+08:00","image":"https://blog-source-mkt.oss-cn-chengdu.aliyuncs.com/blog_source/public/redis/Blog-How-to-monitor-Redis-with-Prometheus.jpg","permalink":"/p/redis-%E7%9A%84%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E4%B8%8E%E5%8C%85%E7%AE%A1%E7%90%86%E5%AE%89%E8%A3%85-%E5%85%A8%E5%8F%91%E8%A1%8C%E7%89%88-linux-%E9%80%9A%E7%94%A8/","title":"Redis çš„äºŒè¿›åˆ¶å®‰è£…ä¸åŒ…ç®¡ç†å®‰è£…, å…¨å‘è¡Œç‰ˆ Linux é€šç”¨"},{"content":"å‰è¨€ å®Œæˆé•œåƒåˆ¶ä½œä¹‹åï¼Œéœ€è¦é€šè¿‡æ¸ é“å°†é•œåƒåˆ†å‘å‡ºå»\nå…¬æœ‰ä»“åº“ï¼šé™¤äº†Dockerå®˜æ–¹çš„DockerHubä¹‹å¤–ï¼Œå›½å†…ä¹Ÿæœ‰å¾ˆå¤šçš„å…¬æœ‰é•œåƒä»“åº“å¯ä»¥ç”¨äºé•œåƒåˆ†å‘ï¼šdockerä¸­å›½å®˜æ–¹åº“ã€é˜¿é‡Œäº‘é•œåƒä»“åº“ç­‰ç­‰ã€‚ ç§æœ‰ä»“åº“ï¼šå¦‚æœåˆ¶ä½œçš„é•œåƒåªæ˜¯åœ¨ä¼ä¸šå†…ä¸ºå„ä¸ªé¡¹ç›®ç»„æœåŠ¡ï¼Œå°±ä¸å¯èƒ½ä¸Šä¼ åˆ°å…¬æœ‰ä»“åº“ï¼Œè€Œæ˜¯éœ€è¦ä¼ä¸šå†…éƒ¨æ­å»ºç§æœ‰ä»“åº“ã€‚ ç›®å‰å¹¿æ³›åº”ç”¨çš„Docker å®˜æ–¹æä¾›çš„ç§æœ‰ä»“åº“æ˜¯Docker Registry V2ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥å­¦ä¹ ä¸€ä¸‹å¦‚ä½•æ­å»ºåŠä½¿ç”¨å®ƒã€‚\nå®‰è£… docker è®©aptå¯ä»¥æ”¯æŒHTTPS 1 $ apt install apt-transport-https ca-certificates curl software-properties-common -y å°†å®˜æ–¹Dockeråº“çš„GPGå…¬é’¥æ·»åŠ åˆ°ç³»ç»Ÿä¸­ 1 2 3 4 $ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add - # é˜¿é‡Œæº $ curl -fsSL https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add - å°†Dockeråº“æ·»åŠ åˆ°APTé‡Œ 1 2 3 4 5 6 # å®˜æ–¹æº $ add-apt-repository \u0026#34;deb [arch=amd64] https://download.docker.com/linux/ubuntu focal stable\u0026#34; # é˜¿é‡Œæº $ add-apt-repository \u0026#34;deb [arch=amd64] https://mirrors.aliyun.com/docker-ce/linux/ubuntu focal stable\u0026#34; # echo \u0026#34;deb [arch=amd64] https://mirrors.aliyun.com/docker-ce/linux/ubuntu focal stable\u0026#34; \u0026gt;\u0026gt; /etc/apt/source.list æ›´æ–°åŒ…åˆ—è¡¨ 1 $ apt update ä¸ºäº†ç¡®ä¿ä¿®æ”¹ç”Ÿæ•ˆï¼Œè®©æ–°çš„å®‰è£…ä»Dockeråº“é‡Œè·å–ï¼Œè€Œä¸æ˜¯ä»Ubuntuè‡ªå·±çš„åº“é‡Œè·å–ï¼Œæ‰§è¡Œï¼š 1 $ apt-cache policy docker-ce å®‰è£… docker-ce 1 $ apt install -y docker-ce é…ç½® docker é˜¿é‡Œæºé•œåƒåœ°å€ 1 2 3 4 5 6 7 8 sudo mkdir -p /etc/docker sudo tee /etc/docker/daemon.json \u0026lt;\u0026lt;-\u0026#39;EOF\u0026#39; { \u0026#34;registry-mirrors\u0026#34;: [\u0026#34;https://nol6uuul.mirror.aliyuncs.com\u0026#34;] } EOF sudo systemctl daemon-reload sudo systemctl restart docker è¸©å‘: æˆ‘ç”¨äº†é˜¿é‡Œäº‘çš„é•œåƒåœ°å€åè€Œæ— æ³•æ‹‰å– kind çš„é•œåƒ, æ­¤æ—¶éœ€è¦åˆ é™¤é˜¿é‡Œæº\næ£€æŸ¥ docker è¿è¡ŒçŠ¶æ€ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 $ systemctl status docker â— docker.service - Docker Application Container Engine Loaded: loaded (/lib/systemd/system/docker.service; enabled; vendor preset: enabled) Active: active (running) since Fri 2024-01-05 16:02:08 CST; 17min ago TriggeredBy: â— docker.socket Docs: https://docs.docker.com Main PID: 241165 (dockerd) Tasks: 12 Memory: 29.6M CGroup: /system.slice/docker.service â””â”€241165 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock Jan 05 16:02:08 master1 dockerd[241165]: time=\u0026#34;2024-01-05T16:02:08.136300388+08:00\u0026#34; level=info msg=\u0026#34;Docker daemon\u0026#34; commit=311b9ff graphdriver=overla\u0026gt; Jan 05 16:02:08 master1 dockerd[241165]: time=\u0026#34;2024-01-05T16:02:08.136351488+08:00\u0026#34; level=info msg=\u0026#34;Daemon has completed initialization\u0026#34; Jan 05 16:02:08 master1 dockerd[241165]: time=\u0026#34;2024-01-05T16:02:08.254789219+08:00\u0026#34; level=info msg=\u0026#34;API listen on /run/docker.sock\u0026#34; Jan 05 16:02:08 master1 systemd[1]: Started Docker Application Container Engine. Jan 05 16:02:46 master1 dockerd[241165]: time=\u0026#34;2024-01-05T16:02:46.543587374+08:00\u0026#34; level=warning msg=\u0026#34;Error persisting manifest\u0026#34; digest=\u0026#34;sha256:2fc\u0026gt; Jan 05 16:03:38 master1 dockerd[241165]: time=\u0026#34;2024-01-05T16:03:38.612170892+08:00\u0026#34; level=info msg=\u0026#34;ignoring event\u0026#34; container=6d8d34f0066bde04811038\u0026gt; Jan 05 16:04:50 master1 dockerd[241165]: time=\u0026#34;2024-01-05T16:04:50.406175352+08:00\u0026#34; level=info msg=\u0026#34;ignoring event\u0026#34; container=504632135d04b87b5ed83f\u0026gt; Jan 05 16:05:35 master1 dockerd[241165]: time=\u0026#34;2024-01-05T16:05:35.656175212+08:00\u0026#34; level=error msg=\u0026#34;Error setting up exec command in container 5046\u0026gt; Jan 05 16:09:52 master1 dockerd[241165]: time=\u0026#34;2024-01-05T16:09:52.944844810+08:00\u0026#34; level=info msg=\u0026#34;Layer sha256:a87ab3c028db3c73f360b49c9dcd171e236\u0026gt; Jan 05 16:09:52 master1 dockerd[241165]: time=\u0026#34;2024-01-05T16:09:52.946428917+08:00\u0026#34; level=info msg=\u0026#34;Layer sha256:82ae998286b2bba64ce571578647adcabef\u0026gt; lines 1-21/21 (END) å®‰è£… registry:2 1 $ docker pull registry:2 å¯åŠ¨ registry 1 2 3 4 $ docker run -d -v /opt/registry:/var/lib/registry --restart always -p 5000:5000 --name registry registry:2 # -v è®©é•œåƒå­˜åœ¨æœ¬æœº, è€Œéå®¹å™¨ # -p æš´éœ²ç«¯å£ # --restart è¿è¡Œå¤±è´¥, æ€»æ˜¯å°è¯•é‡å¯å®¹å™¨ æ¨é€é•œåƒ ä¿®æ”¹ docker config ç”±äº docker push åªæ¥å— https åè®®, æˆ‘ä»¬éœ€è¦ä¿®æ”¹ docker é…ç½®æ–‡ä»¶, ä½¿å…¶éå®‰å…¨è®¿é—®\n1 2 3 4 5 6 7 8 sudo tee /etc/docker/daemon.json \u0026lt;\u0026lt;-\u0026#39;EOF\u0026#39; { \u0026#34;registry-mirrors\u0026#34;: [\u0026#34;https://nol6uuul.mirror.aliyuncs.com\u0026#34;], \u0026#34;insecure-registries\u0026#34;: [\u0026#34;11.0.1.157:5000\u0026#34;] } EOF sudo systemctl daemon-reload sudo systemctl restart docker æ¨é€ nginx åˆ° registry 1 2 3 4 5 6 7 8 9 10 11 12 13 14 $ docker pull nginx # ä¿®æ”¹ tagä¸º: registryåœ°å€/username/projectname:version $ docker tag nginx 11.0.1.157:5000/mkt/nginx:v1 # æ¨é€é•œåƒ $ docker push 11.0.1.157:5000/mkt/nginx:v1 d874fd2bc83b: Pushed 32ce5f6a5106: Pushed f1db227348d0: Pushed b8d6e692a25e: Pushed e379e8aedd4d: Pushed 2edcec3590a4: Pushed v1: digest: sha256:ee89b00528ff4f02f2405e4ee221743ebc3f8e8dd0bfd5c4c20a2fa2aaa7ede3 size: 1570 æŸ¥çœ‹ registry çš„æ‰€æœ‰é•œåƒ 1 2 $ curl http://11.0.1.157:5000/v2/_catalog {\u0026#34;repositories\u0026#34;:[\u0026#34;mkt/nginx\u0026#34;]} ","date":"2024-01-13T17:48:12+08:00","image":"https://blog-source-mkt.oss-cn-chengdu.aliyuncs.com/blog_source/public/docker/Private%20Docker%20Registry.jpg","permalink":"/p/%E4%BD%BF%E7%94%A8-docker-%E6%90%AD%E5%BB%BA%E6%90%AD%E5%BB%BA%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93-~-registry/","title":"ä½¿ç”¨ docker æ­å»ºæ­å»ºç§æœ‰ä»“åº“ ~ Registry"},{"content":"ä»€ä¹ˆæ˜¯ Kind Kindï¼ˆKubernetes in Dockerï¼‰ æ˜¯ä¸€ä¸ª Kubernetes å­µåŒ–é¡¹ç›®ï¼ŒKind æ˜¯ä¸€å¥—å¼€ç®±å³ç”¨çš„ Kubernetes ç¯å¢ƒæ­å»ºæ–¹æ¡ˆã€‚é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å°† Kubernetes æ‰€éœ€è¦çš„æ‰€æœ‰ç»„ä»¶ï¼Œå…¨éƒ¨éƒ¨ç½²åœ¨ä¸€ä¸ª Docker å®¹å™¨ä¸­ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„æ­å»º Kubernetes é›†ç¾¤ã€‚\nKind å·²ç»å¹¿æ³›çš„åº”ç”¨äº Kubernetes ä¸Šæ¸¸åŠç›¸å…³é¡¹ç›®çš„ CI ç¯å¢ƒä¸­ï¼Œå®˜æ–¹æ–‡æ¡£ä¸­ä¹ŸæŠŠ Kind ä½œä¸ºä¸€ç§æœ¬åœ°é›†ç¾¤æ­å»ºçš„å·¥å…·æ¨èç»™å¤§å®¶ã€‚\né¡¹ç›®åœ°å€ï¼šhttps://github.com/kubernetes-sigs/kind\nKind å¯ä»¥åšä»€ä¹ˆï¼Ÿ\nå¿«é€Ÿåˆ›å»ºä¸€ä¸ªæˆ–å¤šä¸ª Kubernetes é›†ç¾¤ æ”¯æŒéƒ¨ç½²é«˜å¯ç”¨çš„ Kubernetes é›†ç¾¤ æ”¯æŒä»æºç æ„å»ºå¹¶éƒ¨ç½²ä¸€ä¸ª Kubernetes é›†ç¾¤ å¯ä»¥å¿«é€Ÿä½æˆæœ¬ä½“éªŒä¸€ä¸ªæœ€æ–°çš„ Kubernetes é›†ç¾¤ï¼Œå¹¶æ”¯æŒ Kubernetes çš„ç»å¤§éƒ¨åˆ†åŠŸèƒ½ æ”¯æŒæœ¬åœ°ç¦»çº¿è¿è¡Œä¸€ä¸ªå¤šèŠ‚ç‚¹é›†ç¾¤ Kind æœ‰å“ªäº›ä¼˜åŠ¿ï¼Ÿ\næœ€å°çš„å®‰è£…ä¾èµ–ï¼Œä»…éœ€è¦å®‰è£… Docker å³å¯ ä½¿ç”¨æ–¹æ³•ç®€å•ï¼Œåªéœ€ Kind Cli å·¥å…·å³å¯å¿«é€Ÿåˆ›å»ºé›†ç¾¤ ä½¿ç”¨å®¹å™¨æ¥æ¨¡ä¼¼ Kubernetes èŠ‚ç‚¹ å†…éƒ¨ä½¿ç”¨ Kubeadm çš„å®˜æ–¹ä¸»æµéƒ¨ç½²å·¥å…· é€šè¿‡äº† CNCF å®˜æ–¹çš„ K8S Conformance æµ‹è¯• å®‰è£… docker è®©aptå¯ä»¥æ”¯æŒHTTPS 1 $ apt install apt-transport-https ca-certificates curl software-properties-common -y å°†å®˜æ–¹Dockeråº“çš„GPGå…¬é’¥æ·»åŠ åˆ°ç³»ç»Ÿä¸­ 1 2 3 4 $ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add - # é˜¿é‡Œæº $ curl -fsSL https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add - å°†Dockeråº“æ·»åŠ åˆ°APTé‡Œ 1 2 3 4 5 6 # å®˜æ–¹æº $ add-apt-repository \u0026#34;deb [arch=amd64] https://download.docker.com/linux/ubuntu focal stable\u0026#34; # é˜¿é‡Œæº $ add-apt-repository \u0026#34;deb [arch=amd64] https://mirrors.aliyun.com/docker-ce/linux/ubuntu focal stable\u0026#34; # echo \u0026#34;deb [arch=amd64] https://mirrors.aliyun.com/docker-ce/linux/ubuntu focal stable\u0026#34; \u0026gt;\u0026gt; /etc/apt/source.list æ›´æ–°åŒ…åˆ—è¡¨ 1 $ apt update ä¸ºäº†ç¡®ä¿ä¿®æ”¹ç”Ÿæ•ˆï¼Œè®©æ–°çš„å®‰è£…ä»Dockeråº“é‡Œè·å–ï¼Œè€Œä¸æ˜¯ä»Ubuntuè‡ªå·±çš„åº“é‡Œè·å–ï¼Œæ‰§è¡Œï¼š 1 $ apt-cache policy docker-ce å®‰è£… docker-ce 1 $ apt install -y docker-ce é…ç½® docker é˜¿é‡Œæºé•œåƒåœ°å€ 1 2 3 4 5 6 7 8 sudo mkdir -p /etc/docker sudo tee /etc/docker/daemon.json \u0026lt;\u0026lt;-\u0026#39;EOF\u0026#39; { \u0026#34;registry-mirrors\u0026#34;: [\u0026#34;https://nol6uuul.mirror.aliyuncs.com\u0026#34;] } EOF sudo systemctl daemon-reload sudo systemctl restart docker è¸©å‘: æˆ‘ç”¨äº†é˜¿é‡Œäº‘çš„é•œåƒåœ°å€åè€Œæ— æ³•æ‹‰å– kind çš„é•œåƒ, æ­¤æ—¶éœ€è¦åˆ é™¤é˜¿é‡Œæº\næ£€æŸ¥ docker è¿è¡ŒçŠ¶æ€ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 $ systemctl status docker â— docker.service - Docker Application Container Engine Loaded: loaded (/lib/systemd/system/docker.service; enabled; vendor preset: enabled) Active: active (running) since Fri 2024-01-05 16:02:08 CST; 17min ago TriggeredBy: â— docker.socket Docs: https://docs.docker.com Main PID: 241165 (dockerd) Tasks: 12 Memory: 29.6M CGroup: /system.slice/docker.service â””â”€241165 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock Jan 05 16:02:08 master1 dockerd[241165]: time=\u0026#34;2024-01-05T16:02:08.136300388+08:00\u0026#34; level=info msg=\u0026#34;Docker daemon\u0026#34; commit=311b9ff graphdriver=overla\u0026gt; Jan 05 16:02:08 master1 dockerd[241165]: time=\u0026#34;2024-01-05T16:02:08.136351488+08:00\u0026#34; level=info msg=\u0026#34;Daemon has completed initialization\u0026#34; Jan 05 16:02:08 master1 dockerd[241165]: time=\u0026#34;2024-01-05T16:02:08.254789219+08:00\u0026#34; level=info msg=\u0026#34;API listen on /run/docker.sock\u0026#34; Jan 05 16:02:08 master1 systemd[1]: Started Docker Application Container Engine. Jan 05 16:02:46 master1 dockerd[241165]: time=\u0026#34;2024-01-05T16:02:46.543587374+08:00\u0026#34; level=warning msg=\u0026#34;Error persisting manifest\u0026#34; digest=\u0026#34;sha256:2fc\u0026gt; Jan 05 16:03:38 master1 dockerd[241165]: time=\u0026#34;2024-01-05T16:03:38.612170892+08:00\u0026#34; level=info msg=\u0026#34;ignoring event\u0026#34; container=6d8d34f0066bde04811038\u0026gt; Jan 05 16:04:50 master1 dockerd[241165]: time=\u0026#34;2024-01-05T16:04:50.406175352+08:00\u0026#34; level=info msg=\u0026#34;ignoring event\u0026#34; container=504632135d04b87b5ed83f\u0026gt; Jan 05 16:05:35 master1 dockerd[241165]: time=\u0026#34;2024-01-05T16:05:35.656175212+08:00\u0026#34; level=error msg=\u0026#34;Error setting up exec command in container 5046\u0026gt; Jan 05 16:09:52 master1 dockerd[241165]: time=\u0026#34;2024-01-05T16:09:52.944844810+08:00\u0026#34; level=info msg=\u0026#34;Layer sha256:a87ab3c028db3c73f360b49c9dcd171e236\u0026gt; Jan 05 16:09:52 master1 dockerd[241165]: time=\u0026#34;2024-01-05T16:09:52.946428917+08:00\u0026#34; level=info msg=\u0026#34;Layer sha256:82ae998286b2bba64ce571578647adcabef\u0026gt; lines 1-21/21 (END) å®‰è£… kubectl apt å®‰è£… 1 2 3 4 5 6 7 8 9 10 11 # å®‰è£…ä¾èµ– apt install apt-transport-https ca-certificates -y # ç¼–è¾‘é•œåƒæºæ–‡ä»¶ï¼Œæ–‡ä»¶æœ«å°¾åŠ å…¥é˜¿é‡Œäº‘k8sé•œåƒæºé…ç½® echo \u0026#39;deb https://mirrors.aliyun.com/kubernetes/apt kubernetes-xenial main\u0026#39; \u0026gt;\u0026gt; /etc/apt/sources.list #æ›´æ–°è¯ä¹¦ curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | sudo apt-key add #æ›´æ–°æº apt update apt-get install -y kubectl äºŒè¿›åˆ¶å®‰è£… 1 2 3 curl -LO \u0026#34;https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl\u0026#34; chmod +x kubectl mv kubectl /usr/bin/ é…ç½®å‘½ä»¤è¡Œè‡ªåŠ¨è¡¥å…¨(å¯é€‰) 1 2 3 4 5 6 7 8 apt install bash-completion -y cat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; ~/.profile alias k=\u0026#39;kubectl\u0026#39; source \u0026lt;(kubectl completion bash) complete -F __start_kubectl k EOF source ~/.profile å®‰è£… Kind é¦–å…ˆè¿›åˆ° å®˜ç½‘, è·å–ä½ æ“ä½œç³»ç»Ÿçš„ kind ç‰ˆæœ¬\næœ¬æ•™ç¨‹æä¾› Linux ä¸‹çš„äºŒè¿›åˆ¶å®‰è£…\næ¥è‡ªå®˜ç½‘çš„æœ€æ–°å®‰è£…è„šæœ¬:\n1 2 3 4 5 6 # For AMD64 / x86_64 [ $(uname -m) = x86_64 ] \u0026amp;\u0026amp; curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64 # For ARM64 [ $(uname -m) = aarch64 ] \u0026amp;\u0026amp; curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-arm64 chmod +x ./kind sudo mv ./kind /usr/local/bin/kind ä½¿ç”¨ kind åˆ›å»ºé›†ç¾¤ æ­å»ºä¸€ä¸»ä¸‰ä»é›†ç¾¤ 1c3w 1 control plane and 3 worker\ncluster.yaml:\n1 2 3 4 5 6 7 8 9 10 11 12 kind: Cluster apiVersion: kind.x-k8s.io/v1alpha4 nodes: - role: control-plane extraPortMappings: - containerPort: 31000 # å°†ä¸»æœº 31000 ç«¯å£æ˜ å°„åˆ°å®¹å™¨çš„ 31000 ç«¯å£ hostPort: 31000 listenAddress: \u0026#34;0.0.0.0\u0026#34; # Optional, defaults to \u0026#34;0.0.0.0\u0026#34; protocol: tcp # Optional, defaults to tcp - role: worker - role: worker - role: worker **æ³¨æ„: ** å› ä¸º kind æ­å»ºçš„é›†ç¾¤ä¹Ÿæ˜¯å®¹å™¨, æˆ‘ä»¬è¦è®¿é—®å®¹å™¨çš„æœåŠ¡, æˆ‘ä»¬éœ€è¦æŠŠé›†ç¾¤çš„ Service æš´éœ²ä¸º NodePort ç±»å‹è¿›è¡Œè®¿é—®, (NodePort èŒƒå›´30000~32767)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 $ kind create cluster --config cluster.yaml --name 1c3w Creating cluster \u0026#34;1c3w\u0026#34; ... âœ“ Ensuring node image (kindest/node:v1.27.3) ğŸ–¼ âœ“ Preparing nodes ğŸ“¦ ğŸ“¦ ğŸ“¦ ğŸ“¦ âœ“ Writing configuration ğŸ“œ âœ“ Starting control-plane ğŸ•¹ï¸ âœ“ Installing CNI ğŸ”Œ âœ“ Installing StorageClass ğŸ’¾ âœ“ Joining worker nodes ğŸšœ Set kubectl context to \u0026#34;kind-1c3w\u0026#34; You can now use your cluster with: kubectl cluster-info --context kind-1c3w Thanks for using kind! ğŸ˜Š åˆ›å»º service 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 # æ›´æ¢ context $ kubectl cluster-info --context kind-1c3w # åˆ›å»ºä¸€ä¸ª nginx çš„ deploy æµ‹è¯•æœåŠ¡ $ k create deploy nginx --image=nginx # å†—ä½™éƒ¨ç½²å®ç°é«˜å¯ç”¨ $ k scale deployment nginx --replicas 3 # æš´éœ²æœåŠ¡ $ k expose deployment nginx --name nginx --port=80 --target-port=80 --type=NodePort # ä¿®æ”¹ NodePort ç«¯å£ä¸º 31000 è®©ä¸»æœºèƒ½å¤Ÿè®¿é—® $ k edit deployment nginx ...... ports: - nodePort: 31000 # ä¿®æ”¹ port: 80 protocol: TCP targetPort: 80 .... $ k get svc NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kubernetes ClusterIP 10.96.0.1 \u0026lt;none\u0026gt; 443/TCP 6m5s nginx NodePort 10.96.91.4 \u0026lt;none\u0026gt; 80:31000/TCP 3m7s éªŒè¯æœåŠ¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 $ curl localhost:31000 \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;Welcome to nginx!\u0026lt;/title\u0026gt; \u0026lt;style\u0026gt; html { color-scheme: light dark; } body { width: 35em; margin: 0 auto; font-family: Tahoma, Verdana, Arial, sans-serif; } \u0026lt;/style\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h1\u0026gt;Welcome to nginx!\u0026lt;/h1\u0026gt; \u0026lt;p\u0026gt;If you see this page, the nginx web server is successfully installed and working. Further configuration is required.\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;For online documentation and support please refer to \u0026lt;a href=\u0026#34;http://nginx.org/\u0026#34;\u0026gt;nginx.org\u0026lt;/a\u0026gt;.\u0026lt;br/\u0026gt; Commercial support is available at \u0026lt;a href=\u0026#34;http://nginx.com/\u0026#34;\u0026gt;nginx.com\u0026lt;/a\u0026gt;.\u0026lt;/p\u0026gt; \u0026lt;p\u0026gt;\u0026lt;em\u0026gt;Thank you for using nginx.\u0026lt;/em\u0026gt;\u0026lt;/p\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; ä¹Ÿå¯åœ¨æµè§ˆå™¨è¾“å…¥\u0026lt;è™šæ‹Ÿæœº ip\u0026gt;:31000\n","date":"2024-01-12T21:11:27+08:00","image":"https://blog-source-mkt.oss-cn-chengdu.aliyuncs.com/blog_source/public/kubernetes/blogimage-kubernetes.png","permalink":"/p/%E5%85%A8%E5%B9%B3%E5%8F%B0%E9%80%9A%E7%94%A8%E4%BD%BF%E7%94%A8-kind-%E5%BF%AB%E9%80%9F%E6%90%AD%E5%BB%BA-k8s-%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/","title":"å…¨å¹³å°é€šç”¨ä½¿ç”¨ kind å¿«é€Ÿæ­å»º k8s å¼€å‘ç¯å¢ƒ"},{"content":"å‰ç½®çŸ¥è¯† k8s ä¸­ configmap è¯¦ç»†ä½¿ç”¨ k8s é›†ç¾¤é…ç½® IP Host é…ç½® 11.0.1.150 master1 (keepalived+haproxy) 2C 4G 30G 11.0.1.151 master2 (keepalived+haproxy) 2C 4G 30G 11.0.1.152 node1 2C 4G 30G vip åœ°å€: https://11.0.1.100:16443\nç›®æ ‡ ä½¿ç”¨ Redis é…ç½®çš„å€¼åˆ›å»ºä¸€ä¸ª ConfigMap åˆ›å»ºä¸€ä¸ª Redis Podï¼ŒæŒ‚è½½å¹¶ä½¿ç”¨åˆ›å»ºçš„ ConfigMap éªŒè¯é…ç½®å·²ç»è¢«æ­£ç¡®åº”ç”¨ éªŒè¯ ConfigMap æŒ‚è½½æƒ…å†µ åˆ›å»º åˆ›å»º configmap redis-configmap.yaml:\n1 2 3 4 5 6 apiVersion: v1 kind: ConfigMap metadata: name: redis-configmap data: redis-config: \u0026#34;\u0026#34; åˆ›å»º\n1 $ kubectl create -f redis-configmap.yaml åˆ›å»º redis pod redis-pod.yaml:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 apiVersion: v1 kind: Pod metadata: name: redis spec: containers: - name: redis image: redis:5.0.4 command: - redis-server - \u0026#34;/redis-master/redis.conf\u0026#34; env: - name: MASTER # redis ä¼šè‡ªåŠ¨è¯»å–ç¯å¢ƒå˜é‡ value: \u0026#34;true\u0026#34; ports: - containerPort: 6379 # æš´éœ²å®¹å™¨ 6379 ç«¯å£, åè®® tcp, æœªæŒ‡å®šç«¯å£å resources: limits: # container çš„èµ„æºé™åˆ¶ cpu: \u0026#34;0.1\u0026#34; volumeMounts: - mountPath: /redis-master-data name: data - mountPath: /redis-master name: config volumes: - name: data # ç”¨äºå†™ redis ç¼“å­˜çš„ä¸´æ—¶ç›®å½•, éš pod ç”Ÿå‘½å‘¨æœŸåˆ›å»ºå’Œé”€æ¯ emptyDir: {} - name: config configMap: name: redis-configmap # configmap å items: - key: redis-config path: redis.conf # æŒ‚è½½è¿› pod åçš„æ–‡ä»¶å åˆ›å»º\n1 $ kubectl create -f redis-pod.yaml æ£€éªŒ redis é…ç½® è·å– redis é…ç½®ä¿¡æ¯ ä½¿ç”¨ kubectl exec è¿›å…¥ podï¼Œè¿è¡Œ redis-cli å·¥å…·æ£€æŸ¥å½“å‰é…ç½®ï¼š\n1 $ kubectl exec -it redis -- redis-cli æŸ¥çœ‹ maxmemoryï¼š\n1 127.0.0.1:6379\u0026gt; CONFIG GET maxmemory å®ƒåº”è¯¥æ˜¾ç¤ºé»˜è®¤å€¼ 0ï¼š\n1 2 1) \u0026#34;maxmemory\u0026#34; 2) \u0026#34;0\u0026#34; åŒæ ·ï¼ŒæŸ¥çœ‹ maxmemory-policyï¼š\n1 127.0.0.1:6379\u0026gt; CONFIG GET maxmemory-policy å®ƒä¹Ÿåº”è¯¥æ˜¾ç¤ºé»˜è®¤å€¼ noevictionï¼š\n1 2 1) \u0026#34;maxmemory-policy\u0026#34; 2) \u0026#34;noeviction\u0026#34; ä¿®æ”¹ configmap 1 $ kubectl edit cm redis-configmap redis-configmap\n1 2 3 4 5 6 7 8 apiVersion: v1 kind: ConfigMap metadata: name: redis-configmap data: redis-config: | maxmemory 2mb maxmemory-policy allkeys-lru å†æ¬¡æŸ¥çœ‹ redis é…ç½® ç¡®è®¤ ConfigMap å·²æ›´æ–°ï¼š\n1 kubectl describe configmap/redis-configmap ä½ åº”è¯¥å¯ä»¥çœ‹åˆ°æˆ‘ä»¬åˆšåˆšæ·»åŠ çš„é…ç½®ï¼š\n1 2 3 4 5 6 7 8 9 10 11 Name: redis-configmap Namespace: default Labels: \u0026lt;none\u0026gt; Annotations: \u0026lt;none\u0026gt; Data ==== redis-config: ---- maxmemory 2mb maxmemory-policy allkeys-lru é€šè¿‡ kubectl exec ä½¿ç”¨ redis-cli å†æ¬¡æ£€æŸ¥ Redis Podï¼ŒæŸ¥çœ‹æ˜¯å¦å·²åº”ç”¨é…ç½®ï¼š\n1 kubectl exec -it redis -- redis-cli æŸ¥çœ‹ maxmemoryï¼š\n1 127.0.0.1:6379\u0026gt; CONFIG GET maxmemory å®ƒä¿æŒé»˜è®¤å€¼ 0ï¼š\n1 2 1) \u0026#34;maxmemory\u0026#34; 2) \u0026#34;0\u0026#34; åŒæ ·ï¼Œmaxmemory-policy ä¿ç•™ä¸ºé»˜è®¤è®¾ç½® noevictionï¼š\n1 127.0.0.1:6379\u0026gt; CONFIG GET maxmemory-policy è¿”å›ï¼š\n1 2 1) \u0026#34;maxmemory-policy\u0026#34; 2) \u0026#34;noeviction\u0026#34; é…ç½®å€¼æœªæ›´æ”¹ï¼Œå› ä¸ºéœ€è¦é‡æ–°å¯åŠ¨ Pod æ‰èƒ½ä»å…³è”çš„ ConfigMap ä¸­è·å–æ›´æ–°çš„å€¼ã€‚ è®©æˆ‘ä»¬åˆ é™¤å¹¶é‡æ–°åˆ›å»º Podï¼š\n1 2 $ kubectl delete pod redis $ kubectl apply -f redis-pod.yaml ç°åœ¨ï¼Œæœ€åä¸€æ¬¡é‡æ–°æ£€æŸ¥é…ç½®å€¼ï¼š\n1 kubectl exec -it redis -- redis-cli æŸ¥çœ‹ maxmemoryï¼š\n1 127.0.0.1:6379\u0026gt; CONFIG GET maxmemory ç°åœ¨ï¼Œå®ƒåº”è¯¥è¿”å›æ›´æ–°åçš„å€¼ 2097152ï¼š\n1 2 1) \u0026#34;maxmemory\u0026#34; 2) \u0026#34;2097152\u0026#34; åŒæ ·ï¼Œmaxmemory-policy ä¹Ÿå·²æ›´æ–°ï¼š\n1 127.0.0.1:6379\u0026gt; CONFIG GET maxmemory-policy ç°åœ¨å®ƒåæ˜ äº†æœŸæœ›å€¼ allkeys-lruï¼š\n1 2 1) \u0026#34;maxmemory-policy\u0026#34; 2) \u0026#34;allkeys-lru\u0026#34; åˆ é™¤åˆ›å»ºçš„èµ„æºï¼Œæ¸…ç†ä½ çš„å·¥ä½œï¼š\n1 kubectl delete pod/redis configmap/example-redis-config å‚è€ƒ https://ai-feier.github.io/p/k8s-configmap-%E8%AF%A6%E8%A7%A3-%E4%BB%8E%E7%90%86%E8%A7%A3-k8s-volumes-%E6%8C%82%E8%BD%BD%E6%96%B9%E5%BC%8F-%E5%B8%A6%E4%BD%A0%E8%A7%A3%E5%86%B3%E6%8C%82%E8%BD%BD-configmap-%E7%9A%84%E7%A7%8D%E7%A7%8D%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87-%E4%BB%A5%E5%8F%8A-k8s-%E4%B8%AD%E5%A6%82%E4%BD%95%E5%88%9B%E5%BB%BA-configmap/ https://kubernetes.io/zh-cn/docs/tutorials/configuration/configure-redis-using-configmap/#real-world-example-configuring-redis-using-a-configmap ","date":"2024-01-09T18:15:53+08:00","image":"https://blog-source-mkt.oss-cn-chengdu.aliyuncs.com/blog_source/public/kubernetes/redis/1_cKRFZsFXbyrOyKNB5MLn9A.png","permalink":"/p/%E7%9C%9F%E5%AE%9E%E4%B8%96%E7%95%8C%E7%9A%84%E6%A1%88%E4%BE%8B%E4%BD%BF%E7%94%A8-configmap-%E6%9D%A5%E9%85%8D%E7%BD%AE-redis/","title":"çœŸå®ä¸–ç•Œçš„æ¡ˆä¾‹ï¼šä½¿ç”¨ ConfigMap æ¥é…ç½® Redis"},{"content":"Secretä»‹ç» k8s secretsç”¨äºå­˜å‚¨å’Œç®¡ç†ä¸€äº›æ•æ„Ÿæ•°æ®ï¼Œæ¯”å¦‚å¯†ç ï¼Œtokenï¼Œå¯†é’¥ç­‰æ•æ„Ÿä¿¡æ¯ã€‚å®ƒæŠŠ Pod æƒ³è¦è®¿é—®çš„åŠ å¯†æ•°æ®å­˜æ”¾åˆ° Etcd ä¸­ã€‚ç„¶åç”¨æˆ·å°±å¯ä»¥é€šè¿‡åœ¨ Pod çš„å®¹å™¨é‡ŒæŒ‚è½½ Volume çš„æ–¹å¼æˆ–è€…ç¯å¢ƒå˜é‡çš„æ–¹å¼è®¿é—®åˆ°è¿™äº› Secret é‡Œä¿å­˜çš„ä¿¡æ¯äº†ã€‚\nSecret ç±»ä¼¼äº ConfigMap ä½†ä¸“é—¨ç”¨äºä¿å­˜æœºå¯†æ•°æ®ã€‚\nSecret ç±»å‹ å†…ç½®ç±»å‹ ç”¨æ³• Opaque ç”¨æˆ·å®šä¹‰çš„ä»»æ„æ•°æ® kubernetes.io/service-account-tokensymotion æœåŠ¡è´¦å·ä»¤ç‰Œ kubernetes.io/dockercfg ~/.dockercfg æ–‡ä»¶çš„åºåˆ—åŒ–å½¢å¼ kubernetes.io/dockerconfigjson ~/.docker/config.json æ–‡ä»¶çš„åºåˆ—åŒ–å½¢å¼ kubernetes.io/basic-auth ç”¨äºåŸºæœ¬èº«ä»½è®¤è¯çš„å‡­æ® kubernetes.io/ssh-auth ç”¨äº SSH èº«ä»½è®¤è¯çš„å‡­æ® kubernetes.io/tls ç”¨äº TLS å®¢æˆ·ç«¯æˆ–è€…æœåŠ¡å™¨ç«¯çš„æ•°æ® bootstrap.kubernetes.io/token å¯åŠ¨å¼•å¯¼ä»¤ç‰Œæ•°æ® kubectl åˆ›å»ºç±»å‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 $ kubectl create secret dotfile -h Create a secret with specified type. A docker-registry type secret is for accessing a container registry. A generic type secret indicate an Opaque secret type. A tls type secret holds TLS certificate and its associated key. Available Commands: docker-registry Create a secret for use with a Docker registry generic Create a secret from a local file, directory, or literal value tls Create a TLS secret docker-registry: è¿æ¥ç§æœ‰é•œåƒä»“åº“çš„å‡­è¯ generic: å¸¸è§ secret, è¯¥ç±»å‹ secret ä¸ configmap ä½¿ç”¨ç›¸åŒ tls: æä¾› tls è¯ä¹¦, åœ¨ service mesh ä¸­è‡ªåŠ¨æŒ‚è½½ Secret ä½¿ç”¨ ä½¿ç”¨åœºæ™¯:\nè®¾ç½®å®¹å™¨çš„ç¯å¢ƒå˜é‡ã€‚ å‘ Pod æä¾› SSH å¯†é’¥æˆ–å¯†ç ç­‰å‡­æ®ã€‚ å…è®¸ kubelet ä»ç§æœ‰é•œåƒä»“åº“ä¸­æ‹‰å–é•œåƒã€‚ Opaque ç±»å‹ Secret çš„ä½¿ç”¨ åˆ›å»º 1. kubectl create 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 $ kubectl create secret generic dotfile --from-literal=username=admin --from-literal=password=123456 $ kubectl get secret dotfile -oyaml apiVersion: v1 data: password: MTIzNDU2 username: YWRtaW4= kind: Secret metadata: creationTimestamp: \u0026#34;2024-01-09T07:45:19Z\u0026#34; name: dotfile namespace: default resourceVersion: \u0026#34;621858\u0026#34; uid: ce3a3332-5b97-4af0-8312-ced355786e64 type: Opaque $ echo -n \u0026#34;YWRtaW4=\u0026#34; | base64 -d admin 2. yaml ä»¥ yaml æ–¹å¼åˆ›å»ºéœ€è¦ä½ æå‰è¿›è¡Œ base64\n1 2 3 4 $ echo -n \u0026#34;admin\u0026#34; | base64 YWRtaW4= $ echo -n \u0026#34;123456\u0026#34; | base64 MTIzNDU2 1 2 3 4 5 6 7 8 9 10 apiVersion: v1 kind: Secret metadata: name: dotfile namespace: default type: Opaque data: password: MTIzNDU2 username: YWRtaW4= immutable: true ä½ å¯ä»¥é€šè¿‡å°† Secret çš„ immutable å­—æ®µè®¾ç½®ä¸º true åˆ›å»ºä¸å¯æ›´æ”¹çš„ Secretã€‚\nåˆ›å»º\n1 $ kubectl create -f dotfile-secret.yaml æŒ‚è½½ 1. ä½œä¸ºç¯å¢ƒå˜é‡ åˆ›å»º pod\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 apiVersion: v1 kind: Pod metadata: name: pod1 spec: containers: - image: busybox name: busybox command: [\u0026#34;/bin/sh\u0026#34;,\u0026#34;-c\u0026#34;,\u0026#34;echo $username \u0026amp;\u0026amp; env\u0026#34;] env: - name: username valueFrom: secretKeyRef: key: username name: dotfile # secret åç§° è·å–å®¹å™¨æ—¥å¿—\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 # åˆ›å»º $ kubectl create -f pod1.yaml $ kubectl logs pod1 admin KUBERNETES_SERVICE_PORT=443 KUBERNETES_PORT=tcp://10.96.0.1:443 HOSTNAME=pod1 SHLVL=1 username=admin HOME=/root KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1 PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin KUBERNETES_PORT_443_TCP_PORT=443 KUBERNETES_PORT_443_TCP_PROTO=tcp KUBERNETES_SERVICE_PORT_HTTPS=443 KUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443 KUBERNETES_SERVICE_HOST=10.96.0.1 PWD=/ 2. ä½œä¸ºæ–‡ä»¶æŒ‚è½½åŠè®¾ç½® POSIX æƒé™ å¯¹äº volume æŒ‚è½½, æ¨è configmap æ€»ç»“ k8s ä¸­ volume æŒ‚è½½çš„ç§ç§æƒ…å†µ, åŠæœ€ä½³å®è·µ\nåˆ›å»º pod\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 apiVersion: v1 kind: Pod metadata: name: pod2 spec: volumes: - name: sec secret: secretName: dotfile defaultMode: 0400 # è®¾ç½®æ–‡ä»¶æƒé™ containers: - image: busybox name: busybox command: [\u0026#34;sleep\u0026#34;, \u0026#34;24h\u0026#34;] volumeMounts: - mountPath: /etc/config name: sec æ³¨æ„: secret æŒ‚è½½åˆ°å®¹å™¨åè‡ªåŠ¨ base64 è§£ç \n1 2 3 4 5 6 7 $ kubectl exec pod2 -- ls -l /etc/config/ total 0 lrwxrwxrwx 1 root root 15 Jan 9 08:00 password -\u0026gt; ..data/password lrwxrwxrwx 1 root root 15 Jan 9 08:00 username -\u0026gt; ..data/username $ kubectl exec pod2 -- cat /etc/config/username admin Secret ç»‘å®š serviceAccount k8s ä¸­ pod ä¼šæŒ‚è½½ serviceAccount\næŒ‚è½½è·¯å¾„: /var/run/secrets/kubernetes.io/serviceaccount æŒ‚è½½å†…å®¹è¯¥ serviceAccount çš„: ca.crt , namespace , token secret:\n1 2 3 4 5 6 7 8 9 10 apiVersion: v1 kind: Secret metadata: name: sa-secret annotations: kubernetes.io/service-account.name: \u0026#34;tdd\u0026#34; type: kubernetes.io/service-account-token data: password: MTIzNDU2 username: YWRtaW4= æˆ‘ä»¬ä¸º secret æ·»åŠ äº† kubernetes.io/service-account.nameå­—æ®µ, ä¸ºå…¶æŒ‡å®šçš„ serviceAccount, åˆ›å»ºäº† Secret ä¹‹åï¼Œç­‰å¾… Kubernetes åœ¨ data å­—æ®µä¸­å¡«å…… token ä¸»é”®ã€‚\næŸ¥çœ‹ secret 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 $ kubectl get secrets sa-secret -oyaml apiVersion: v1 data: ca.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURCVENDQWUyZ0F3SUJBZ0lJWVB2VXI2cG02NFF3RFFZSktvWklodmNOQVFFTEJRQXdGVEVUTUJFR0ExVUUKQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TXpFeU16QXdPVE16TVRkYUZ3MHpNekV5TWpjd09UTTRNVGRhTUJVeApFekFSQmdOVkJBTVRDbXQxWW1WeWJtVjBaWE13Z2dFaU1BMEdDU3FHU0liM0RRRUJBUVVBQTRJQkR3QXdnZ0VLCkFvSUJBUUM0M1JFazZPZ0VFMGVWN1JHbmc1YnRONEdHaE5uUFNjbUZuYy9LKzhlSEZESVlPRkRKblZlZ0tOUmQKblVOSEFUL2h3T3RaWFZUTHhieWRGTVNqd0xSeDVPNTg5bUlVM3M2SlVZZjFvajFCUjFsWlkreXA5eVRGdXFYYQphbzc3WTVPbkVpT3BOQXUxek1WWUFRK0V2bzJtbmY2b0p6WDd3SFc2TkxZd0V0TVA2cklhclNaaU11MTllRnBWCnpmNU5RMGFGUU4vbkJyQUpHQm15eHF1cGhNRFpYOXlyK1c3emY4Q296NkxuTHRCMCtIaEtHYm9kUGVyaWk0bjgKczJlc2tLdmZ6NmdJK0dhR3ROYWtNU3gwbVZXV0MycTBDbndrOVJEOTNhd1JWRHd2VnZRczljR1B0R0I3WVdIcApDOXBLeTdaOEgybjdDZndza2FqZTMzWnhuUzJaQWdNQkFBR2pXVEJYTUE0R0ExVWREd0VCL3dRRUF3SUNwREFQCkJnTlZIUk1CQWY4RUJUQURBUUgvTUIwR0ExVWREZ1FXQkJRU1oxaVlWKzlQNTRiNHB3UU9QVkI0TklXYndEQVYKQmdOVkhSRUVEakFNZ2dwcmRXSmxjbTVsZEdWek1BMEdDU3FHU0liM0RRRUJDd1VBQTRJQkFRQkdNRzMvN3dSZwp0ZkxDMkNHTGtRcUdaQmNtTlBzR0lwbmRqSnpTSzVjMXJMSVUrNjNHN3ZnWEJENHVuZ3B5RDFRVE5VSWp1ZVRXCkMxM1lZb1ZjK09zZkIvWFlVRkFvZ1JiWWtvZjV2TTBUeFVzdXN1VVUvT0Q2NDc0cE5xajlzQStrejRiMUliMzAKOVFmUG5mM2ZieVZyVmh0dlYxQmxsNVMwMmVDa2xaazM1SjAzczFLdytOWHovSjQzTDF6UlJjNytCa3M1UVpvbAp2ZnhJYW1BaXdqWGFUMDBhVVB3WjZ4S215KzcvUkZuRjB4aExlanhKRTBrOUU0YWR3NGhWSkNWMUp2aWdzcEpDCmNQL3BJMC9hSlVKeHVKNWZVeENuRVRVOXRpNi9aTGloeDg4Uk1vdmRFS0R4RDZJYlpKSWkxYVJwajhVeGdnL0UKcm1ONU5YTnN3Sk9XCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K namespace: ZGVmYXVsdA== password: MTIzNDU2 token: ZXlKaGJHY2lPaUpTVXpJMU5pSXNJbXRwWkNJNkluZHBiR05VZVVwd1pUbEpRbEJpV0ZReGFFeHFaamh5WlROWE4wOHdXRXBtU1Y4eGJtODRWblp0UlVFaWZRLmV5SnBjM01pT2lKcmRXSmxjbTVsZEdWekwzTmxjblpwWTJWaFkyTnZkVzUwSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXVZVzFsYzNCaFkyVWlPaUprWldaaGRXeDBJaXdpYTNWaVpYSnVaWFJsY3k1cGJ5OXpaWEoyYVdObFlXTmpiM1Z1ZEM5elpXTnlaWFF1Ym1GdFpTSTZJbk5oTFhObFkzSmxkQ0lzSW10MVltVnlibVYwWlhNdWFXOHZjMlZ5ZG1salpXRmpZMjkxYm5RdmMyVnlkbWxqWlMxaFkyTnZkVzUwTG01aGJXVWlPaUowWkdRaUxDSnJkV0psY201bGRHVnpMbWx2TDNObGNuWnBZMlZoWTJOdmRXNTBMM05sY25acFkyVXRZV05qYjNWdWRDNTFhV1FpT2lKbVpEWTRZelkwTVMwMU1qSXpMVFJsTUdRdFlqRXlaQzFpWkdKbE5ETXlOMlpsT0dZaUxDSnpkV0lpT2lKemVYTjBaVzA2YzJWeWRtbGpaV0ZqWTI5MWJuUTZaR1ZtWVhWc2REcDBaR1FpZlEuY09UZXoyM2w3VFl2TjFFN1FYcW4xVkN4dUxhbEJCN0JOMTVyU05IWFZndk5waEY4ZTd3ZkY4R3VheXFaSmZtdXB3ZE5HVzV2SFVRbE8yQVQtX3pGZkEta0hSbEN6OVZzZUVnTV82S0lrZ3FiZlNKNGw2WDRQOWFwaEdvYUhBaEdJUGdibTVGU1UwTWR6NlhzNW9fSnVvVjZfWkxxN3BZRVlGU0Y3REF1U0VyZHljSjdBZFFidWl6cHhuOE5lb3JhZ3Y5OWNDWjFlQjVJS0lGQW05SjBld1dlZEJBOUJhM0haN2RXQWozNE9uLW9mTWVKOWtQcmhvZWlUb2dtSkk5SE9NYWd4Ynh4YmF5cVpYdW9TQWJBSkNqVkRoUVZxdUJZRnJ5T09lWFowSnlXaWkyeVdVQWVvdVNDSEtRWUFXd2pmU2dwaGtKdzFQUkE4M3pFQWFmc3hn username: YWRtaW4= kind: Secret metadata: annotations: kubernetes.io/service-account.name: tdd kubernetes.io/service-account.uid: fd68c641-5223-4e0d-b12d-bdbe4327fe8f creationTimestamp: \u0026#34;2024-01-09T08:49:30Z\u0026#34; name: sa-secret namespace: default resourceVersion: \u0026#34;630499\u0026#34; uid: c41bc253-c2c4-4d2f-a5d9-0a4fe8b0d8da type: kubernetes.io/service-account-token å¯ä»¥çœ‹åˆ° kubernetes æ§åˆ¶å™¨è‡ªåŠ¨ä¸ºå…¶å¡«å……äº† namespace, token, ca\nTLS Secret åˆ›å»ºæ–¹å¼\nyaml æ–¹å¼åˆ›å»º 1 2 3 4 5 6 7 8 9 10 11 12 13 14 apiVersion: v1 kind: Secret metadata: name: secret-tls type: kubernetes.io/tls data: # å€¼ä¸º base64 ç¼–ç ï¼Œè¿™æ ·ä¼šæ©ç›–å®ƒä»¬ï¼Œä½†ä¸ä¼šæä¾›ä»»ä½•æœ‰ç”¨çš„æœºå¯†æ€§çº§åˆ« tls.crt: | LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUNVakNDQWJzQ0FnMytNQTBHQ1NxR1NJYjNE UUVCQlFVQU1JR2JNUXN3Q1FZRFZRUUdFd0pLVURFT01Bd0cKQTFVRUNCTUZWRzlyZVc4eEVEQU9C ...... # åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå¯†é’¥æ•°æ®ä¸æ˜¯çœŸæ­£çš„ PEM ç¼–ç çš„ç§é’¥ tls.key: | RXhhbXBsZSBkYXRhIGZvciB0aGUgVExTIGNydCBmaWVsZA== kubectl åˆ›å»º 1 2 3 $ kubectl create secret tls my-tls-secret \\ --cert=path/to/cert/file \\ --key=path/to/key/file Docker é•œåƒä»“åº“ Secret yaml æ–¹å¼åˆ›å»º 1 2 3 4 5 6 7 8 apiVersion: v1 kind: Secret metadata: name: secret-dockercfg type: kubernetes.io/dockercfg data: .dockercfg: | eyJhdXRocyI6eyJodHRwczovL2V4YW1wbGUvdjEvIjp7ImF1dGgiOiJvcGVuc2VzYW1lIn19fQo= kubectl æ–¹å¼åˆ›å»º 1 2 3 4 5 6 7 $ kubectl create secret docker-registry secret-tiger-docker \\ --docker-email=tiger@acme.example \\ --docker-username=tiger \\ --docker-password=pass1234 \\ --docker-server=my-registry.example:5000 $ kubectl get secret secret-tiger-docker -o jsonpath=\u0026#39;{.data.*}\u0026#39; | base64 -d è¾“å‡ºç­‰ä»·äºä»¥ä¸‹ JSON æ–‡æ¡£ï¼ˆè¿™ä¹Ÿæ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ Docker é…ç½®æ–‡ä»¶ï¼‰ï¼š\n1 2 3 4 5 6 7 8 9 10 { \u0026#34;auths\u0026#34;: { \u0026#34;my-registry.example:5000\u0026#34;: { \u0026#34;username\u0026#34;: \u0026#34;tiger\u0026#34;, \u0026#34;password\u0026#34;: \u0026#34;pass1234\u0026#34;, \u0026#34;email\u0026#34;: \u0026#34;tiger@acme.example\u0026#34;, \u0026#34;auth\u0026#34;: \u0026#34;dGlnZXI6cGFzczEyMzQ=\u0026#34; } } } ssh ç±»å‹ secret é€šè¿‡æ–‡ä»¶åˆ›å»º 1 $ kubectl create secret generic ssh-key-secret --from-file=ssh-privatekey=/path/to/.ssh/id_rsa --from-file=ssh-publickey=/path/to/.ssh/id_rsa.pub pod æŒ‚è½½ ssh secret 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 apiVersion: v1 kind: Pod metadata: name: secret-test-pod labels: name: secret-test spec: volumes: - name: secret-volume secret: secretName: ssh-key-secret containers: - name: ssh-test-container image: mySshImage volumeMounts: - name: secret-volume readOnly: true mountPath: \u0026#34;/etc/secret-volume\u0026#34; å®¹å™¨å‘½ä»¤æ‰§è¡Œæ—¶ï¼Œç§˜é’¥çš„æ•°æ®å¯ä»¥åœ¨ä¸‹é¢çš„ä½ç½®è®¿é—®åˆ°ï¼š\n1 2 /etc/secret-volume/ssh-publickey /etc/secret-volume/ssh-privatekey å®¹å™¨å°±å¯ä»¥éšä¾¿ä½¿ç”¨ Secret æ•°æ®æ¥å»ºç«‹ SSH è¿æ¥ã€‚\nå‚è€ƒ https://kubernetes.io/zh-cn/docs/concepts/configuration/secret/#service-account-token-secrets https://kubernetes.io/zh-cn/docs/tasks/inject-data-application/distribute-credentials-secure/#provide-prod-test-creds https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/pull-image-private-registry/ ","date":"2024-01-09T17:10:08+08:00","image":"https://blog-source-mkt.oss-cn-chengdu.aliyuncs.com/blog_source/public/kubernetes/d7e980452cf8c7f8195c3de1f6a36cb7.svg","permalink":"/p/k8s-secret-%E4%B8%80%E6%96%87%E8%AF%A6%E8%A7%A3-%E5%85%A8%E9%9D%A2%E8%A6%86%E7%9B%96-secret-%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF-%E5%85%A8%E5%AE%B6%E6%A1%B6/","title":"K8S Secret ä¸€æ–‡è¯¦è§£, å…¨é¢è¦†ç›– Secret ä½¿ç”¨åœºæ™¯, å…¨å®¶æ¡¶"},{"content":"å¼•è¨€ ConfigMap é¡¾åæ€ä¹‰ï¼Œæ˜¯ç”¨äºä¿å­˜é…ç½®æ•°æ®çš„é”®å€¼å¯¹ï¼Œå¯ä»¥ç”¨æ¥ä¿å­˜å•ä¸ªå±æ€§ï¼Œä¹Ÿå¯ä»¥ä¿å­˜é…ç½®æ–‡ä»¶ã€‚Secret å¯ä»¥ä¸º Pod æä¾›å¯†ç ã€Tokenã€ç§é’¥ç­‰æ•æ„Ÿæ•°æ®ï¼›å¯¹äºä¸€äº›éæ•æ„Ÿæ•°æ®ï¼Œæ¯”å¦‚åº”ç”¨çš„é…ç½®ä¿¡æ¯ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ ConfigMapã€‚\nConfigMap çš„åˆ›å»ºå’Œä½¿ç”¨æ–¹å¼ä¸ Secret éå¸¸ç±»ä¼¼ï¼Œä¸»è¦çš„ä¸åŒæ˜¯ä»¥æ˜æ–‡çš„å½¢å¼å­˜æ”¾\nåˆ›å»ºæ–¹å¼: åºå· åˆ›å»ºæ–¹å¼ å‚æ•° 1 å‘½ä»¤è¡Œ key-value æ ¼å¼åˆ›å»º (å­—é¢é‡æ–¹å¼åˆ›å»º) \u0026ndash;from-literal 2 æ ¹æ®æ–‡ä»¶åˆ›å»º (env æ–¹å¼åˆ›å»º) \u0026ndash;from-env-file 3 ä»ç›®å½•åˆ›å»º \u0026ndash;from-file 4 æ ¹æ® yaml åˆ›å»º kubectl create -f 1. å‘½ä»¤è¡Œ key-value æ ¼å¼åˆ›å»º (å­—é¢é‡æ–¹å¼åˆ›å»º) 1 2 3 $ kubectl create configmap literal-configmap --from-literal=key1=value1 --from-literal=key2=value2 --from-literal=key3=value3 $ kubectl get configmap literal-configmap -oyaml 1 2 3 4 5 6 7 8 9 10 11 12 apiVersion: v1 data: key1: value1 key2: value2 key3: value3 kind: ConfigMap metadata: creationTimestamp: \u0026#34;2024-01-09T04:25:43Z\u0026#34; name: literal-configmap namespace: default resourceVersion: \u0026#34;594871\u0026#34; uid: b7f8824c-01dd-4438-994d-fc8c9d50649c 2. æ ¹æ®æ–‡ä»¶åˆ›å»º (env æ–¹å¼åˆ›å»º) æ–‡ä»¶æ ¼å¼ä¸º: key=value, ä¸ .iniæ ¼å¼ä¸€è‡´\n1 2 3 4 5 6 7 $ cat testenv envkey1=envvalue1 envkey2=envvalue2 $ kubectl create configmap envfile-configmap --from-env-file testenv $ kubectl get configmaps envfile-configmap -oyaml 1 2 3 4 5 6 7 8 9 10 11 apiVersion: v1 data: envkey1: envvalue1 envkey2: envvalue2 kind: ConfigMap metadata: creationTimestamp: \u0026#34;2024-01-09T04:31:45Z\u0026#34; name: envfile-configmap namespace: default resourceVersion: \u0026#34;595672\u0026#34; uid: 8841549f-73da-4040-8c76-39517d1bd2d7 3. ä»ç›®å½•åˆ›å»º ä»ç›®å½•åˆ›å»º configmap åªä¼šè¯»å–æ–‡ä»¶å¤¹ç¬¬ä¸€çº§å†…å®¹, ä¸ä¼šé€’å½’æœç´¢\n1 2 3 4 5 6 7 8 9 10 11 # åˆ›å»ºä¸¤ä¸ª pod yaml $ mkdir pods $ kubectl run nginxpod --image=nginx --dry-run=client -oyaml \u0026gt; pods/nginxpod.yaml $ kubectl run envoypod --image=envoy --dry-run=client -oyaml \u0026gt; pods/envoypod.yaml # æŠŠ pods æ•´ä¸ªç›®å½•ä¸‹å†…å®¹ä½œä¸º configmap çš„ data # key: æ–‡ä»¶å # value: æ–‡ä»¶å†…å®¹ $ kubectl create configmap testfile --from-file pods/ $ kubectl get configmaps testfile -oyaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 apiVersion: v1 data: envoypod.yaml: | apiVersion: v1 kind: Pod metadata: creationTimestamp: null labels: run: envoypod name: envoypod spec: containers: - image: envoy name: envoypod resources: {} dnsPolicy: ClusterFirst restartPolicy: Always status: {} nginxpod.yaml: | apiVersion: v1 kind: Pod metadata: creationTimestamp: null labels: run: nginxpod name: nginxpod spec: containers: - image: nginx name: nginxpod resources: {} dnsPolicy: ClusterFirst restartPolicy: Always status: {} kind: ConfigMap metadata: creationTimestamp: \u0026#34;2024-01-09T05:14:01Z\u0026#34; name: testfile namespace: default resourceVersion: \u0026#34;601262\u0026#34; uid: 89254512-f822-4414-927f-1bdb4fd1dcef 4. æ ¹æ® yaml åˆ›å»º åˆ›å»º configmap yaml:\n1 2 3 4 5 6 7 8 apiVersion: v1 data: yamlkey1: yamlvalue1 yamlkey1: yamlvalue1 kind: ConfigMap metadata: name: yaml-configmap namespace: default 1 $ kubectl create -f yaml-configmap.yaml configmap çš„ä½¿ç”¨ ä½œä¸ºç¯å¢ƒå˜é‡æ³¨å…¥ ä»¥ volume æ–¹å¼æŒ‚è½½ æ³¨æ„ï¼ï¼\nConfigMapå¿…é¡»åœ¨Podä½¿ç”¨å®ƒä¹‹å‰åˆ›å»º ä½¿ç”¨envFromæ—¶ï¼Œå°†ä¼šè‡ªåŠ¨å¿½ç•¥æ— æ•ˆçš„é”® Podåªèƒ½ä½¿ç”¨åŒä¸€ä¸ªå‘½åç©ºé—´çš„ConfigMap 1. ä½œä¸ºç¯å¢ƒå˜é‡æ³¨å…¥ åˆ›å»º pod:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 apiVersion: v1 kind: Pod metadata: name: pod1 spec: containers: - image: busybox name: busybox command: [\u0026#34;/bin/sh\u0026#34;,\u0026#34;-c\u0026#34;,\u0026#34;echo $KEY1 \u0026amp;\u0026amp; env\u0026#34;] env: - name: KEY1 valueFrom: configMapKeyRef: key: key1 name: literal-configmap # configmap åç§° optional: true # å°†ç¯å¢ƒå˜é‡æ ‡è®°ä¸ºå¯é€‰ - name: KEY2 valueFrom: configMapKeyRef: key: key2 name: literal-configmap restartPolicy: Never æŸ¥çœ‹ pod1\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 $ kubectl get po NAME READY STATUS RESTARTS AGE pod1 0/1 Completed 0 7s ...... # æŸ¥çœ‹ pod1 çš„æ ‡å‡†è¾“å‡º $ kubectl logs pod1 value1 KEY1=value1 KEY2=value2 KUBERNETES_SERVICE_PORT=443 KUBERNETES_PORT=tcp://10.96.0.1:443 HOSTNAME=pod1 SHLVL=1 HOME=/root KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1 PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin KUBERNETES_PORT_443_TCP_PORT=443 KUBERNETES_PORT_443_TCP_PROTO=tcp KUBERNETES_SERVICE_PORT_HTTPS=443 KUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443 KUBERNETES_SERVICE_HOST=10.96.0.1 PWD=/ 2. ä»¥ volume æ–¹å¼æŒ‚è½½ ä¸€ä¸ª key å¯¹åº”ä¸€ä¸ªæ–‡ä»¶\næŒ‚è½½å®Œæ•´çš„ configmap **æ³¨æ„: **ç›´æ¥æŒ‚è½½ configmap ä¼šè¦†ç›– mountPath æ–‡ä»¶å¤¹, éœ€è¦ç¡®ä¿ mountPath ä¸ºç©ºç›®å½•, å¦åˆ™ pod æ— æ³•åˆ›å»º\næŸ¥çœ‹ configmap å€¼\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 # è¾“å‡º go map ç±»å‹ # kubectl get cm testfile -o go-template=\u0026#39;{{.data}}\u0026#39; Name: testfile Namespace: default Labels: \u0026lt;none\u0026gt; Annotations: \u0026lt;none\u0026gt; Data ==== envoypod.yaml: ---- apiVersion: v1 kind: Pod metadata: creationTimestamp: null labels: run: envoypod name: envoypod spec: containers: - image: envoy name: envoypod resources: {} dnsPolicy: ClusterFirst restartPolicy: Always status: {} nginxpod.yaml: ---- apiVersion: v1 kind: Pod metadata: creationTimestamp: null labels: run: nginxpod name: nginxpod spec: containers: - image: nginx name: nginxpod resources: {} dnsPolicy: ClusterFirst restartPolicy: Always status: {} BinaryData ==== Events: \u0026lt;none\u0026gt; ä¸¤ä¸ª key åˆ›å»º pod\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 apiVersion: v1 kind: Pod metadata: name: pod2 spec: volumes: - name: cm configMap: name: testfile containers: - image: busybox name: busybox command: [\u0026#34;sleep\u0026#34;, \u0026#34;24h\u0026#34;] volumeMounts: - mountPath: /etc/config name: cm 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 $ kubectl create -f pod2.yaml $ kubectl exec pod2 -- ls /etc/config envoypod.yaml nginxpod.yaml $ kubectl exec pod2 -- cat /etc/config/nginxpod.yaml apiVersion: v1 kind: Pod metadata: creationTimestamp: null labels: run: nginxpod name: nginxpod spec: containers: - image: nginx name: nginxpod resources: {} dnsPolicy: ClusterFirst restartPolicy: Always status: {} æŒ‚è½½ configmap ä¸­ç‰¹å®š key **æ³¨æ„: ** configmap æŒ‚è½½éƒ½æ˜¯è¦†ç›–è¡Œä¸º\nå¯¹äºå¤šä¸ª key: ç¡®ä¿æŒ‚è½½ mountPath ä¸ºç©ºç›®å½• å¯¹äºå•ä¸€ key: ç¡®ä¿ mountPath ä¸ºç©ºæ–‡ä»¶ åˆ›å»º pod\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 apiVersion: v1 kind: Pod metadata: name: pod3 spec: volumes: - name: cm configMap: name: testfile items: - key: nginxpod.yaml path: keys/nginx.yaml # è¯¥å­—æ®µæŒ‡å®šç›¸å¯¹è·¯å¾„åœ°å€ - key: envoypod.yaml path: envoy.yaml containers: - image: busybox name: busybox command: [\u0026#34;sleep\u0026#34;, \u0026#34;24h\u0026#34;] volumeMounts: - mountPath: /etc/yaml name: cm 1 2 3 4 5 $ kubectl exec pod3 -- ls -l /etc/yaml/ lrwxrwxrwx 1 root root 17 Jan 9 06:34 envoy.yaml -\u0026gt; ..data/envoy.yaml lrwxrwxrwx 1 root root 11 Jan 9 06:34 keys -\u0026gt; ..data/keys $ kubectl exec pod3 -- ls -l /etc/yaml/keys/ -rw-r--r-- 1 root root 241 Jan 9 06:34 nginx.yaml ç»ƒä¹  çœŸå®ä¸–ç•Œçš„æ¡ˆä¾‹ï¼šä½¿ç”¨ ConfigMap æ¥é…ç½® Redis å‚è€ƒ: https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-pod-configmap/#add-configmap-data-to-a-volume https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-pod-configmap/#use-configmap-defined-environment-variables-in-pod-commands k8s \u0026ndash; ConfigMap - ç®€ä¹¦ (jianshu.com) k8sä¹‹ConfigMapè¯¦ç»†ç†è§£åŠä½¿ç”¨-CSDNåšå®¢ ","date":"2024-01-09T14:42:57+08:00","image":"https://blog-source-mkt.oss-cn-chengdu.aliyuncs.com/blog_source/public/kubernetes/1_07R1--jVP2LB7WiraZ3ldw.png","permalink":"/p/k8s-configmap-%E8%AF%A6%E8%A7%A3-%E4%BB%8E%E7%90%86%E8%A7%A3-k8s-volumes-%E6%8C%82%E8%BD%BD%E6%96%B9%E5%BC%8F-%E5%B8%A6%E4%BD%A0%E8%A7%A3%E5%86%B3%E6%8C%82%E8%BD%BD-configmap-%E7%9A%84%E7%A7%8D%E7%A7%8D%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87-%E4%BB%A5%E5%8F%8A-k8s-%E4%B8%AD%E5%A6%82%E4%BD%95%E5%88%9B%E5%BB%BA-configmap/","title":"k8s configmap è¯¦è§£, ä»ç†è§£ k8s volumes æŒ‚è½½æ–¹å¼, å¸¦ä½ è§£å†³æŒ‚è½½ configmap çš„ç§ç§ç–‘éš¾æ‚ç—‡, ä»¥åŠ k8s ä¸­å¦‚ä½•åˆ›å»º configmap"},{"content":"k8s é›†ç¾¤é…ç½® IP Host é…ç½® 11.0.1.150 master1 (keepalived+haproxy) 2C 4G 30G 11.0.1.151 master2 (keepalived+haproxy) 2C 4G 30G 11.0.1.152 node1 2C 4G 30G vip åœ°å€: https://11.0.1.100:16443\nä»‹ç» Webhookå°±æ˜¯ä¸€ç§HTTPå›è°ƒï¼Œç”¨äºåœ¨æŸç§æƒ…å†µä¸‹æ‰§è¡ŒæŸäº›åŠ¨ä½œï¼ŒWebhookä¸æ˜¯K8Sç‹¬æœ‰çš„ï¼Œå¾ˆå¤šåœºæ™¯ä¸‹éƒ½å¯ä»¥è¿›è¡ŒWebhookï¼Œæ¯”å¦‚åœ¨æäº¤å®Œä»£ç åè°ƒç”¨ä¸€ä¸ªWebhookè‡ªåŠ¨æ„å»ºdockeré•œåƒ\nK8Sä¸­æä¾›äº†è‡ªå®šä¹‰èµ„æºç±»å‹å’Œè‡ªå®šä¹‰æ§åˆ¶å™¨æ¥æ‰©å±•åŠŸèƒ½ï¼Œè¿˜æä¾›äº†åŠ¨æ€å‡†å…¥æ§åˆ¶ï¼Œå…¶å®å°±æ˜¯é€šè¿‡Webhookæ¥å®ç°å‡†å…¥æ§åˆ¶ï¼Œåˆ†ä¸ºä¸¤ç§ï¼šéªŒè¯æ€§è´¨çš„å‡†å…¥ Webhook ï¼ˆValidating Admission Webhookï¼‰ å’Œ ä¿®æ”¹æ€§è´¨çš„å‡†å…¥ Webhook ï¼ˆMutating Admission Webhookï¼‰\nAdmission Webhookæœ‰å“ªäº›ä½¿ç”¨åœºæ™¯ï¼Ÿå¦‚ä¸‹\nåœ¨èµ„æºæŒä¹…åŒ–åˆ°ETCDä¹‹å‰è¿›è¡Œä¿®æ”¹ï¼ˆMutating Webhookï¼‰ï¼Œæ¯”å¦‚å¢åŠ init Containeræˆ–è€…sidecar Container åœ¨èµ„æºæŒä¹…åŒ–åˆ°ETCDä¹‹å‰è¿›è¡Œæ ¡éªŒï¼ˆValidating Webhookï¼‰ï¼Œä¸æ»¡è¶³æ¡ä»¶çš„èµ„æºç›´æ¥æ‹’ç»å¹¶ç»™å‡ºç›¸åº”ä¿¡æ¯ ç°åœ¨éå¸¸ç«çƒ­çš„çš„ Service Mesh åº”ç”¨istioå°±æ˜¯é€šè¿‡ mutating webhooks æ¥è‡ªåŠ¨å°†Envoyè¿™ä¸ª sidecar å®¹å™¨æ³¨å…¥åˆ° Pod ä¸­å»çš„ï¼š\nhttps://istio.io/docs/setup/kubernetes/sidecar-injection/ã€‚\næ›´å¤šè¯¦æƒ…ä»‹ç»å¯å‚è€ƒï¼š\nhttps://kubernetes.io/zh/docs/reference/access-authn-authz/extensible-admission-controllers/\nAdmission Webhook ä¸Šé¢æåˆ°K8Sçš„åŠ¨æ€å‡†å…¥æ§åˆ¶æ˜¯é€šè¿‡Webhookæ¥å®ç°çš„ï¼Œé‚£ä¹ˆå®ƒåˆ°åº•æ˜¯åœ¨å“ªä¸ªç¯èŠ‚æ‰§è¡Œçš„ï¼Ÿè¯·çœ‹ä¸‹å›¾\nç»¼ä¸Š, k8s webhook å¯åˆ†ä¸ºä¸¤ç±»:\nMutating Webhook: è¿™ç±» webhook å¯ä»¥æ›´æ”¹è¯·æ±‚å¯¹è±¡ Validating Webhook: è¿™ç±» webhook ä¸èƒ½å»æ›´æ”¹è¯·æ±‚å¯¹è±¡, å°±ç®—æ›´æ”¹ä¹Ÿä¼šè¢«å¿½ç•¥, ç”¨äºå†™å…¥ etcd å‰çš„éªŒè¯é€»è¾‘ WebHook å…¥é—¨å®è·µ: github è®¤è¯æ¥å…¥ æºç åœ°å€: https://github.com/Ai-feier/k8s-webhook/tree/main/auth-github\nå†™ä¸€ä¸ªç”¨äºè®¤è¯æ ¡éªŒçš„ mutating webhook\nè¯·æ±‚æµç¨‹:\næ‹¦æˆª apiserver è¯·æ±‚ å°†è¯·æ±‚(TokenReview)ä¸­çš„ token å‘é€ç»™ github ç”¨äºéªŒè¯ å°† github è¿”å›çš„ç”¨æˆ·ä¿¡æ¯å¡«å…¥ TokenReview web æœåŠ¡å™¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 package main import ( \u0026#34;context\u0026#34; \u0026#34;encoding/json\u0026#34; \u0026#34;github.com/google/go-github/github\u0026#34; \u0026#34;golang.org/x/oauth2\u0026#34; authentication \u0026#34;k8s.io/api/authentication/v1beta1\u0026#34; \u0026#34;log\u0026#34; \u0026#34;net/http\u0026#34; ) func main() { http.HandleFunc(\u0026#34;/authenticate\u0026#34;, func(writer http.ResponseWriter, request *http.Request) { // è·å–è¯·æ±‚ä¸­çš„ TokonReview decoder := json.NewDecoder(request.Body) var tokenReview authentication.TokenReview if err := decoder.Decode(\u0026amp;tokenReview); err != nil { log.Println(\u0026#34;decode error: \u0026#34;, err) // å“åº”è¿”å›é”™è¯¯ writer.WriteHeader(http.StatusBadRequest) _ = json.NewEncoder(writer).Encode(map[string]interface{}{ \u0026#34;apiVersion\u0026#34;: \u0026#34;authentication.k8s.io/v1beta1\u0026#34;, \u0026#34;kind\u0026#34;: \u0026#34;TokenReview\u0026#34;, \u0026#34;status\u0026#34;: authentication.TokenReviewStatus{ Authenticated: false, }, }) return } log.Println(\u0026#34;receive request\u0026#34;) // æ£€æŸ¥ç”¨æˆ· // åˆ›å»º oauth2 å¯¹è±¡, å‘é€ç»™ github oauthToken := oauth2.StaticTokenSource(\u0026amp;oauth2.Token{ AccessToken: tokenReview.Spec.Token, // tokenReview çš„ token }) oauthClient := oauth2.NewClient(context.Background(), oauthToken) client := github.NewClient(oauthClient) user, _, err := client.Users.Get(context.Background(), \u0026#34;\u0026#34;) if err != nil { log.Println(\u0026#34;github auth error: \u0026#34;, err) writer.WriteHeader(http.StatusUnauthorized) _ = json.NewEncoder(writer).Encode(map[string]any{ \u0026#34;apiVersion\u0026#34;: \u0026#34;authentication.k8s.io/v1beta1\u0026#34;, \u0026#34;kind\u0026#34;: \u0026#34;TokenReview\u0026#34;, \u0026#34;status\u0026#34;: authentication.TokenReviewStatus{ Authenticated: false, // è¿”å›è®¤è¯å¤±è´¥ }, }) return } // è®¤è¯æˆåŠŸ log.Println(\u0026#34;github login success, as: \u0026#34;, *user.Login) status := authentication.TokenReviewStatus{ Authenticated: true, User: authentication.UserInfo{ Username: *user.Login, UID: *user.Login, }, } json.NewEncoder(writer).Encode(map[string]any{ \u0026#34;apiVersion\u0026#34;: \u0026#34;authentication.k8s.io/v1beta1\u0026#34;, \u0026#34;kind\u0026#34;: \u0026#34;TokenReview\u0026#34;, \u0026#34;status\u0026#34;: status, }) }) log.Println(http.ListenAndServe(\u0026#34;:3000\u0026#34;, nil)) } Dockerfile é•œåƒåˆ¶ä½œ æœ¬é¡¹ç›®æ˜¯ä½¿ç”¨ go ä½œä¸º web æœåŠ¡å™¨, go æä¾›ä¸€ç§éå¸¸å¥½ç”¨çš„ç¼–è¯‘ç‰¹æ€§ \u0026ndash; äº¤å‰ç¼–è¯‘\nåœ¨ dockerfile ä¸­æˆ‘ä»¬é€‰æ‹©çš„ busybox ä½œä¸ºåŸºç¡€é•œåƒ, ä½†é»˜è®¤ busybox æ¶æ„ä¸º x86_64(uname -mæŸ¥çœ‹), æ‰€ä»¥å¯ä»¥ä½¿ç”¨ amd64/busybox æˆ–äº¤å‰ç¼–è¯‘ go ä»£ç \nå½“å‡ºç°è¿™ç±»é—®é¢˜ exec /usr/bin/sh: exec format error å¤šåŠæ˜¯æ¶æ„é—®é¢˜\næ¨è: Golangäº¤å‰ç¼–è¯‘è¯¦è§£ \u0026ndash; CSDN\namd64 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 FROM golang:1.20 as builder WORKDIR /app COPY .. . # go äº¤å‰ç¼–è¯‘: amd64 RUN go env -w GOPROXY=https://goproxy.cn,direct \u0026amp;\u0026amp; go mod tidy \u0026amp;\u0026amp; \\ CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o main main.go RUN chmod +x /app/main FROM amd64/busybox COPY --from=builder /app/main . EXPOSE 3000/tcp CMD [\u0026#34;/main\u0026#34;] x86_64 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 FROM golang:1.20 as builder WORKDIR /app COPY . . # go äº¤å‰ç¼–è¯‘: x86 RUN go env -w GOPROXY=https://goproxy.cn,direct \u0026amp;\u0026amp; go mod tidy \u0026amp;\u0026amp; \\ CGO_ENABLED=0 GOOS=linux GOARCH=386 go build -o main main.go RUN chmod +x /app/main FROM busybox COPY --from=builder /app/main . EXPOSE 3000/tcp CMD [\u0026#34;/main\u0026#34;] æ„é€ é•œåƒ 1 2 3 4 5 $ docker build -t aifeierwithinmkt/auth-github-webhook:amd64 -f Dockerfile_amd64 . $ docker build -t aifeierwithinmkt/auth-github-webhook:x86 -f Dockerfile_x86 . $ docker tag aifeierwithinmkt/auth-github-webhook:amd64 aifeierwithinmkt/auth-github-webhook æ£€éªŒé•œåƒ 1 2 3 4 5 6 7 $ docker run --rm -p 3000:3000 -d aifeierwithinmkt/auth-github-webhook:amd64 $ docker run --rm -p 3001:3000 -d aifeierwithinmkt/auth-github-webhook:x86 $ curl 127.0.0.1:3000/authenticate {\u0026#34;apiVersion\u0026#34;:\u0026#34;authentication.k8s.io/v1beta1\u0026#34;,\u0026#34;kind\u0026#34;:\u0026#34;TokenReview\u0026#34;,\u0026#34;status\u0026#34;:{\u0026#34;user\u0026#34;:{}}} $ curl 127.0.0.1:3001/authenticate {\u0026#34;apiVersion\u0026#34;:\u0026#34;authentication.k8s.io/v1beta1\u0026#34;,\u0026#34;kind\u0026#34;:\u0026#34;TokenReview\u0026#34;,\u0026#34;status\u0026#34;:{\u0026#34;user\u0026#34;:{}}} é•œåƒæœåŠ¡æ­£å¸¸\nMakefile 1 2 3 4 5 6 7 build_amd64: mkdir -p bin/amd64 CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o bin/amd64/main . build_x86: mkdir -p bin/x86 CGO_ENABLED=0 GOOS=linux GOARCH=386 go build -o bin/x86/main .\twebhook æ¥å…¥ apiserver webhook.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 apiVersion: v1 clusters: - cluster: server: http://192.168.1.7:3000/authenticate name: github-authn contexts: - context: cluster: github-authn user: authn-apiserver name: webhook current-context: webhook kind: Config preferences: {} users: - name: authn-apiserver user: client-certificate-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURJVENDQWdtZ0F3SUJBZ0lJRlYrSjRRNm1heUF3RFFZSktvWklodmNOQVFFTEJRQXdGVEVUTUJFR0ExVUUKQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TXpFeU16QXdPVE16TVRkYUZ3MHlOREV5TWprd09UTTRNVGxhTURReApGekFWQmdOVkJBb1REbk41YzNSbGJUcHRZWE4wWlhKek1Sa3dGd1lEVlFRREV4QnJkV0psY201bGRHVnpMV0ZrCmJXbHVNSUlCSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDQVFFQTQ2NTQzOWp6cVpqcldXd3EKMkloeWtQcjREb3MySnNTM0JrUlhJTzY2UnhhbmxqVGszWlBka21oaUFvRldHTHI5VitwTUdwTytVYzhmbHhDKwoyZVc3QmVwelhzVjd2Y1RRZ25RMVlnVGh2bldRdkxVVFJuUXhoUHhYS2RGNzBEL2RISkxjMGxyVHhjZ2JNUUVTCmdPZWZZQm03dWdBdEJ0RDg3MitrdWVuV3RIc201a09nd0l0N3EzbjVvQ1huZWd4VHBFTHFtcmhtQTYrUXcrNXkKbEg1bG5LdzlFdUJmYmVqY0ZOaEd2UVNFSmFNZ2s0Z2h4bUNQWHJUcFZ0bmRkMHJQMGc4dzkvQ0NKU1owdDV6TApHMk5idFlqQzRRK2tyQXZoSllIUGRzVkRtWTFpMkZsSmsyZGgyU0RzbzJLMGNldmMvRGpUaTdhbGNpTlQwU05ICjFoVXpsd0lEQVFBQm8xWXdWREFPQmdOVkhROEJBZjhFQkFNQ0JhQXdFd1lEVlIwbEJBd3dDZ1lJS3dZQkJRVUgKQXdJd0RBWURWUjBUQVFIL0JBSXdBREFmQmdOVkhTTUVHREFXZ0JRU1oxaVlWKzlQNTRiNHB3UU9QVkI0TklXYgp3REFOQmdrcWhraUc5dzBCQVFzRkFBT0NBUUVBV3pmWXJMWUd5ZGJoM0hpRmxVMWhuR2ZYeGxDMGk3VDBNMmZ1CnZMUkJBM1lYelRMQmNJeFhjT3J2R2Z1OGp3ZE1qY1VmZ2tuQ0JOL2VrN2lqSDF6ZmxmRkVwK0JiWHE2WFpUQWQKTkh1aGdKVG5SRUV4OURHNldtLy9wNnpZOExEVU1ZekZwZGYyYkt2ZWdkQ0NaT3R5OTJ2eFZmbUJ5THJnUHYwRQpGSEZhR1ZCQ083Z012VnFCN05rMGxVN3Axdjg3YzVBTmJxUHI2YjYyZmMzbE9XcGQ2bUN0bDFjdms1QWROczJlCnBRVlFBRnhGR1o3WGFDaU9waFM3L2M1Vm1MUk9lWERHZ1BjUnNjdEtZL0VybXNqQ2JrYnpobnUydk85dnJPRVQKZEh0QlBYRlBYV29PWTVsZWlQa29WRUs4S1FFMmhPWVBpZDhIVHNhZzl1ZGc2Zkwvenc9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg== client-key-data: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBNDY1NDM5anpxWmpyV1d3cTJJaHlrUHI0RG9zMkpzUzNCa1JYSU82NlJ4YW5salRrCjNaUGRrbWhpQW9GV0dMcjlWK3BNR3BPK1VjOGZseEMrMmVXN0JlcHpYc1Y3dmNUUWduUTFZZ1Rodm5XUXZMVVQKUm5ReGhQeFhLZEY3MEQvZEhKTGMwbHJUeGNnYk1RRVNnT2VmWUJtN3VnQXRCdEQ4NzIra3Vlbld0SHNtNWtPZwp3SXQ3cTNuNW9DWG5lZ3hUcEVMcW1yaG1BNitRdys1eWxINWxuS3c5RXVCZmJlamNGTmhHdlFTRUphTWdrNGdoCnhtQ1BYclRwVnRuZGQwclAwZzh3OS9DQ0pTWjB0NXpMRzJOYnRZakM0UStrckF2aEpZSFBkc1ZEbVkxaTJGbEoKazJkaDJTRHNvMkswY2V2Yy9EalRpN2FsY2lOVDBTTkgxaFV6bHdJREFRQUJBb0lCQUJIaWRxUSt5b1ViK2dEQQpPbTFmNm4vdzl1Tk5sQ2RmZEhFTmxUcUZCaVRuWnFxcDVRQnl5UWpqSWkvSU1SY29PUlphMVRlUk8zWDVxeVdXCnJ5YzJvSVpLY0YyVmJhN3VjdUtNZGxVSXhTTE00VjJ4YTU0eEttS2ozOFR0SzZpa0c1NU8rd0diR04rRVpINW8KOHljbENxUGw0WlV1eGxxdXQrK20rVzJSTE1ob2JoOG1mb1RDNGExczJlMEdpM3lkdE16SjNXZnczcUUvUlRGbQoyYm0rMHd6bFlUaXB2cmo4OEJ0aHBQUDlrTmJyVEs4WFNROXUzMnNjS3VWVllpcUJpeStMVUhMek5GY09ZbkpPCjBtdUFsTTFhTmh2WXJQMnI4QThkLzZtays5eDN6THVlM1NVYm1BdTJFUFdMKzZneUxiRHIrV1RJeHYxRVNQS0EKZW5TcWRRRUNnWUVBNVZZMGloY3I2Y0pGbkZZUnBJTjRSUjVrejBhdE12RUZmQWhIbERoUVQrUmpCTXRkVHlFSApNQVFqdXlZaDhReEh0TmxEQzBJTFJTdWpPSWdhZHFsMlBmbzNwR1RmM0xlbExkbGx4amRsVTZJc0lLYVVDdWw5CndPcTBmbkVTbUVUdGdxZS9nazFMS01ZMXUyOXg2S2FkZ25RSlBybFlQT21idW1SY3pydHc3N2NDZ1lFQS9pY0EKcnhDODcvc3VDQS9HUXpRdWlvVWphd0NXSEgyVnE2eUlSNDRVWXJaNWMwRXl1OU5jOFhoQVhTbGJxNzF6NkNDMgpFQVE4cm8weWFWTFB2TDFWeDB2aDVKUjVnaHVkMkcvMFdPbzFVR0l1SFhPaGpSeWR3UDlzZ2NZRGpUaitHYlJNCjlkSWJrWi9YcWx3Uzh2aVJHQ1BaN3hjVm5pTlJ5RzJ5N3BxeUd5RUNnWUIxNDdlRVdONzQvaVc4ZEw0Qy9KWWgKcWJzV2xmVkluMzg3UUNKVGZoTkN6bHRjUnBJRHNDMjZzQllTQ1VzZlZ6bXhMSkg3UW9yNmxyRUR5V3NaSG9tcQoyR29yOXJMaENnSStMR2ZWMmZvYllOMGdONkVZYnVoMjkrK3FvOE4wUk5KMi9IWkVyQ2o3bjlCVk5yZXVhWi9FClJKUFFDNFRoWXhEcll0WVdhMkpseHdLQmdRRFh3SjU0LzNtVk5DTkFucnVOZzNmYkNla21SZ29veDRmT2hCbncKdkxHYmx4S0ZBQjBraStyRDVuU2xZWjI3cm9uOXpmOGdtNmd6K2hPSWk4OWtoMHFSZEY2Z29GYUNXQlZvanFuYwo3WDR5N2hYOTFKS1phMmlVVllGMHJYZUlaSkI1bTdFVm9iYmJxZGo0ZTA5dXlncktkbXprNWpEbzNVenBIQThoCk5WdnJZUUtCZ1FDNDRreXNsRlBUVkNlbkp5SDFHLy82VmQ0aXRFaFlYQVllYWJUdU15eVlkZFlxcnJYTTFUS1QKL24wRHQrQXFIa0dmU2pvUExCa3NITkNDZWZnZSt0dDRxVmFPNjJyWkhRRTQ0TXVueHhxRXBNdmxFeUNEVUM4cApTaUF6bW9XaDR4R2tUdkpLUlBLWGlPNEdjbk5wZVNuUVY5RjJSY01ocllCUVZjTzJLb2N1Umc9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo= è¯¥é…ç½®ä¸ kubeconfig é…ç½®ç›¸åŒ, ç›´æ¥åœ¨ kubeconfig çš„åŸºç¡€ä¸Šä¿®æ”¹å°±è¡Œ, é‡è¦çš„æ˜¯ cluster çš„ server (å³æä¾›æœåŠ¡çš„åœ°å€\napiserver æŒ‚è½½ webconfig 1 2 3 4 5 6 7 8 9 10 11 12 13 14 # ä¿®æ”¹ apiserver é…ç½®å‚æ•°, å¢åŠ : - --authentication-token-webhook-config-file=/etc/config/webhook.yaml # ç›¸åº”å¢åŠ æŒ‚è½½å· volumes: - hostPath: path: /etc/config type: DirectoryOrCreate name: auth-webhook volumeMounts: - mountPath: /etc/config name: auth-webhook readOnly: true ä¿®æ”¹ manifest å apiserver ç†è®ºä¸Šä¼šè‡ªåŠ¨é‡å¯, å¦‚æœæ²¡æœ‰åˆ™ systemctl restart kubelet æœ¬æ–‡å®éªŒä¸»é¢˜ä¸ºè®¤è¯ webhook å¯ç›´æ¥ä½¿ç”¨ --authentication-token-webhook-config-file, å¦‚éœ€è‡ªå®šä¹‰ mutatingwebhook è¯·å‚è€ƒ: mutatingwebhook åœ¨ github ä¸­åˆ›å»ºè®¤è¯ token setting -\u0026gt; Developer Settings -\u0026gt; Personal access tokens (classic)\nå°† token æ·»åŠ åˆ° kubeconfig 1 2 3 4 # åœ¨ kubeconfig ä¸‹å¢åŠ ä¸€ä¸ª user - name: githubuser user: token: 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 éªŒè¯ 1 2 $ k get po --user githubuser Error from server (Forbidden): pods is forbidden: User \u0026#34;Ai-feier\u0026#34; cannot list resource \u0026#34;pods\u0026#34; in API group \u0026#34;\u0026#34; in the namespace \u0026#34;default\u0026#34; æˆæƒéªŒè¯ 1 2 3 4 5 6 7 8 $ k create clusterrolebinding testview --clusterrole view --user Ai-feier $ k get po --user githubuser NAME READY STATUS RESTARTS AGE nginx-kusc00401 0/1 Pending 0 4d23h testnginx-5cdb847cd9-7nm4k 1/1 Running 1 (29h ago) 43h testnginx-5cdb847cd9-llmxf 1/1 Running 1 (29h ago) 43h testnginx-5cdb847cd9-qfsdn 1/1 Running 1 (29h ago) 43h web-server 0/1 Pending 0 4d22h å‚è€ƒ https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/extensible-admission-controllers/ ","date":"2024-01-08T15:54:02+08:00","image":"https://blog-source-mkt.oss-cn-chengdu.aliyuncs.com/blog_source/public/kubernetes/overview-of-webhook.avif","permalink":"/p/kubernetes-webhook-%E5%85%A5%E9%97%A8--%E5%85%A5%E9%97%A8%E6%A1%88%E4%BE%8B-apiserver-%E6%8E%A5%E5%85%A5-github/","title":"Kubernetes WebHook å…¥é—¨ -- å…¥é—¨æ¡ˆä¾‹: apiserver æ¥å…¥ github "},{"content":"Golang ä¸­çš„äº¤å‰ç¼–è¯‘ åœ¨ Golang ä¸­ï¼Œäº¤å‰ç¼–è¯‘æŒ‡çš„æ˜¯åœ¨åŒä¸€å°æœºå™¨ä¸Šç”Ÿæˆé’ˆå¯¹ä¸åŒæ“ä½œç³»ç»Ÿæˆ–ç¡¬ä»¶æ¶æ„çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚è¿™åœ¨å¼€å‘è·¨å¹³å°åº”ç”¨æˆ–æ„å»ºç‰¹å®šå¹³å°çš„å‘å¸ƒç‰ˆæœ¬æ—¶éå¸¸æœ‰ç”¨ã€‚\nä¸åŒæ“ä½œç³»ç»Ÿé—´çš„ç¼–è¯‘ Linux ä¸‹ç¼–è¯‘ windows 1 $ CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build main.go macos 1 $ CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 go build main.go windows ä¸‹ç¼–è¯‘ Linux 1 2 3 4 SET CGO_ENABLED=0 SET GOOS=linux SET GOARCH=amd64 go build main.go æ¨è git ç»ˆç«¯: CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build main.go\nmacos 1 2 3 4 SET CGO_ENABLED=0 SET GOOS=darwin SET GOARCH=amd64 go build main.go git ç»ˆç«¯: CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 go build main.go\nmacos ä¸‹ç¼–è¯‘ Linux 1 $ CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build main.go windows 1 $ CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build main.go ä¸åŒæ¶æ„ä¸‹çš„ç¼–è¯‘ amd64 1 $ CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build main.go x86 1 $ CGO_ENABLED=0 GOOS=linux GOARCH=386 go build main.go æ³¨æ„ä¸æ˜¯ x86\nä¸Šé¢å‡ ä¸ªç¤ºä¾‹ä¸­å„ç¯å¢ƒå˜é‡çš„æ„æ€å¦‚ä¸‹ï¼š\nCGO_ENABLEDï¼šCGO_ENABLED=0 æ„æ€æ˜¯ç¦ç”¨ CGOï¼Œå› ä¸ºäº¤å‰ç¼–è¯‘ä¸èƒ½å¯ç”¨ CGOã€‚ GOOSï¼šè¡¨ç¤ºç›®æ ‡å¹³å°ï¼Œä¾‹å¦‚ mac ç³»ç»Ÿå¯¹åº” darwinï¼Œlinux ç³»ç»Ÿå¯¹åº” linuxï¼Œwindows ç³»ç»Ÿå¯¹åº” windowsç­‰ã€‚ GOARCHï¼šç›®æ ‡å¹³å°çš„æ¶æ„ï¼Œä¾‹å¦‚ amd64ï¼Œarmç­‰ã€‚ å‚è€ƒ [Golang ä¸­çš„äº¤å‰ç¼–è¯‘è¯¦è§£ - çŸ¥ä¹ (zhihu.com)](https://zhuanlan.zhihu.com/p/649520911#:~:text=Golang ä¸­çš„äº¤å‰ç¼–è¯‘åœ¨,Golang ä¸­ï¼Œäº¤å‰ç¼–è¯‘æŒ‡çš„æ˜¯åœ¨åŒä¸€å°æœºå™¨ä¸Šç”Ÿæˆé’ˆå¯¹ä¸åŒæ“ä½œç³»ç»Ÿæˆ–ç¡¬ä»¶æ¶æ„çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚ è¿™åœ¨å¼€å‘è·¨å¹³å°åº”ç”¨æˆ–æ„å»ºç‰¹å®šå¹³å°çš„å‘å¸ƒç‰ˆæœ¬æ—¶éå¸¸æœ‰ç”¨ã€‚) Go äº¤å‰ç¼–è¯‘ (è·¨å¹³å°ç¼–è¯‘) - çŸ¥ä¹ (zhihu.com) ","date":"2024-01-05T18:20:08+08:00","image":"https://blog-source-mkt.oss-cn-chengdu.aliyuncs.com/blog_source/post/public/golang/cover.png","permalink":"/p/golang-%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91%E8%AF%A6%E8%A7%A3/","title":"Golang äº¤å‰ç¼–è¯‘è¯¦è§£"},{"content":"è®©aptå¯ä»¥æ”¯æŒHTTPS 1 $ apt install apt-transport-https ca-certificates curl software-properties-common -y å°†å®˜æ–¹Dockeråº“çš„GPGå…¬é’¥æ·»åŠ åˆ°ç³»ç»Ÿä¸­ï¼š 1 2 3 4 $ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add - # é˜¿é‡Œäº‘æº $ curl -fsSL https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add - å°†Dockeråº“æ·»åŠ åˆ°APTé‡Œï¼š 1 2 3 4 5 6 # å®˜æ–¹æº $ add-apt-repository \u0026#34;deb [arch=amd64] https://download.docker.com/linux/ubuntu focal stable\u0026#34; # é˜¿é‡Œæº $ add-apt-repository \u0026#34;deb [arch=amd64] https://mirrors.aliyun.com/docker-ce/linux/ubuntu focal stable\u0026#34; # echo \u0026#34;deb [arch=amd64] https://mirrors.aliyun.com/docker-ce/linux/ubuntu focal stable\u0026#34; \u0026gt;\u0026gt; /etc/apt/source.list æ›´æ–°åŒ…åˆ—è¡¨ 1 $ apt update ä¸ºäº†ç¡®ä¿ä¿®æ”¹ç”Ÿæ•ˆï¼Œè®©æ–°çš„å®‰è£…ä»Dockeråº“é‡Œè·å–ï¼Œè€Œä¸æ˜¯ä»Ubuntuè‡ªå·±çš„åº“é‡Œè·å–ï¼Œæ‰§è¡Œï¼š 1 $ apt-cache policy docker-ce å®‰è£… docker-ce 1 $ apt install -y docker-ce é…ç½® docker é˜¿é‡Œæºé•œåƒåœ°å€ 1 2 3 4 5 6 7 8 sudo mkdir -p /etc/docker sudo tee /etc/docker/daemon.json \u0026lt;\u0026lt;-\u0026#39;EOF\u0026#39; { \u0026#34;registry-mirrors\u0026#34;: [\u0026#34;https://nol6uuul.mirror.aliyuncs.com\u0026#34;] } EOF sudo systemctl daemon-reload sudo systemctl restart docker æ£€æŸ¥ docker è¿è¡ŒçŠ¶æ€ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 $ systemctl status docker â— docker.service - Docker Application Container Engine Loaded: loaded (/lib/systemd/system/docker.service; enabled; vendor preset: enabled) Active: active (running) since Fri 2024-01-05 16:02:08 CST; 17min ago TriggeredBy: â— docker.socket Docs: https://docs.docker.com Main PID: 241165 (dockerd) Tasks: 12 Memory: 29.6M CGroup: /system.slice/docker.service â””â”€241165 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock Jan 05 16:02:08 master1 dockerd[241165]: time=\u0026#34;2024-01-05T16:02:08.136300388+08:00\u0026#34; level=info msg=\u0026#34;Docker daemon\u0026#34; commit=311b9ff graphdriver=overla\u0026gt; Jan 05 16:02:08 master1 dockerd[241165]: time=\u0026#34;2024-01-05T16:02:08.136351488+08:00\u0026#34; level=info msg=\u0026#34;Daemon has completed initialization\u0026#34; Jan 05 16:02:08 master1 dockerd[241165]: time=\u0026#34;2024-01-05T16:02:08.254789219+08:00\u0026#34; level=info msg=\u0026#34;API listen on /run/docker.sock\u0026#34; Jan 05 16:02:08 master1 systemd[1]: Started Docker Application Container Engine. Jan 05 16:02:46 master1 dockerd[241165]: time=\u0026#34;2024-01-05T16:02:46.543587374+08:00\u0026#34; level=warning msg=\u0026#34;Error persisting manifest\u0026#34; digest=\u0026#34;sha256:2fc\u0026gt; Jan 05 16:03:38 master1 dockerd[241165]: time=\u0026#34;2024-01-05T16:03:38.612170892+08:00\u0026#34; level=info msg=\u0026#34;ignoring event\u0026#34; container=6d8d34f0066bde04811038\u0026gt; Jan 05 16:04:50 master1 dockerd[241165]: time=\u0026#34;2024-01-05T16:04:50.406175352+08:00\u0026#34; level=info msg=\u0026#34;ignoring event\u0026#34; container=504632135d04b87b5ed83f\u0026gt; Jan 05 16:05:35 master1 dockerd[241165]: time=\u0026#34;2024-01-05T16:05:35.656175212+08:00\u0026#34; level=error msg=\u0026#34;Error setting up exec command in container 5046\u0026gt; Jan 05 16:09:52 master1 dockerd[241165]: time=\u0026#34;2024-01-05T16:09:52.944844810+08:00\u0026#34; level=info msg=\u0026#34;Layer sha256:a87ab3c028db3c73f360b49c9dcd171e236\u0026gt; Jan 05 16:09:52 master1 dockerd[241165]: time=\u0026#34;2024-01-05T16:09:52.946428917+08:00\u0026#34; level=info msg=\u0026#34;Layer sha256:82ae998286b2bba64ce571578647adcabef\u0026gt; lines 1-21/21 (END) ","date":"2024-01-05T16:48:49+08:00","image":"https://blog-source-mkt.oss-cn-chengdu.aliyuncs.com/blog_source/public/0_85-DDF3zAO5nAsNh.jpg","permalink":"/p/docker-ce-%E5%AE%89%E8%A3%85%E4%B8%8E%E5%9B%BD%E5%86%85%E6%BA%90%E9%85%8D%E7%BD%AE-ubuntu-20.04/","title":"docker-ce å®‰è£…ä¸å›½å†…æºé…ç½® | Ubuntu 20.04 "},{"content":"ç”Ÿæˆ key 1 $ openssl genrsa --out mkt.key 2048 æ ¹æ® key ç”Ÿæˆ csr CN: ä¸º mkt\n1 $ openssl req -new -key mkt.key -out mkt.csr -subj \u0026#34;/CN=mkt\u0026#34; æŠŠ csr å‘ç»™ apiserver çš„ ca ç”Ÿæˆ crt 1 2 3 4 $ openssl x509 -req -in mkt.csr -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -out mkt.crt -days 1095 Signature ok subject=CN = mkt Getting CA Private Key ç”Ÿæˆæ–‡ä»¶:\n1 2 root@master1:~/tmp# ls mkt.crt mkt.csr mkt.key æŸ¥çœ‹è¯ä¹¦\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 $ openssl x509 -in mkt.crt -text -noout Certificate: Data: Version: 1 (0x0) Serial Number: 01:60:fb:9a:ce:5e:59:28:b0:e3:d6:76:90:99:eb:52:41:a5:b9:86 Signature Algorithm: sha256WithRSAEncryption Issuer: CN = kubernetes Validity Not Before: Jan 3 06:44:53 2024 GMT Not After : Jan 2 06:44:53 2027 GMT Subject: CN = mkt Subject Public Key Info: Public Key Algorithm: rsaEncryption RSA Public-Key: (2048 bit) Modulus: 00:d2:52:66:f1:f9:66:b6:9d:26:12:0e:1b:87:5d: 38:bb:56:a3:b0:ce:e1:49:91:b5:f5:cb:35:28:93: 1f:c8:55:7c:db:21:fc:84:ba:e9:15:27:e6:f9:fb: 38:19:0c:73:7a:0b:71:85:d9:66:f4:e4:5e:1c:3b: 6f:ea:b4:2b:e7:42:45:b2:96:fb:b9:74:97:f0:58: e7:ec:dd:04:54:05:81:37:45:e8:e1:13:d5:01:2e: 7e:34:48:63:63:56:90:b1:83:a7:79:c7:76:ee:03: 9c:1a:f6:e0:18:86:7b:12:54:c6:0f:fc:d3:63:4e: 62:f3:bc:ad:4a:c7:5e:a0:73:88:1e:df:46:72:c8: e2:84:11:5c:07:0c:23:58:81:f5:6d:15:9e:1c:48: fa:f5:76:1a:2b:0f:56:90:76:4f:06:3a:74:af:15: 87:23:c1:cf:04:69:fd:a1:91:d2:53:64:f8:02:da: 58:59:f2:ce:13:b2:40:91:da:fe:4d:2f:24:bf:fe: 6a:b7:ff:01:d8:4b:04:02:ab:f2:d6:e6:c2:61:af: 12:1e:53:ad:1a:cc:07:ee:f5:f1:d1:84:ef:67:01: ba:80:cf:21:61:87:bc:bb:d9:e6:25:de:b4:d7:23: 76:67:bb:b0:db:89:d0:53:c6:13:fa:31:30:32:5e: ba:f3 Exponent: 65537 (0x10001) Signature Algorithm: sha256WithRSAEncryption 86:3a:a2:70:d1:10:88:4f:b7:16:2b:76:37:52:2b:7d:c0:0b: 34:f9:fa:d3:ca:19:be:e8:20:5a:d6:e8:dd:19:46:4b:85:dd: b2:aa:74:3a:61:b1:96:a6:1c:8e:3c:fc:1f:5f:17:28:6e:0e: cc:be:e8:f9:f9:2f:02:cb:47:89:34:a3:9b:6b:d2:e6:3e:a4: e3:99:c4:cd:f9:2b:fe:bc:79:e1:d2:02:84:a3:e0:6c:90:e4: c9:76:1e:d8:52:56:96:61:f6:83:8d:f5:41:6f:50:49:ab:08: 24:32:e5:b1:1c:16:88:39:2e:a9:38:93:cd:32:df:f8:dc:c2: 32:c1:3d:14:fd:cf:ac:42:74:53:47:a9:e1:20:fc:88:3a:e3: 87:c7:b0:49:b2:46:11:0a:9f:1a:f3:d6:c4:1e:2d:7c:68:75: 87:08:43:ff:95:20:46:f3:8a:61:cc:54:72:bf:81:d8:2b:92: f1:0d:f8:ae:2e:b9:16:f1:f0:b3:a7:8e:0a:93:c4:0b:a1:c4: c3:bd:58:a0:e2:e1:f8:96:40:12:cd:de:97:54:a3:14:4c:fe: 37:61:e2:83:1b:50:2e:f9:a3:96:3e:6d:d2:09:67:56:63:07: 98:8c:14:33:69:e1:24:66:d2:20:33:2e:30:8f:92:a9:61:02: 7a:1a:97:49 æŸ¥çœ‹ kubeconfig 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 $ kubectl config view apiVersion: v1 clusters: - cluster: certificate-authority-data: DATA+OMITTED server: https://11.0.1.150:6443 name: kubernetes contexts: - context: cluster: kubernetes user: kubernetes-admin name: kubernetes-admin@kubernetes current-context: kubernetes-admin@kubernetes kind: Config preferences: {} users: - name: kubernetes-admin user: client-certificate-data: DATA+OMITTED client-key-data: DATA+OMITTED åˆ›å»º k8s ç”¨æˆ· 1 2 $ kubectl config set-credentials mkt --client-certificate=mkt.crt --client-key=mkt.key --embed-certs=true User \u0026#34;mkt\u0026#34; set. æŸ¥çœ‹ kubeconfig\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 $ kubectl config view apiVersion: v1 clusters: - cluster: certificate-authority-data: DATA+OMITTED server: https://11.0.1.150:6443 name: kubernetes contexts: - context: cluster: kubernetes user: kubernetes-admin name: kubernetes-admin@kubernetes current-context: kubernetes-admin@kubernetes kind: Config preferences: {} users: - name: kubernetes-admin user: client-certificate-data: DATA+OMITTED client-key-data: DATA+OMITTED - name: mkt user: client-certificate-data: DATA+OMITTED client-key-data: DATA+OMITTED æŸ¥çœ‹ pod\n1 2 $ k get po -A --user mkt Error from server (Forbidden): pods is forbidden: User \u0026#34;mkt\u0026#34; cannot list resource \u0026#34;pods\u0026#34; in API group \u0026#34;\u0026#34; at the cluster scope æ–°å»ºä¸€ä¸ª context\n1 $ k config set-context mkt@kubernetes --cluster kubernetes --user mkt åˆ‡æ¢ context\n1 2 3 4 $ k config use-context mkt@kubernetes $ k get po -A # é»˜è®¤ç”¨æˆ·å·²ä¸º mkt Error from server (Forbidden): pods is forbidden: User \u0026#34;mkt\u0026#34; cannot list resource \u0026#34;pods\u0026#34; in API group \u0026#34;\u0026#34; at the cluster scope å…¶ä¸­ \u0026ldquo;mkt\u0026rdquo; æ˜¯ csr ä¸­çš„ CN\nä¸ºç”¨æˆ·ç»‘å®š role\n1 2 3 4 5 6 7 8 9 # åˆ›å»º 2 ä¸ª user $ kubectl config set-credentials user1 --client-certificate mkt.crt --client-key mkt.key --embed-certs=true $ kubectl config set-credentials user2 --client-certificate mkt.crt --client-key mkt.key --embed-certs=true # åˆ›å»º clusterrole $ kubectl create clusterrole podsOwe --verb=\u0026#39;*\u0026#39; --resource=pods # åˆ›å»º clusterrolebinding $ kubectl create clusterrolebinding pods-binding --clusterrole=podsOwe --user=mkt æŸ¥çœ‹ pod\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 $ kubectl get po -A --user=user1 $ kubectl get po -A --user=user2 calico-apiserver calico-apiserver-69fc754d76-9w7p6 1/1 Running 4 (103m ago) 3d23h calico-apiserver calico-apiserver-69fc754d76-kdxt4 1/1 Running 4 (103m ago) 3d23h calico-system calico-kube-controllers-b9dcc57c4-gzlhk 1/1 Running 4 (103m ago) 3d23h calico-system calico-node-5jckf 1/1 Running 4 (103m ago) 3d23h calico-system calico-node-gq882 1/1 Running 4 (103m ago) 3d23h calico-system calico-node-zksvz 1/1 Running 4 (101m ago) 3d22h calico-system calico-typha-5cdb9d5d59-tnjzh 1/1 Running 4 (103m ago) 3d23h calico-system calico-typha-5cdb9d5d59-z7tnk 1/1 Running 4 (101m ago) 3d22h calico-system csi-node-driver-j4648 2/2 Running 8 (103m ago) 3d23h calico-system csi-node-driver-jf548 2/2 Running 8 (101m ago) 3d22h ...... æˆ‘ä»¬æ˜¯æŠŠ rolebinding ç»‘ç»™çš„ mkt, ä½†user1, user2å‡èƒ½è·å– pod\nè¯´æ˜: å…³é”®çš„æ˜¯ csr çš„ \u0026ldquo;CN\u0026rdquo;\nè¡¥å……: å¦‚æœæœ‰åˆ†ç»„çš„è¯, å°±çœ‹ csr çš„ \u0026ldquo;O\u0026rdquo;\n","date":"2024-01-03T17:22:24+08:00","image":"https://blog-source-mkt.oss-cn-chengdu.aliyuncs.com/blog_source/public/kubernetes/1_RAHmolC--zbpMi7JiTH3Gg.png","permalink":"/p/kubernetes-%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86-apiserver-%E6%96%B0%E5%A2%9E%E9%9B%86%E7%BE%A4%E7%94%A8%E6%88%B7/","title":"Kubernetes ç”¨æˆ·ç®¡ç†, ApiServer æ–°å¢é›†ç¾¤ç”¨æˆ·"},{"content":"è‡ªåŠ¨è¡¥å…¨\n1 2 3 4 echo \u0026#34;source \u0026lt;(kubectl completion bash)\u0026#34; \u0026gt;\u0026gt; ~/.profile echo \u0026#34;alias k=kubectl\u0026#34; \u0026gt;\u0026gt; ~/.profile echo \u0026#34;complete -F __start_kubectl k\u0026#34; \u0026gt;\u0026gt; ~/.profile source ~/.profile vim è®¾ç½®ä¸ºç²˜è´´æ¨¡å¼, é˜²æ­¢ç¼©è¿›é—®é¢˜\n1 echo \u0026#34;set paste\u0026#34; \u0026gt;\u0026gt; ~/.vimrc 1ã€æƒé™æ§åˆ¶ RBAC é¢˜ç›®: 1 2 3 4 5 6 7 8 9 10 11 12 13 è®¾ç½®é…ç½®ç¯å¢ƒï¼š [candidate@node-1] $ kubectl config use-context k8s Context ä¸ºéƒ¨ç½²æµæ°´çº¿åˆ›å»ºä¸€ä¸ªæ–°çš„ ClusterRole å¹¶å°†å…¶ç»‘å®šåˆ°èŒƒå›´ä¸ºç‰¹å®šçš„ namespace çš„ç‰¹å®š ServiceAccountã€‚ Task åˆ›å»ºä¸€ä¸ªåä¸º deployment-clusterrole ä¸”ä»…å…è®¸åˆ›å»ºä»¥ä¸‹èµ„æºç±»å‹çš„æ–° ClusterRoleï¼š Deployment StatefulSet DaemonSet åœ¨ç°æœ‰çš„ namespace app-team1 ä¸­åˆ›å»ºä¸€ä¸ªåä¸º cicd-token çš„æ–° ServiceAccountã€‚ é™äº namespace app-team1 ä¸­ï¼Œå°†æ–°çš„ ClusterRole deployment-clusterrole ç»‘å®šåˆ°æ–°çš„ ServiceAccount cicd-tokenã€‚ è€ƒç‚¹ï¼š RBAC æˆæƒæ¨¡å‹çš„ç†è§£ã€‚\nå‚è€ƒé“¾æ¥: æ²¡å¿…è¦å‚è€ƒç½‘å€ï¼Œä½¿ç”¨-h å¸®åŠ©æ›´æ–¹ä¾¿ã€‚\nkubectl create clusterrole -h\nkubectl create rolebinding -h\nhttps://kubernetes.io/docs/reference/access-authn-authz/rbac/#command-line-utilities\nè§£ç­”: æ›´æ¢ context 1 $ kubectl config use-context k8s åˆ›å»º ClusterRole 1 $ kubectl create clusterrole deployment-clusterrole --verb=create --resource=deployment,daemonset,statefulset åˆ›å»º ServiceAccount 1 $ kubectl create sa cicd-token -n app-team1 åˆ›å»º rolebinding rolebinding åé¢çš„åå­— cicd-token-rolebinding éšä¾¿èµ·çš„ï¼Œå› ä¸ºé¢˜ç›®ä¸­æ²¡æœ‰è¦æ±‚ï¼Œå¦‚æœé¢˜ç›®ä¸­æœ‰è¦æ±‚ï¼Œå°±ä¸èƒ½éšä¾¿èµ·äº†ã€‚\n1 kubectl -n app-team1 create rolebinding cicd-token-rolebinding --clusterrole=deployment-clusterrole --serviceaccount=app-team1:cicd-token æ£€æŸ¥ 1 2 3 4 5 6 7 $ kubectl -n app-team1 describe rolebinding cicd-token-rolebinding $ kubectl auth can-i create deployment --as system:serviceaccount:app-team1:cicd-token no $ kubectl auth can-i create deployment -n app-team1 --as system:serviceaccount:app-team1:cicd-token yes 2ã€æŸ¥çœ‹ pod çš„ CPU é¢˜ç›®: 1 2 3 4 5 6 è®¾ç½®é…ç½®ç¯å¢ƒï¼š [candidate@node-1] $ kubectl config use-context k8s Task é€šè¿‡ pod label name=cpu-loaderï¼Œæ‰¾åˆ°è¿è¡Œæ—¶å ç”¨å¤§é‡ CPU çš„ podï¼Œ å¹¶å°†å ç”¨ CPU æœ€é«˜çš„ pod åç§°å†™å…¥æ–‡ä»¶ /opt/KUTR000401/KUTR00401.txtï¼ˆå·²å­˜åœ¨ï¼‰ã€‚ è€ƒç‚¹ï¼š kubectl top \u0026ndash;l å‘½ä»¤çš„ä½¿ç”¨\nå‚è€ƒé“¾æ¥: https://kubernetes.io/docs/reference/kubectl/cheatsheet/#interacting-with-running-pods\nè§£ç­”: æ›´æ¢ context 1 $ kubectl config use-context k8s 1 2 3 4 5 # æŸ¥çœ‹ pod åç§° -A æ˜¯æ‰€æœ‰ namespace $ kubectl top pod -l name=cpu-loader --sort-by=cpu -A # å°† cpu å ç”¨æœ€å¤šçš„ pod çš„ name å†™å…¥/opt/test1.txt æ–‡ä»¶ $ echo \u0026#34;æŸ¥å‡ºæ¥çš„ Pod Name\u0026#34; \u0026gt; /opt/KUTR000401/KUTR00401.txt æ£€æŸ¥ 1 $ cat /opt/KUTR000401/KUTR00401.txt 3ã€é…ç½®ç½‘ç»œç­–ç•¥ NetworkPolicy é¢˜ç›®: 1 2 3 4 5 6 7 8 è®¾ç½®é…ç½®ç¯å¢ƒï¼š [candidate@node-1] $ kubectl config use-context hk8s Task åœ¨ç°æœ‰çš„ namespace my-app ä¸­åˆ›å»ºä¸€ä¸ªåä¸º allow-port-from-namespace çš„æ–° NetworkPolicyã€‚ ç¡®ä¿æ–°çš„ NetworkPolicy å…è®¸ namespace echo ä¸­çš„ Pods è¿æ¥åˆ° namespace my-app ä¸­çš„ Pods çš„ 9000 ç«¯å£ã€‚ è¿›ä¸€æ­¥ç¡®ä¿æ–°çš„ NetworkPolicyï¼š ä¸å…è®¸å¯¹æ²¡æœ‰åœ¨ç›‘å¬ ç«¯å£ 9000 çš„ Pods çš„è®¿é—® ä¸å…è®¸éæ¥è‡ª namespace echo ä¸­çš„ Pods çš„è®¿é—® åŒé‡å¦å®šå°±æ˜¯è‚¯å®šï¼Œæ‰€ä»¥æœ€åä¸¤å¥è¯çš„æ„æ€å°±æ˜¯ï¼š\nä»…å…è®¸ç«¯å£ä¸º 9000 çš„ pod æ–¹æ³•ã€‚\nä»…å…è®¸ echo å‘½åç©ºé—´ä¸­çš„ pod è®¿é—®ã€‚\nè€ƒç‚¹ï¼š NetworkPolicy çš„åˆ›å»º\nå‚è€ƒé“¾æ¥: ä¾æ¬¡ç‚¹å‡» Concepts â†’ Services, Load Balancing, and Networking â†’ Network Policiesï¼ˆçœ‹ä¸æ‡‚è‹±æ–‡çš„ï¼Œå¯å³ä¸Šè§’ç¿»è¯‘æˆä¸­æ–‡ï¼‰\nhttps://kubernetes.io/zh-cn/docs/concepts/services-networking/network-policies/\nè§£ç­”: æ›´æ¢ context 1 $ kubectl config use-context hk8s æŸ¥çœ‹ namespace echo çš„æ ‡ç­¾ 1 2 3 4 # æŸ¥çœ‹æ‰€æœ‰ ns çš„æ ‡ç­¾ label $ kubectl get ns --show-labels # å¦‚æœè®¿é—®è€…çš„ namespace æ²¡æœ‰æ ‡ç­¾ labelï¼Œåˆ™éœ€è¦æ‰‹åŠ¨æ‰“ä¸€ä¸ªã€‚å¦‚æœæœ‰ä¸€ä¸ªç‹¬ç‰¹çš„æ ‡ç­¾ labelï¼Œåˆ™ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚ $ kubectl label ns echo project=echo åˆ›å»º networkpolicy 1 vim networkpolicy.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 apiVersion: networking.k8s.io/v1 kind: NetworkPolicy metadata: name: allow-port-from-namespace namespace: my-app #è¢«è®¿é—®è€…çš„å‘½åç©ºé—´ spec: podSelector: #è¿™ä¸¤è¡Œå¿…é¡»è¦å†™ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥å†™æˆä¸€è¡Œä¸º podSelector: {} matchLabels: {} # æ³¨æ„ matchLabels:ä¸{}ä¹‹é—´æœ‰ä¸€ä¸ªç©ºæ ¼ policyTypes: - Ingress #ç­–ç•¥å½±å“å…¥æ ˆæµé‡ ingress: - from: #å…è®¸æµé‡çš„æ¥æº - namespaceSelector: matchLabels: project: echo #è®¿é—®è€…çš„å‘½åç©ºé—´çš„æ ‡ç­¾ label #- podSelector: {} #æ³¨æ„ï¼Œè¿™ä¸ªä¸å†™ã€‚å¦‚æœ ingress é‡Œä¹Ÿå†™äº†- podSelector: {}ï¼Œåˆ™ä¼šå¯¼è‡´ my-app ä¸­çš„ pod å¯ä»¥è®¿é—® my-app ä¸­ pod çš„ 9000 äº†ï¼Œè¿™æ ·ä¸ æ»¡è¶³é¢˜ç›®è¦æ±‚ä¸å…è®¸éæ¥è‡ª namespace echo ä¸­çš„ Pods çš„è®¿é—®ã€‚ ports: - protocol: TCP port: 9000 #è¢«è®¿é—®è€…å…¬å¼€çš„ç«¯å£ åˆ›å»º 1 $ kubectl apply -f networkpolicy.yaml æ£€æŸ¥ 1 $ kubectl describe networkpolicy -n my-app 4ã€æš´éœ²æœåŠ¡ service é¢˜ç›®: 1 2 3 4 5 6 7 è®¾ç½®é…ç½®ç¯å¢ƒï¼š [candidate@node-1] $ kubectl config use-context k8s Task è¯·é‡æ–°é…ç½®ç°æœ‰çš„ deployment front-end ä»¥åŠæ·»åŠ åä¸º http çš„ç«¯å£è§„èŒƒæ¥å…¬å¼€ç°æœ‰å®¹å™¨ nginx çš„ç«¯å£ 80/tcpã€‚ åˆ›å»ºä¸€ä¸ªåä¸º front-end-svc çš„æ–° serviceï¼Œä»¥å…¬å¼€å®¹å™¨ç«¯å£ httpã€‚ é…ç½®æ­¤ serviceï¼Œä»¥é€šè¿‡å„ä¸ª Pod æ‰€åœ¨çš„èŠ‚ç‚¹ä¸Šçš„ NodePort æ¥å…¬å¼€ä»–ä»¬ã€‚ è€ƒç‚¹ï¼š å°†ç°æœ‰çš„ deploy æš´éœ²æˆ nodeport çš„ serviceã€‚\nå‚è€ƒé“¾æ¥: ä¾æ¬¡ç‚¹å‡» Concepts â†’ Workloads â†’ Workload Resources â†’ Deploymentsï¼ˆçœ‹ä¸æ‡‚è‹±æ–‡çš„ï¼Œå¯å³ä¸Šè§’ç¿»è¯‘æˆä¸­æ–‡ï¼‰\nhttps://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/deployment/\nè§£ç­”: æ›´æ¢ context 1 $ kubectl config use-context k8s ä¿®æ”¹ deployment 1 2 3 4 5 6 7 8 9 10 11 12 13 $ kubectl edit deployment front-end ...... spec: containers: - image: vicuu/nginx:hello imagePullPolicy: IfNotPresent name: nginx #æ‰¾åˆ°æ­¤ä½ç½®ã€‚ä¸‹æ–‡ä¼šç®€å•è¯´æ˜ä¸€ä¸‹ yaml æ–‡ä»¶çš„æ ¼å¼ï¼Œä¸æ‡‚ yaml æ ¼å¼çš„ï¼Œå¾€ä¸‹çœ‹ã€‚ ports: #æ·»åŠ è¿™ 4 è¡Œ - name: http containerPort: 80 protocol: TCP ...... æš´éœ²ç«¯å£ 1 $ kubectl expose deployment front-end --type=NodePort --port=80 --target-port=80 --name=front-end-svc æ£€æŸ¥ 1 $ kubectl get svc front-end-svc -o wide 5ã€åˆ›å»º Ingress é¢˜ç›®: 1 2 3 4 5 6 7 8 9 10 11 è®¾ç½®é…ç½®ç¯å¢ƒï¼š [candidate@node-1] $ kubectl config use-context k8s Task å¦‚ä¸‹åˆ›å»ºä¸€ä¸ªæ–°çš„ nginx Ingress èµ„æºï¼š åç§°: ping Namespace: ing-internal ä½¿ç”¨æœåŠ¡ç«¯å£ 5678 åœ¨è·¯å¾„ /hello ä¸Šå…¬å¼€æœåŠ¡ hello å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ£€æŸ¥æœåŠ¡ hello çš„å¯ç”¨æ€§ï¼Œè¯¥å‘½ä»¤åº”è¿”å› helloï¼š curl -kL \u0026lt;INTERNAL_IP\u0026gt;/hello è€ƒç‚¹ï¼š Ingress çš„åˆ›å»º\nå‚è€ƒé“¾æ¥: ä¾æ¬¡ç‚¹å‡» Concepts â†’ Services, Load Balancing, and Networking â†’ Ingress ï¼ˆçœ‹ä¸æ‡‚è‹±æ–‡çš„ï¼Œå¯å³ä¸Šè§’ç¿»è¯‘æˆä¸­æ–‡ï¼‰\nhttps://kubernetes.io/zh-cn/docs/concepts/services-networking/ingress/\nè§£ç­”: æ›´æ¢ context 1 $ kubectl config use-context k8s åˆ›å»º ingressclass 1 $ vim ingressclass.yaml 1 2 3 4 5 6 7 8 9 10 apiVersion: networking.k8s.io/v1 kind: IngressClass metadata: labels: app.kubernetes.io/component: controller name: nginx annotations: ingressclass.kubernetes.io/is-default-class: \u0026#34;true\u0026#34; spec: controller: k8s.io/ingress-nginx 1 $ kubectl apply -f ingressclass.yaml åˆ›å»º ingress 1 $ vim ingress.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 apiVersion: networking.k8s.io/v1 kind: Ingress metadata: name: ping namespace: ing-internal annotations: nginx.ingress.kubernetes.io/rewrite-target: / spec: ingressClassName: nginx rules: - http: paths: - path: /hello pathType: Prefix backend: service: name: hello port: number: 5678 1 $ kubectl apply -f ingress.yaml æ£€æŸ¥ 1 2 3 $ kubectl apply -f ingress.yaml ä¹Ÿå¯ä»¥ curl ä¸€ä¸‹ ingress åœ°å€ 6ã€æ‰©å®¹ deployment å‰¯æœ¬æ•°é‡ é¢˜ç›®: 1 2 3 4 è®¾ç½®é…ç½®ç¯å¢ƒï¼š [candidate@node-1] $ kubectl config use-context k8s Task å°† deployment presentation æ‰©å±•è‡³ 4 ä¸ª pods è€ƒç‚¹ï¼š deployment æ‰©ç¼©å®¹\nå‚è€ƒé“¾æ¥: æ²¡å¿…è¦å‚è€ƒç½‘å€ï¼Œä½¿ç”¨-h å¸®åŠ©æ›´æ–¹ä¾¿ã€‚\nkubectl scale deployment -h\nhttps://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/deployment/#scaling-a-deployment https://kubernetes.io/zh-cn/docs/tasks/run-application/scale-stateful-set/\nè§£ç­”: æ›´æ¢ context 1 $ kubectl config use-context k8s ä¿®æ”¹replicaset 1 $ kubectl scale deployment presentation --replicas=4 æ£€æŸ¥ 1 $ kubectl get deployment presentation -oyaml 7ã€è°ƒåº¦ pod åˆ°æŒ‡å®šèŠ‚ç‚¹ é¢˜ç›®: 1 2 3 4 5 6 7 8 è®¾ç½®é…ç½®ç¯å¢ƒï¼š [candidate@node-1] $ kubectl config use-context k8s Task æŒ‰å¦‚ä¸‹è¦æ±‚è°ƒåº¦ä¸€ä¸ª podï¼š åç§°ï¼šnginx-kusc00401 Imageï¼šnginx Node selectorï¼šdisk=ssd è€ƒç‚¹ï¼š nodeSelect å±æ€§çš„ä½¿ç”¨\nå‚è€ƒé“¾æ¥: ä¾æ¬¡ç‚¹å‡» Tasks â†’ Configure Pods and Containers â†’ Assign Pods to Nodes ï¼ˆçœ‹ä¸æ‡‚è‹±æ–‡çš„ï¼Œå¯å³ä¸Šè§’ç¿»è¯‘æˆä¸­æ–‡ï¼‰\nhttps://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/assign-pods-nodes/\nè§£ç­”: æ›´æ¢ context 1 $ kubectl config use-context k8s åˆ›å»º pod yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 # è·å–ä¸€ä¸ª pod æ¨¡ç‰ˆ $ kubectl run nginx-kusc00401 --image=nginx --dry-run -oyaml \u0026gt; 7.pod.yaml $ cat 7.pod.yaml apiVersion: v1 kind: Pod metadata: name: nginx-kusc00401 spec: nodeSelector: # æ–°å¢, å…¶ä½™å†…å®¹ä¸éœ€è¦ disk: ssd containers: - image: nginx name: nginx-kusc00401 åˆ›å»º pod 1 2 $ kubectl create -f 7.pod.yaml pod/nginx-kusc00401 created æ£€æŸ¥ 1 $ kubectl get po -owide 8ã€æŸ¥çœ‹å¯ç”¨èŠ‚ç‚¹æ•°é‡ é¢˜ç›®: 1 2 3 4 5 è®¾ç½®é…ç½®ç¯å¢ƒï¼š [candidate@node-1] $ kubectl config use-context k8s Task æ£€æŸ¥æœ‰å¤šå°‘ nodes å·²å‡†å¤‡å°±ç»ªï¼ˆä¸åŒ…æ‹¬è¢«æ‰“ä¸Š Taintï¼šNoSchedule çš„èŠ‚ç‚¹ï¼‰ï¼Œ å¹¶å°†æ•°é‡å†™å…¥ /opt/KUSC00402/kusc00402.txt è€ƒç‚¹ï¼š æ£€æŸ¥èŠ‚ç‚¹è§’è‰²æ ‡ç­¾ï¼ŒçŠ¶æ€å±æ€§ï¼Œæ±¡ç‚¹å±æ€§çš„ä½¿ç”¨\nå‚è€ƒé“¾æ¥: æ²¡å¿…è¦å‚è€ƒç½‘å€ï¼Œä½¿ç”¨-h å¸®åŠ©æ›´æ–¹ä¾¿ã€‚\nkubectl -h\nhttps://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/taint-and-toleration/\nè§£ç­”: æ›´æ¢ context 1 $ kubectl config use-context k8s æ£€æŸ¥å°±ç»ª node 1 2 3 4 5 6 7 $ k describe no | grep -i taint Taints: node-role.kubernetes.io/control-plane:NoSchedule Taints: node-role.kubernetes.io/control-plane:NoSchedule Taints: \u0026lt;none\u0026gt; # è€ƒè¯•æ ¹æ®å®é™…ç¯å¢ƒ, è¿™é‡Œæœ‰ 2 ä¸ªèŠ‚ç‚¹è¢«æ‰“ä¸Š NoSchedule $ echo 1 \u0026gt; /opt/KUSC00402/kusc00402.txt æ£€æŸ¥ 1 $ cat /opt/KUSC00402/kusc00402.txt 9ã€åˆ›å»ºå¤šå®¹å™¨çš„ pod é¢˜ç›®: 1 2 3 4 5 6 7 8 9 è®¾ç½®é…ç½®ç¯å¢ƒï¼š [candidate@node-1] $ kubectl config use-context k8s Task æŒ‰å¦‚ä¸‹è¦æ±‚è°ƒåº¦ä¸€ä¸ª Podï¼š åç§°ï¼škucc8 app containers: 2 container åç§°/imagesï¼š âš« nginx âš« consul è€ƒç‚¹ï¼š pod æ¦‚å¿µ\nå‚è€ƒé“¾æ¥: ä¾æ¬¡ç‚¹å‡» Concepts â†’ Workloads â†’ Pods ï¼ˆçœ‹ä¸æ‡‚è‹±æ–‡çš„ï¼Œå¯å³ä¸Šè§’ç¿»è¯‘æˆä¸­æ–‡ï¼‰\nhttps://kubernetes.io/zh-cn/docs/concepts/workloads/pods/\nè§£ç­”: æ›´æ¢ context 1 $ kubectl config use-context k8s åˆ›å»º pod yaml æ²¡æŒ‡å®š namespace å°±æ˜¯ default ä¸ç”¨å¡«\n1 2 3 4 5 6 7 8 9 10 11 12 13 # è·å–ä¸€ä¸ª pod æ¨¡ç‰ˆ $ kubectl run kucc8 --image=nginx --dry-run=client -oyaml \u0026gt; 9.pod.yaml $ cat 9.pod.yaml apiVersion: v1 kind: Pod metadata: name: kucc8 spec: containers: - image: nginx name: nginx - image: cousul name: consul åˆ›å»º pod 1 $ kubectl create -f 9.pod.yaml æ£€æŸ¥ 1 $ kubectl get pod 10ã€åˆ›å»º PV é¢˜ç›®: 1 2 3 4 5 è®¾ç½®é…ç½®ç¯å¢ƒï¼š [candidate@node-1] $ kubectl config use-context hk8s Task åˆ›å»ºåä¸º app-config çš„ persistent volumeï¼Œå®¹é‡ä¸º 1Giï¼Œè®¿é—®æ¨¡å¼ä¸º ReadWriteManyã€‚ volume ç±»å‹ä¸º hostPathï¼Œä½äº /srv/app-config è€ƒç‚¹ï¼š hostPath ç±»å‹çš„ pv\nå‚è€ƒé“¾æ¥: ä¾æ¬¡ç‚¹å‡» Tasks â†’ Configure Pods and Containers â†’ Configure a Pod to Use a PersistentVolume for Storage ï¼ˆçœ‹ä¸æ‡‚è‹±æ–‡çš„ï¼Œå¯å³ä¸Šè§’ç¿»è¯‘æˆä¸­æ–‡ï¼‰\nhttps://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-persistent-volume-storage/\nè§£ç­”: æ›´æ¢ context 1 $ kubectl config use-context hk8s åˆ›å»º pv yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # å¤åˆ¶å®˜ç½‘æ¨¡ç‰ˆ, ä¿®æ”¹ $ cat 10.pv.yaml apiVersion: v1 kind: PersistentVolume metadata: name: app-config # å labels: type: local spec: # storageClassName: manual é¢˜ç›®æ²¡æŒ‡å®š capacity: storage: 1Gi # å®¹é‡ accessModes: - ReadWriteMany # è¯»å†™æƒé™ hostPath: path: \u0026#34;/srv/app-config\u0026#34; # é¢˜ç›®æœ‰æŒ‡å®š åˆ›å»º pv 1 $ kubectl create -f 10.pv.yaml æ£€æŸ¥ 1 $ kubectl describe pv app-config 11ã€åˆ›å»º PVC é¢˜ç›®: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 è®¾ç½®é…ç½®ç¯å¢ƒï¼š [candidate@node-1] $ kubectl config use-context ok8s Task åˆ›å»ºä¸€ä¸ªæ–°çš„ PersistentVolumeClaimï¼š åç§°: pv-volume Class: csi-hostpath-sc å®¹é‡: 10Mi åˆ›å»ºä¸€ä¸ªæ–°çš„ Podï¼Œæ¥å°† PersistentVolumeClaim ä½œä¸º volume è¿›è¡ŒæŒ‚è½½ï¼š åç§°ï¼šweb-server Imageï¼šnginx:1.16 æŒ‚è½½è·¯å¾„ï¼š/usr/share/nginx/html é…ç½®æ–°çš„ Podï¼Œä»¥å¯¹ volume å…·æœ‰ ReadWriteOnce æƒé™ã€‚ æœ€åï¼Œä½¿ç”¨ kubectl edit æˆ– kubectl patch å°† PersistentVolumeClaim çš„å®¹é‡æ‰©å±•ä¸º 70Miï¼Œå¹¶è®°å½•æ­¤æ›´æ”¹ã€‚ è€ƒç‚¹ï¼š pvc çš„åˆ›å»º class å±æ€§çš„ä½¿ç”¨ï¼Œ\u0026ndash;record è®°å½•å˜æ›´\nå‚è€ƒé“¾æ¥: ä¾æ¬¡ç‚¹å‡» Tasks â†’ Configure Pods and Containers â†’ Configure a Pod to Use a PersistentVolume for Storage ï¼ˆçœ‹ä¸æ‡‚è‹±æ–‡çš„ï¼Œå¯å³ä¸Šè§’ç¿»è¯‘æˆä¸­æ–‡ï¼‰\nhttps://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-persistent-volume-storage/\nè§£ç­”: æ›´æ¢ context 1 $ kubectl config use-context ok8s åˆ›å»º pvc 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 # å¤åˆ¶å®˜ç½‘æ¨¡ç‰ˆ, æŒ‰é¢˜ç›®ä¿®æ”¹å“åº”å­—æ®µ $ cat 11.pvc.yaml apiVersion: v1 kind: PersistentVolumeClaim metadata: name: pv-volume spec: storageClassName: csi-hostpath-sc accessModes: - ReadWriteOnce resources: requests: storage: 10Mi $ kubectl create -f 11.pvc.yaml åˆ›å»º pod 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 # è·å– pod æ¨¡ç‰ˆ $ kubectl run web-server --image=nginx:1.16 --dry-run=client -oyaml \u0026gt; 11.pod.yaml $ cat 11.pod.yaml # æŒ‚è½½ pvc apiVersion: v1 kind: Pod metadata: labels: run: web-server name: web-server spec: volumes: - name: 11-pvc persistentVolumeClaim: claimName: pv-volume containers: - image: nginx:1.16 name: web-server volumeMounts: - mountPath: \u0026#34;/usr/share/nginx/html\u0026#34; name: 11-pvc $ kubectl create -f 11.pod.yaml ä¿®æ”¹ pvc å¹¶è®°å½• 1 $ kubectl edit pvc pv-volume --record 12ã€æŸ¥çœ‹ pod æ—¥å¿— é¢˜ç›®: 1 2 3 4 5 6 è®¾ç½®é…ç½®ç¯å¢ƒï¼š [candidate@node-1] $ kubectl config use-context k8s Task ç›‘æ§ pod foo çš„æ—¥å¿—å¹¶ï¼š æå–ä¸é”™è¯¯ RLIMIT_NOFILE ç›¸å¯¹åº”çš„æ—¥å¿—è¡Œ å°†è¿™äº›æ—¥å¿—è¡Œå†™å…¥ /opt/KUTR00101/foo è€ƒç‚¹ï¼š kubectl logs å‘½ä»¤\nå‚è€ƒé“¾æ¥: æ²¡å¿…è¦å‚è€ƒç½‘å€ï¼Œä½¿ç”¨-h å¸®åŠ©æ›´æ–¹ä¾¿ã€‚\nkubectl -h\nhttps://kubernetes.io/docs/tasks/debug/debug-application/debug-running-pod/#examine-pod-logs\nè§£ç­”: 1 $ kubectl logs foo | grep RLIMIT_NOFILE \u0026gt; /opt/KUTR00101/foo æ£€æŸ¥ 1 $ cat /opt/KUTR00101/foo 13ã€ä½¿ç”¨ sidecar ä»£ç†å®¹å™¨æ—¥å¿— é¢˜ç›®: 1 2 3 4 5 6 7 8 9 10 è®¾ç½®é…ç½®ç¯å¢ƒï¼š [candidate@node-1] $ kubectl config use-context k8s Context å°†ä¸€ä¸ªç°æœ‰çš„ Pod é›†æˆåˆ° Kubernetes çš„å†…ç½®æ—¥å¿—è®°å½•ä½“ç³»ç»“æ„ä¸­ï¼ˆä¾‹å¦‚ kubectl logsï¼‰ã€‚ æ·»åŠ  streaming sidecar å®¹å™¨æ˜¯å®ç°æ­¤è¦æ±‚çš„ä¸€ç§å¥½æ–¹æ³•ã€‚ Task ä½¿ç”¨ busybox Image æ¥å°†åä¸º sidecar çš„ sidecar å®¹å™¨æ·»åŠ åˆ°ç°æœ‰çš„ Pod 11-factor-app ä¸­ã€‚ æ–°çš„ sidecar å®¹å™¨å¿…é¡»è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š /bin/sh -c tail -n+1 -f /var/log/11-factor-app.log ä½¿ç”¨æŒ‚è½½åœ¨/var/log çš„ Volumeï¼Œä½¿æ—¥å¿—æ–‡ä»¶ 11-factor-app.log å¯ç”¨äº sidecar å®¹å™¨ã€‚ é™¤äº†æ·»åŠ æ‰€éœ€è¦çš„ volume mount ä»¥å¤–ï¼Œè¯·å‹¿æ›´æ”¹ç°æœ‰å®¹å™¨çš„è§„æ ¼ã€‚ è€ƒé¢˜ç¿»è¯‘æˆç™½è¯ï¼Œå°±æ˜¯ï¼š\næ·»åŠ ä¸€ä¸ªåä¸º sidecar çš„è¾¹è½¦å®¹å™¨(ä½¿ç”¨ busybox é•œåƒ)ï¼ŒåŠ åˆ°å·²æœ‰çš„ pod 11-factor-app ä¸­ã€‚ ç¡®ä¿ sidecar å®¹å™¨èƒ½å¤Ÿè¾“å‡º /var/log/11-factor-app.log çš„ä¿¡æ¯ã€‚\nä½¿ç”¨ volume æŒ‚è½½ /var/log ç›®å½•ï¼Œç¡®ä¿ sidecar èƒ½è®¿é—® 11-factor-app.log æ–‡ä»¶\nè€ƒç‚¹ï¼š pod ä¸¤ä¸ªå®¹å™¨å…±äº«å­˜å‚¨å·\nå‚è€ƒé“¾æ¥: ï¼ˆéœ€è¦å¤åˆ¶ç½‘é¡µå†…å®¹ï¼‰\nä¾æ¬¡ç‚¹å‡» Concepts â†’ Cluster Administration â†’ Logging Architecture ï¼ˆçœ‹ä¸æ‡‚è‹±æ–‡çš„ï¼Œå¯å³ä¸Šè§’ç¿»è¯‘æˆä¸­æ–‡ï¼‰\nhttps://kubernetes.io/zh-cn/docs/concepts/cluster-administration/logging/\nè§£ç­”: æ›´æ¢ context 1 $ kubectl config use-context k8s è·å– pod yaml 1 2 3 $ kubectl get pod 11-factor-app -o yaml \u0026gt; varlog.yaml # å¤‡ä»½ yaml æ–‡ä»¶ï¼Œé˜²æ­¢æ”¹é”™äº†ï¼Œå›é€€ã€‚ $ cp varlog.yaml varlog-bak.yaml ä¿®æ”¹ yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 spec: ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ volumeMounts: #åœ¨åŸé…ç½®æ–‡ä»¶ï¼Œç°è‰²çš„è¿™æ®µåé¢æ·»åŠ  - mountPath: /var/run/secrets/kubernetes.io/serviceaccount name: default-token-4l6w8 readOnly: true - name: varlog #æ–°åŠ å†…å®¹ mountPath: /var/log #æ–°åŠ å†…å®¹ - name: sidecar #æ–°åŠ å†…å®¹ï¼Œæ³¨æ„ name åˆ«å†™é”™äº† image: busybox #æ–°åŠ å†…å®¹ args: [/bin/sh, -c, \u0026#39;tail -n+1 -f /var/log/11-factor-app.log\u0026#39;] #æ–°åŠ å†…å®¹ï¼Œæ³¨æ„ æ–‡ä»¶å åˆ«å†™é”™äº†ã€‚å¦å¤–æ˜¯ç”¨é€—å·åˆ†éš”çš„ï¼Œè€Œé¢˜ç›®é‡Œæ˜¯ç©ºæ ¼ã€‚ volumeMounts: #æ–°åŠ å†…å®¹ - name: varlog #æ–°åŠ å†…å®¹ mountPath: /var/log #æ–°åŠ å†…å®¹ dnsPolicy: ClusterFirst enableServiceLinks: true ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ volumes: #åœ¨åŸé…ç½®æ–‡ä»¶ï¼Œç°è‰²çš„è¿™æ®µåé¢æ·»åŠ ã€‚ - name: kube-api-access-kcjc2 projected: defaultMode: 420 sources: - serviceAccountToken: expirationSeconds: 3607 path: token - configMap: items: - key: ca.crt path: ca.crt name: kube-root-ca.crt - downwardAPI: items: - fieldRef: apiVersion: v1 fieldPath: metadata.namespace path: namespace - name: varlog #æ–°åŠ å†…å®¹ï¼Œæ³¨æ„æ‰¾å¥½ä½ç½®ã€‚ emptyDir: {} #æ–°åŠ å†…å®¹ åˆ›å»º pod 1 2 3 $ kubectl delete -f varlog.yaml $ kubectl createe -f varlog.yaml æ£€æŸ¥ 1 2 $ kubectl exec 11-factor-app -c sidecar -- tail -f /var/log/11-factor-app.log $ kubectl exec 11-factor-app -c count -- tail -f /var/log/11-factor-app.log 14ã€å‡çº§é›†ç¾¤ é¢˜ç›®: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 è®¾ç½®é…ç½®ç¯å¢ƒï¼š [candidate@node-1] $ kubectl config use-context mk8s Task ç°æœ‰çš„ Kubernetes é›†ç¾¤æ­£åœ¨è¿è¡Œç‰ˆæœ¬ 1.28.0ã€‚ä»…å°† master èŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰ Kubernetes æ§åˆ¶å¹³é¢å’ŒèŠ‚ç‚¹ç»„ä»¶å‡çº§åˆ°ç‰ˆæœ¬ 1.28.1ã€‚ ç¡®ä¿åœ¨å‡çº§ä¹‹å‰ drain master èŠ‚ç‚¹ï¼Œå¹¶åœ¨å‡çº§å uncordon master èŠ‚ç‚¹ã€‚ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼Œé€šè¿‡ ssh è¿æ¥åˆ° master èŠ‚ç‚¹ï¼š ssh master01 å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼Œåœ¨è¯¥ master èŠ‚ç‚¹ä¸Šè·å–æ›´é«˜æƒé™ï¼š sudo -i å¦å¤–ï¼Œåœ¨ä¸»èŠ‚ç‚¹ä¸Šå‡çº§ kubelet å’Œ kubectlã€‚ è¯·ä¸è¦å‡çº§å·¥ä½œèŠ‚ç‚¹ï¼Œetcdï¼Œcontainer ç®¡ç†å™¨ï¼ŒCNI æ’ä»¶ï¼Œ DNS æœåŠ¡æˆ–ä»»ä½•å…¶ä»–æ’ä»¶ã€‚ è€ƒç‚¹ï¼š å¦‚ä½•ç¦»çº¿ä¸»æœºï¼Œå¹¶å‡çº§æ§åˆ¶é¢æ¿å’Œå‡çº§èŠ‚ç‚¹\nå‚è€ƒé“¾æ¥: æ²¡å¿…è¦å‚è€ƒç½‘å€ï¼Œå»ºè®®å¤šç»ƒä¹ ï¼ŒèƒŒè¿‡å‘½ä»¤å°±è¡Œã€‚\nè®°ä¸æ¸…çš„ï¼Œå¯ä»¥ä½¿ç”¨ kubectl -h æ¥å¸®åŠ©ã€‚\nå¦‚æœéè¦å‚è€ƒï¼Œå¯ä»¥æŒ‰ç…§ä¸‹é¢æ–¹æ³•ã€‚\nä¾æ¬¡ç‚¹å‡» Tasks â†’ Administer a Cluster â†’ Administration with kubeadm â†’ Upgrading kubeadm clusters ï¼ˆçœ‹ä¸æ‡‚è‹±æ–‡çš„ï¼Œå¯å³ä¸Šè§’ç¿»è¯‘æˆä¸­æ–‡ï¼‰\nhttps://kubernetes.io/zh-cn/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/\nè§£ç­”: æ›´æ¢ context 1 $ kubectl config use-context mk8s ssh åˆ° master01 1 2 $ ssh master01 $ sudo -i æ’ç©ºèŠ‚ç‚¹ 1 2 $ kubectl cordon master $ kubectl drain master å‡çº§ kubeadm 1 2 3 4 5 6 7 8 $ apt update $ apt-cache madison kubeadm | grep 1.28.1 # apt å‡çº§ kubeadm $ apt-get install kubeadm=1.28.1-00 -y # kubeadm å‡çº§é›†ç¾¤, æ³¨æ„ä¸è¦å‡çº§ etcd, å¿˜è®°æ€ä¹ˆå†™, å¯ä»¥ -h $ kubeadm upgrade apply 1.28.1 --etcd-upgrade=false å‡çº§ kubectl, kubelet 1 $ apt-get install kubectl=1.28.1-00 kubelet=1.28.1-00 -y æ£€æŸ¥ 1 2 3 4 5 6 7 8 9 10 $ kubeadm version $ kubectl version $ kubelet --version # è®°å¾—ä½¿èŠ‚ç‚¹å¯é‡æ–°è°ƒåº¦ $ kubectl uncordon master01 $ exit # é€€åˆ° node01 15ã€å¤‡ä»½è¿˜åŸ etcd é¢˜ç›®: 1 2 3 4 5 6 7 8 9 10 11 12 è®¾ç½®é…ç½®ç¯å¢ƒ æ­¤é¡¹ç›®æ— éœ€æ›´æ”¹é…ç½®ç¯å¢ƒã€‚ä½†æ˜¯ï¼Œåœ¨æ‰§è¡Œæ­¤é¡¹ç›®ä¹‹å‰ï¼Œè¯·ç¡®ä¿æ‚¨å·²è¿”å›åˆå§‹èŠ‚ç‚¹ã€‚ [candidate@master01] $ exit #æ³¨æ„ï¼Œè¿™ä¸ªä¹‹å‰æ˜¯åœ¨ master01 ä¸Šï¼Œæ‰€ä»¥è¦ exit é€€åˆ° node01ï¼Œå¦‚æœå·²ç»æ˜¯ node01 äº†ï¼Œå°±ä¸è¦å† exit äº†ã€‚ Task é¦–å…ˆï¼Œä¸ºè¿è¡Œåœ¨ https://127.0.0.1:2379 ä¸Šçš„ç°æœ‰ etcd å®ä¾‹åˆ›å»ºå¿«ç…§å¹¶å°†å¿«ç…§ä¿å­˜åˆ° /var/lib/backup/etcd-snapshot.db ä¸ºç»™å®šå®ä¾‹åˆ›å»ºå¿«ç…§é¢„è®¡èƒ½åœ¨å‡ ç§’é’Ÿå†…å®Œæˆã€‚ å¦‚æœè¯¥æ“ä½œä¼¼ä¹æŒ‚èµ·ï¼Œåˆ™å‘½ä»¤å¯èƒ½æœ‰é—®é¢˜ã€‚ç”¨ CTRL + C æ¥å–æ¶ˆæ“ä½œï¼Œç„¶åé‡è¯•ã€‚ ç„¶åè¿˜åŸä½äº/data/backup/etcd-snapshot-previous.db çš„ç°æœ‰å…ˆå‰å¿«ç…§ã€‚ æä¾›äº†ä»¥ä¸‹ TLS è¯ä¹¦å’Œå¯†é’¥ï¼Œä»¥é€šè¿‡ etcdctl è¿æ¥åˆ°æœåŠ¡å™¨ã€‚ CA è¯ä¹¦: /opt/KUIN00601/ca.crt å®¢æˆ·ç«¯è¯ä¹¦: /opt/KUIN00601/etcd-client.crt å®¢æˆ·ç«¯å¯†é’¥: /opt/KUIN00601/etcd-client.key è€ƒç‚¹ï¼š etcd çš„å¤‡ä»½å’Œè¿˜åŸå‘½ä»¤\nå‚è€ƒé“¾æ¥: æ²¡å¿…è¦å‚è€ƒç½‘å€ï¼Œå»ºè®®å¤šç»ƒä¹ ï¼ŒèƒŒè¿‡å‘½ä»¤å°±è¡Œã€‚\nè®°ä¸æ¸…çš„ï¼Œå¯ä»¥ä½¿ç”¨ etcdctl -h æ¥å¸®åŠ©ï¼Œæ›´æ–¹ä¾¿ã€‚\nå¦‚æœéè¦å‚è€ƒï¼Œå¯ä»¥æŒ‰ç…§ä¸‹é¢æ–¹æ³•ã€‚\nä¾æ¬¡ç‚¹å‡» Tasks â†’ Administer a Cluster â†’ Operating etcd clusters for Kubernetes ï¼ˆçœ‹ä¸æ‡‚è‹±æ–‡çš„ï¼Œå¯å³ä¸Šè§’ç¿»è¯‘æˆä¸­æ–‡ï¼‰\nhttps://kubernetes.io/zh-cn/docs/tasks/administer-cluster/configure-upgrade-etcd/\nè§£ç­”: æ³¨æ„:\nè®°å¾—è®¾ç½® ETCDCTL_API=3 å¦‚æœæ–‡ä»¶æ²¡æƒé™, å°± sudo -i å¤‡ä»½å¿«ç…§ 1 $ sudo ETCDCTL_API=3 etcdctl --endpoints=https://127.0.0.1:2379 --cacert=/opt/KUIN00601/ca.crt --cert=/opt/KUIN00601/etcd-client.crt --key=/opt/KUIN00601/etcd-client.key snapshot save /var/lib/backup/etcd-snapshot.db æ¢å¤å¿«ç…§ 1 $ sudo ETCDCTL_API=3 etcdctl --endpoints=https://127.0.0.1:2379 --cacert=/opt/KUIN00601/ca.crt --cert=/opt/KUIN00601/etcd-client.crt --key=/opt/KUIN00601/etcd-client.key snapshot restore /data/backup/etcd-snapshot-previous.db æ£€æŸ¥ 1 2 # æ²¡å¿…è¦ $ etcdctl snapshot status /var/lib/backup/etcd-snapshot.db -wtable 16ã€æ’æŸ¥é›†ç¾¤ä¸­æ•…éšœèŠ‚ç‚¹ é¢˜ç›®: 1 2 3 4 5 6 7 8 9 10 11 è®¾ç½®é…ç½®ç¯å¢ƒï¼š [candidate@node-1] $ kubectl config use-context wk8s Task åä¸º node02 çš„ Kubernetes worker node å¤„äº NotReady çŠ¶æ€ã€‚ è°ƒæŸ¥å‘ç”Ÿè¿™ç§æƒ…å†µçš„åŸå› ï¼Œå¹¶é‡‡å–ç›¸åº”çš„æªæ–½å°† node æ¢å¤ä¸º Ready çŠ¶æ€ï¼Œç¡®ä¿æ‰€åšçš„ä»»ä½•æ›´æ”¹æ°¸ä¹…ç”Ÿæ•ˆã€‚ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼Œé€šè¿‡ ssh è¿æ¥åˆ° node02 èŠ‚ç‚¹ï¼š ssh node02 å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼Œåœ¨è¯¥èŠ‚ç‚¹ä¸Šè·å–æ›´é«˜æƒé™ï¼š sudo -i å‚è€ƒé“¾æ¥: æ²¡å¿…è¦å‚è€ƒç½‘å€ï¼Œè®°ä½å…ˆ restart å† enable å°±è¡Œã€‚\nhttps://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/kubelet-integration/\nè§£ç­”: æ›´æ¢ context 1 $ kubectl config use-context wk8s ssh åˆ° node02 æŸ¥çœ‹ kubelet 1 2 3 4 5 6 7 $ ssh node02 $ sudo -i # root # æŸ¥çœ‹ kubelet çŠ¶æ€ $ systemctl status kubelet $ systemctl restart kubelet \u0026amp;\u0026amp; systemctl enable kubelet æ£€æŸ¥ 1 2 3 4 5 $ systemctl status kubelet # è€ƒè¯•æ—¶è®°å¾—ä» node2 é€€å›åˆ° node1 $ exit $ exit 17ã€èŠ‚ç‚¹ç»´æŠ¤ é¢˜ç›®: 1 2 3 4 5 è®¾ç½®é…ç½®ç¯å¢ƒï¼š [candidate@node-1] $ kubectl config use-context ek8s Task å°†åä¸º node02 çš„ node è®¾ç½®ä¸ºä¸å¯ç”¨ï¼Œå¹¶é‡æ–°è°ƒåº¦è¯¥ node ä¸Šæ‰€æœ‰è¿è¡Œçš„ podsã€‚ è€ƒç‚¹ï¼š cordon å’Œ drain å‘½ä»¤çš„ä½¿ç”¨\nå‚è€ƒé“¾æ¥: æ²¡å¿…è¦å‚è€ƒç½‘å€ï¼Œä½¿ç”¨-h å¸®åŠ©æ›´æ–¹ä¾¿ã€‚\nkubectl -h\nhttps://kubernetes.io/zh-cn/docs/tasks/administer-cluster/safely-drain-node/\nè§£ç­”: æ›´æ¢ context 1 $ kubectl config use-context ek8s æ’ç©ºèŠ‚ç‚¹ 1 2 3 $ kubectl cordon node02 $ kubectl drain node02 ","date":"2024-01-02T17:50:40+08:00","image":"https://blog-source-mkt.oss-cn-chengdu.aliyuncs.com/blog_source/public/kubernetes/cka%20%26%20cks/cert.png","permalink":"/p/2024-cka-%E9%A2%98%E5%BA%93/","title":"2024 CKA é¢˜åº“"},{"content":" æºç åœ°å€: https://github.com/Ai-feier/gracefulshutdown\næ€è€ƒä¼˜é›…ç»ˆæ­¢ç›®æ ‡ åº”ç”¨å¼€å§‹å…³é—­æ—¶, å¯¹äºæœåŠ¡å™¨çš„è¿æ¥ å¯¹å·²æœ‰è¿æ¥: ç­‰å¾…å…¶å¤„ç† æ‹’ç»æ–°è¯·æ±‚ æ˜¯å¦éœ€è¦å°† cache ä¸­æ•°æ®ä¿å­˜åˆ° db é‡Šæ”¾æœåŠ¡å™¨èµ„æº å¯¹è±¡å…³ç³»å›¾ åº”ç”¨å¯åŠ¨: ä¼˜é›…ç»ˆæ­¢: ä¼˜é›…çš„ä¼˜é›…ç»ˆæ­¢å®ç° éœ€ç›‘å¬çš„ä¿¡å·é‡ windows 1 2 3 4 5 var Signals = []os.Signal{ os.Interrupt, os.Kill, syscall.SIGKILL, syscall.SIGHUP, syscall.SIGINT, syscall.SIGQUIT, syscall.SIGILL, syscall.SIGTRAP, syscall.SIGABRT, syscall.SIGTERM, } linux 1 2 3 4 5 var Signals = []os.Signal{ os.Interrupt, os.Kill, syscall.SIGKILL, syscall.SIGSTOP, syscall.SIGHUP, syscall.SIGINT, syscall.SIGQUIT, syscall.SIGILL, syscall.SIGTRAP, syscall.SIGABRT, syscall.SIGSYS, syscall.SIGTERM, } Server ä¸€ä¸ª server å¯¹åº”ä¸€ä¸ª service\nå®šä¹‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 // Server å¯¹åº”ä¸€ä¸ªæœåŠ¡ type Server struct { svc *http.Server name string mux *serverMux } // serverMux è¯·æ±‚é” // è£…é¥°å™¨æ¨¡å¼ type serverMux struct { reject bool *http.ServeMux } å…¶ä¸­ä½¿ç”¨ http.ServeMux æ˜¯ä¸ºç¡®ä¿ä¸€ä¸ª server, åªèƒ½æŒæœ‰ä¸€ä¸ªæ­£åœ¨å¤„ç†çš„ request\nnew ä¼ å…¥ server åå­—, ç›‘å¬åœ°å€\n1 2 3 4 5 6 7 8 9 10 11 func NewServer(name, addr string) *Server { mux := \u0026amp;serverMux{ServeMux: http.NewServeMux()} return \u0026amp;Server{ name: name, mux: mux, svc: \u0026amp;http.Server{ Handler: mux, Addr: addr, }, } } server çš„å¯åŠ¨ä¸ç»ˆæ­¢ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 func (s *Server) Start() error { return s.svc.ListenAndServe() } func (s *Server) Handle(pattern string, handler http.HandlerFunc) { s.mux.Handle(pattern, handler) } func (s *Server) reject() { s.mux.reject = true } func (s *Server) stop(ctx context.Context) error { log.Println(\u0026#34;server: \u0026#34;, s.name, \u0026#34;å…³é—­ä¸­\u0026#34;) return s.svc.Shutdown(ctx) } App å®šä¹‰ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // æ‰©å±• App (option è®¾è®¡æ¨¡å¼) type AppOption func(app *App) type App struct { servers []*Server // app å…³é—­çš„æœ€é•¿æ—¶é—´ shutdownTimeout time.Duration // ç•™ç»™ server å¤„ç†å·²æœ‰è¯·æ±‚çš„æ—¶é—´ waitTime time.Duration // å›è°ƒå‡½æ•°è¶…æ—¶æ§åˆ¶ cbTime time.Duration cbs []ShutdownCallBack } new 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 // NewApp æ–°å»º App // éœ€ç”¨æˆ·ä¼ å…¥ server func NewApp(servers []*Server, opts ...AppOption) *App { app := \u0026amp;App{ servers: servers, shutdownTimeout: time.Second * 30, waitTime: time.Second * 10, cbTime: 3 * time.Second, } for _, opt := range opts { opt(app) } return app } // WithShutDownCallBack å‘ App ä¼ å…¥ callback å‡½æ•° func WithShutDownCallBack(cbs ...ShutdownCallBack) AppOption { return func(app *App) { app.cbs = cbs } } app å¯åŠ¨ä¸ä¼˜é›…ç»ˆæ­¢ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 func (app *App) StartAndServer() { // å¯åŠ¨æœåŠ¡ for _, s := range app.servers { svc := s go func() { if err := svc.Start(); err != nil { if errors.Is(err, http.ErrServerClosed) { log.Printf(\u0026#34;æœåŠ¡å™¨%så·²å…³é—­\u0026#34;, svc.name) } else { log.Printf(\u0026#34;æœåŠ¡å™¨%så¼‚å¸¸é€€å‡º\u0026#34;, svc.name) } } }() } log.Println(\u0026#34;åº”ç”¨å¯åŠ¨æˆåŠŸ\u0026#34;) // app å¯åŠ¨æˆåŠŸ // ç›‘å¬é€€å‡ºä¿¡å· // ç›‘å¬ä¸¤æ¬¡ä¿¡å·, ç¬¬ä¸€æ¬¡ä¼˜é›…ç»ˆæ­¢, ç¬¬äºŒæ¬¡å¼ºè¡Œç»ˆæ­¢ ch := make(chan os.Signal, 2) signal.Notify(ch, sig.Signals...) \u0026lt;-ch fmt.Println(\u0026#34;åº”ç”¨å¼€å§‹å…³é—­...\u0026#34;) go func() { select { case \u0026lt;-ch: log.Println(\u0026#34;å¼ºåˆ¶é€€å‡º\u0026#34;) os.Exit(1) case \u0026lt;-time.After(app.shutdownTimeout): log.Println(\u0026#34;è¶…æ—¶å¼ºè¡Œé€€å‡º\u0026#34;) os.Exit(1) } }() app.shutdown(context.Background()) } func (app *App) shutdown(ctx context.Context) { log.Println(\u0026#34;app start to shutdown\u0026#34;) // å°† app ä¸‹æ‰€æœ‰ server æ‹’ç»æ–°è¯·æ±‚ for _, svc := range app.servers { svc.reject() } log.Println(\u0026#34;ç­‰å¾…å·²æœ‰è¯·æ±‚å¤„ç†\u0026#34;) // è¿™é‡Œå¯ä»¥æ”¹é€ ä¸ºå®æ—¶ç»Ÿè®¡æ­£åœ¨å¤„ç†çš„è¯·æ±‚æ•°é‡ï¼Œä¸º0 åˆ™ä¸‹ä¸€æ­¥ time.Sleep(time.Second * app.waitTime) log.Println(\u0026#34;å¼€å§‹å…³é—­åº”ç”¨\u0026#34;) var wg sync.WaitGroup wg.Add(len(app.servers)) for _, s := range app.servers { svc := s go func() { if err := svc.stop(ctx);err != nil { log.Println(\u0026#34;æœåŠ¡å™¨å…³é—­å¤±è´¥\u0026#34;, svc.name) } wg.Done() }() } wg.Wait() // æ‰§è¡Œå›è°ƒå‡½æ•° wg.Add(len(app.cbs)) log.Println(\u0026#34;å¼€å§‹æ‰§è¡Œå›è°ƒå‡½æ•°\u0026#34;) for _, cb := range app.cbs { c := cb go func() { ctx2, cancal := context.WithCancel(ctx) c(ctx2) cancal() wg.Done() }() } wg.Wait() // é‡Šæ”¾èµ„æº log.Println(\u0026#34;å¼€å§‹é‡Šæ”¾èµ„æº\u0026#34;) app.close() } CallBackFunc æ‰§è¡Œæ—¶é—´: åœ¨ä¼˜é›…ç»ˆæ­¢æœŸé—´ app ç¡®ä¿æ‰€æœ‰ server å·²å…³é—­åè°ƒç”¨\nç”±ç”¨æˆ·è‡ªå®šä¹‰å®ç°\nç¤ºä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 func StoreCacheToDBCallBack(ctx context.Context) { done := make(chan struct{}, 1) go func() { // è¿™é‡Œå°† cache ä¸­æ•°æ®åˆ·åˆ° db log.Println(\u0026#34;ç¼“å­˜åˆ·æ–°ä¸­...\u0026#34;) time.Sleep(time.Second) done \u0026lt;- struct{}{} }() select { case \u0026lt;-done: log.Printf(\u0026#34;ç¼“å­˜è¢«åˆ·æ–°åˆ°äº† DB\u0026#34;) case \u0026lt;-ctx.Done(): log.Printf(\u0026#34;åˆ·æ–°ç¼“å­˜è¶…æ—¶\u0026#34;) } } å®Œæ•´ä»£ç  main.go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 package main import ( \u0026#34;context\u0026#34; \u0026#34;github.com/Ai-feier/http/server\u0026#34; \u0026#34;log\u0026#34; \u0026#34;net/http\u0026#34; \u0026#34;time\u0026#34; ) func main() { // æ–°å»ºä¸¤ä¸ª server s1 := server.NewServer(\u0026#34;service1\u0026#34;, \u0026#34;localhost:8081\u0026#34;) s1.Handle(\u0026#34;/\u0026#34;, func(writer http.ResponseWriter, request *http.Request) { _, _ = writer.Write([]byte(\u0026#34;hello world\u0026#34;)) }) s2 := server.NewServer(\u0026#34;service2\u0026#34;, \u0026#34;localhost:8082\u0026#34;) // æ–°å»ºåº”ç”¨, åŒ…å« service1, service2 app := server.NewApp([]*server.Server{s1, s2}, server.WithShutDownCallBack(StoreCacheToDBCallBack)) app.StartAndServer() } func StoreCacheToDBCallBack(ctx context.Context) { done := make(chan struct{}, 1) go func() { // è¿™é‡Œå°† cache ä¸­æ•°æ®åˆ·åˆ° db log.Println(\u0026#34;ç¼“å­˜åˆ·æ–°ä¸­...\u0026#34;) time.Sleep(time.Second) done \u0026lt;- struct{}{} }() select { case \u0026lt;-done: log.Printf(\u0026#34;ç¼“å­˜è¢«åˆ·æ–°åˆ°äº† DB\u0026#34;) case \u0026lt;-ctx.Done(): log.Printf(\u0026#34;åˆ·æ–°ç¼“å­˜è¶…æ—¶\u0026#34;) } } server.go 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 package server import ( \u0026#34;context\u0026#34; \u0026#34;errors\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;github.com/Ai-feier/sig\u0026#34; \u0026#34;log\u0026#34; \u0026#34;net/http\u0026#34; \u0026#34;os\u0026#34; \u0026#34;os/signal\u0026#34; \u0026#34;sync\u0026#34; \u0026#34;time\u0026#34; ) type AppOption func(app *App) // ShutdownCallBack App å…³é—­æ—¶çš„å›è°ƒå‡½æ•° // é»˜è®¤è¶…æ—¶ 3s // ç”¨æˆ·å¯é€šè¿‡ context è‡ªè¡Œæ§åˆ¶ type ShutdownCallBack func(ctx context.Context) // WithShutDownCallBack å‘ App ä¼ å…¥ callback å‡½æ•° func WithShutDownCallBack(cbs ...ShutdownCallBack) AppOption { return func(app *App) { app.cbs = cbs } } type App struct { servers []*Server // app å…³é—­çš„æœ€é•¿æ—¶é—´ shutdownTimeout time.Duration // ç•™ç»™ server å¤„ç†å·²æœ‰è¯·æ±‚çš„æ—¶é—´ waitTime time.Duration // å›è°ƒå‡½æ•°è¶…æ—¶æ§åˆ¶ cbTime time.Duration cbs []ShutdownCallBack } // NewApp æ–°å»º App // éœ€ç”¨æˆ·ä¼ å…¥ server func NewApp(servers []*Server, opts ...AppOption) *App { app := \u0026amp;App{ servers: servers, shutdownTimeout: time.Second * 30, waitTime: time.Second * 10, cbTime: 3 * time.Second, } for _, opt := range opts { opt(app) } return app } func (app *App) StartAndServer() { // å¯åŠ¨æœåŠ¡ for _, s := range app.servers { svc := s go func() { if err := svc.Start(); err != nil { if errors.Is(err, http.ErrServerClosed) { log.Printf(\u0026#34;æœåŠ¡å™¨%så·²å…³é—­\u0026#34;, svc.name) } else { log.Printf(\u0026#34;æœåŠ¡å™¨%så¼‚å¸¸é€€å‡º\u0026#34;, svc.name) } } }() } log.Println(\u0026#34;åº”ç”¨å¯åŠ¨æˆåŠŸ\u0026#34;) // app å¯åŠ¨æˆåŠŸ // ç›‘å¬é€€å‡ºä¿¡å· // ç›‘å¬ä¸¤æ¬¡ä¿¡å·, ç¬¬ä¸€æ¬¡ä¼˜é›…ç»ˆæ­¢, ç¬¬äºŒæ¬¡å¼ºè¡Œç»ˆæ­¢ ch := make(chan os.Signal, 2) signal.Notify(ch, sig.Signals...) \u0026lt;-ch fmt.Println(\u0026#34;åº”ç”¨å¼€å§‹å…³é—­...\u0026#34;) go func() { select { case \u0026lt;-ch: log.Println(\u0026#34;å¼ºåˆ¶é€€å‡º\u0026#34;) os.Exit(1) case \u0026lt;-time.After(app.shutdownTimeout): log.Println(\u0026#34;è¶…æ—¶å¼ºè¡Œé€€å‡º\u0026#34;) os.Exit(1) } }() app.shutdown(context.Background()) } func (app *App) shutdown(ctx context.Context) { log.Println(\u0026#34;app start to shutdown\u0026#34;) // å°† app ä¸‹æ‰€æœ‰ server æ‹’ç»æ–°è¯·æ±‚ for _, svc := range app.servers { svc.reject() } log.Println(\u0026#34;ç­‰å¾…å·²æœ‰è¯·æ±‚å¤„ç†\u0026#34;) // è¿™é‡Œå¯ä»¥æ”¹é€ ä¸ºå®æ—¶ç»Ÿè®¡æ­£åœ¨å¤„ç†çš„è¯·æ±‚æ•°é‡ï¼Œä¸º0 åˆ™ä¸‹ä¸€æ­¥ time.Sleep(time.Second * app.waitTime) log.Println(\u0026#34;å¼€å§‹å…³é—­åº”ç”¨\u0026#34;) var wg sync.WaitGroup wg.Add(len(app.servers)) for _, s := range app.servers { svc := s go func() { if err := svc.stop(ctx);err != nil { log.Println(\u0026#34;æœåŠ¡å™¨å…³é—­å¤±è´¥\u0026#34;, svc.name) } wg.Done() }() } wg.Wait() // æ‰§è¡Œå›è°ƒå‡½æ•° wg.Add(len(app.cbs)) log.Println(\u0026#34;å¼€å§‹æ‰§è¡Œå›è°ƒå‡½æ•°\u0026#34;) for _, cb := range app.cbs { c := cb go func() { ctx2, cancal := context.WithCancel(ctx) c(ctx2) cancal() wg.Done() }() } wg.Wait() // é‡Šæ”¾èµ„æº log.Println(\u0026#34;å¼€å§‹é‡Šæ”¾èµ„æº\u0026#34;) app.close() } func (app *App) close() { // å¯è¡¥å……é‡Šæ”¾èµ„æºé€»è¾‘ time.Sleep(time.Second) log.Println(\u0026#34;åº”ç”¨å…³é—­\u0026#34;) } // Server å¯¹åº”ä¸€ä¸ªæœåŠ¡ type Server struct { svc *http.Server name string mux *serverMux } // serverMux è¯·æ±‚é” //è£…é¥°å™¨æ¨¡å¼ type serverMux struct { reject bool *http.ServeMux } func (s *serverMux) ServeHTTP(w http.ResponseWriter, r *http.Request) { if s.reject { w.WriteHeader(http.StatusInternalServerError) _, _ = w.Write([]byte(\u0026#34;æœåŠ¡å™¨å·²å…³é—­\u0026#34;)) return } s.ServeMux.ServeHTTP(w, r) } func NewServer(name, addr string) *Server { mux := \u0026amp;serverMux{ServeMux: http.NewServeMux()} return \u0026amp;Server{ name: name, mux: mux, svc: \u0026amp;http.Server{ Handler: mux, Addr: addr, }, } } func (s *Server) Start() error { return s.svc.ListenAndServe() } func (s *Server) Handle(pattern string, handler http.HandlerFunc) { s.mux.Handle(pattern, handler) } func (s *Server) reject() { s.mux.reject = true } func (s *Server) stop(ctx context.Context) error { log.Println(\u0026#34;server: \u0026#34;, s.name, \u0026#34;å…³é—­ä¸­\u0026#34;) return s.svc.Shutdown(ctx) } æ•ˆæœæ¼”ç¤º 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 C:\\Users\\26645\\Desktop\\goproject\\gracefulshutdown\\http\u0026gt;go build . C:\\Users\\26645\\Desktop\\goproject\\gracefulshutdown\\http\u0026gt;http.exe 2024/01/02 15:32:08 åº”ç”¨å¯åŠ¨æˆåŠŸ åº”ç”¨å¼€å§‹å…³é—­... 2024/01/02 15:32:10 app start to shutdown 2024/01/02 15:32:10 ç­‰å¾…å·²æœ‰è¯·æ±‚å¤„ç† 2024/01/02 15:32:10 å¼€å§‹å…³é—­åº”ç”¨ 2024/01/02 15:32:10 server: service2 å…³é—­ä¸­ 2024/01/02 15:32:10 server: service1 å…³é—­ä¸­ 2024/01/02 15:32:10 æœåŠ¡å™¨service2å·²å…³é—­ 2024/01/02 15:32:10 æœåŠ¡å™¨service1å·²å…³é—­ 2024/01/02 15:32:10 å¼€å§‹æ‰§è¡Œå›è°ƒå‡½æ•° 2024/01/02 15:32:10 ç¼“å­˜åˆ·æ–°ä¸­... 2024/01/02 15:32:11 ç¼“å­˜è¢«åˆ·æ–°åˆ°äº† DB 2024/01/02 15:32:11 å¼€å§‹é‡Šæ”¾èµ„æº 2024/01/02 15:32:12 åº”ç”¨å…³é—­ ","date":"2024-01-02T16:57:31+08:00","image":"https://blog-source-mkt.oss-cn-chengdu.aliyuncs.com/blog_source/post/images/%E4%BC%98%E9%9B%85%E7%BB%88%E6%AD%A2.http/image-20240102163454049.png","permalink":"/p/%E4%BC%98%E9%9B%85%E7%BB%88%E6%AD%A2-%E5%9F%BA%E4%BA%8E-go-%E7%9A%84-http-%E5%BA%93%E5%AE%9E%E7%8E%B0/","title":"ä¼˜é›…ç»ˆæ­¢ | åŸºäº go çš„ http åº“å®ç°"},{"content":"k8s é›†ç¾¤é…ç½® IP Host é…ç½® 11.0.1.150 master1 (keepalived+haproxy) 2C 4G 30G 11.0.1.148 master2 (keepalived+haproxy) 2C 4G 30G 11.0.1.149 node1 2C 4G 30G vip åœ°å€: https://11.0.1.100:16443\nè®¤è¯† kubeconfig kubeconfig å³ä¸º kubectl ç”¨äºç®¡ç† k8s é›†ç¾¤çš„é…ç½®æ–‡ä»¶\nå…³ç³»å›¾è§£\ncurrent-context é€‰æ‹© context æ“ä½œç›¸åº”é›†ç¾¤ context å°† user ä¸ cluster è”ç³»èµ·æ¥ user æä¾›è¦æ“ä½œé›†ç¾¤çš„ cert ä¸ key cluster æä¾›é›†ç¾¤çš„ ca ä¸ é›†ç¾¤çš„å…¥å£åœ°å€ user ä¸ cluster æ˜¯å¼±å…³è”\nkubectl config å‚æ•°è¯¦è§£ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 $ kubectl config --help Available Commands: current-context æ˜¾ç¤ºå½“å‰ä¸Šä¸‹æ–‡ delete-cluster åˆ é™¤kubeconfigæ–‡ä»¶ä¸­æŒ‡å®šçš„é›†ç¾¤ delete-context åˆ é™¤kubeconfigæ–‡ä»¶ä¸­æŒ‡å®šçš„context delete-user åˆ é™¤kubeconfigæ–‡ä»¶ä¸­æŒ‡å®šçš„user get-clusters æ˜¾ç¤ºkubeconfigæ–‡ä»¶ä¸­å®šä¹‰çš„é›†ç¾¤ get-contexts æ˜¾ç¤ºä¸€ä¸ªæˆ–å¤šä¸ªcontexts get-users æ˜¾ç¤ºkubeconfigæ–‡ä»¶ä¸­å®šä¹‰çš„users rename-context é‡å‘½åkubeconfigæ–‡ä»¶é‡Œçš„context set åœ¨kubecconfigæ–‡ä»¶ä¸­è®¾ç½®ä¸€ä¸ªå•ç‹¬çš„å€¼ set-cluster åœ¨kubecconfigä¸­è®¾ç½®é›†ç¾¤æ¡ç›® set-context åœ¨kubecconfigä¸­è®¾ç½®ä¸Šä¸‹æ–‡æ¡ç›® set-credentials åœ¨kubecconfigä¸­è®¾ç½®ä¸€ä¸ªç”¨æˆ·æ¡ç›® unset å–æ¶ˆkubecconfigæ–‡ä»¶ä¸­å•ä¸ªå€¼çš„è®¾ç½® use-context åœ¨kubecconfigæ–‡ä»¶ä¸­è®¾ç½®å½“å‰ä¸Šä¸‹æ–‡(kubecconfigæ–‡ä»¶å¯ä»¥æœ‰å¤šä¸ªä¸Šä¸‹æ–‡) view æ˜¾ç¤ºåˆå¹¶çš„ kubeconfig é…ç½®æˆ–ä¸€ä¸ªæŒ‡å®šçš„ kubeconfig æ–‡ä»¶ kubeconifg ä½¿ç”¨ kubectl è‡ªåŠ¨åŠ è½½ ~/.kube/config å¦‚æœæŒ‡å®š $KUBECONFIG, ä»$KUBECONFIGåŠ è½½ ä¹Ÿå¯ä»¥é€šè¿‡ kubectl æŒ‡å®š: kubectl config get-contexts \u0026ndash;kubeconfig=/root/.kube/config1 é…ç½®æ–‡ä»¶å‚è€ƒ: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 apiVersion: v1 clusters: - cluster: certificate-authority-data: LS0tLS1CRUdJTiBD...... server: https://11.0.1.100:16443 # æŒ‡å®šé›†ç¾¤çš„å…¥å£ name: kubernetes contexts: - context: cluster: kubernetes user: kubernetes-admin name: kubernetes-admin@kubernetes current-context: kubernetes-admin@kubernetes # æŒ‡å®šå½“å‰ context ä¸Šä¸‹æ–‡ kind: Config preferences: {} users: - name: kubernetes-admin user: client-certificate-data: ...... client-key-data: ...... ç”Ÿæˆæ–°çš„ context 1 2 3 4 5 6 7 8 9 # è·å– kubeconfig ä¸­æ‰€æœ‰ cluster $ kubectl config get-clusters NAME kubernetes $ kubectl config set-context test --cluster=kubernetes --user=kubernetes-admin --kubeconfig=/root/.kube/config --namespace=test # --kubeconfig kubeconfig æ˜¯é»˜è®¤è·¯å¾„å¯çœç•¥ # --namespace æŒ‡å®š context çš„é»˜è®¤ namespace, æ²¡æœ‰å³ä¸º default æ–°å¢ context: 1 2 3 4 5 6 7 8 9 10 11 12 ...... contexts: - context: cluster: kubernetes user: kubernetes-admin name: kubernetes-admin@kubernetes - context: # æ–°å¢ context cluster: kubernetes namespace: test user: kubernetes-admin name: test ... åˆ‡æ¢ context ä¸Šä¸‹æ–‡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 # æŸ¥çœ‹å½“å‰ context $ kubectl config current-context kubernetes-admin@kubernetes # æŸ¥çœ‹ kubeconfig ä¸­æ‰€æœ‰ context $ kubectl config get-contexts CURRENT NAME CLUSTER AUTHINFO NAMESPACE kubernetes-admin@kubernetes kubernetes kubernetes-admin * test kubernetes kubernetes-admin test # åˆ‡æ¢ context $ kubectl config use-context test Switched to context \u0026#34;test\u0026#34;. # åˆ›å»º pod | é»˜è®¤åœ¨ test namespace ä¸‹åˆ›å»º $ k get po NAME READY STATUS RESTARTS AGE nginxpod 1/1 Running 0 14m å¤šé›†ç¾¤ç®¡ç† å› é›†ç¾¤é…ç½®æœ‰ vip, æœ¬æ–‡å°†æ–°å¢ä¸€ä¸ª cluster ç›´æ¥æŒ‡å‘ master apiserver çš„åœ°å€, æ‰€ä»¥, cluster çš„ ca ä¸å˜\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 $ cat ~/.kube/config apiVersion: v1 clusters: - cluster: certificate-authority-data: LS0tLS1CRUdJTiBD...... server: https://11.0.1.100:16443 name: kubernetes - cluster: certificate-authority-data: LS0tLS1CRUdJTiBD...... server: https://11.0.1.150:6443 name: direct-cluster contexts: - context: cluster: kubernetes user: kubernetes-admin name: kubernetes-admin@kubernetes - context: cluster: kubernetes namespace: test user: kubernetes-admin name: test current-context: test kind: Config preferences: {} users: - name: kubernetes-admin user: client-certificate-data: ...... client-key-data: ...... æˆ‘ä»¬æ–°å¢äº†ä¸€ä¸ªdirect-clusterçš„cluster\nåˆ›å»º context 1 2 3 4 5 6 7 8 # é»˜è®¤ namespace ä¸º default $ kubectl config set-context direct --user=kubernetes-admin --cluster=direct-cluster # åˆ‡æ¢ context $ kubectl config use-context direct $ kubectl get po No resources found in default namespace. æ–°å¢ context: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 ...... contexts: - context: cluster: kubernetes user: kubernetes-admin name: kubernetes-admin@kubernetes - context: cluster: kubernetes namespace: test user: kubernetes-admin name: test - context: # æ–°å¢ context cluster: direct-cluster user: kubernetes-admin name: direct ... å‚è€ƒ:\nhttps://kubernetes.io/zh-cn/docs/concepts/configuration/organize-cluster-access-kubeconfig/ ä»€ä¹ˆæ˜¯k8sä¸Šä¸‹æ–‡ï¼Ÿkubeconfigé…ç½®æ–‡ä»¶è®²è§£-CSDNåšå®¢ ","date":"2024-01-01T17:31:05+08:00","image":"https://blog-source-mkt.oss-cn-chengdu.aliyuncs.com/blog_source/public/kubernetes/Kubeconfig-File-Explained.png.webp","permalink":"/p/%E4%BD%BF%E7%94%A8-kubeconfig-%E7%AE%A1%E7%90%86%E9%9B%86%E7%BE%A4/","title":"ä½¿ç”¨ kubeconfig ç®¡ç†é›†ç¾¤"},{"content":"k8s é›†ç¾¤é…ç½® IP Host é…ç½® 11.0.1.150 master1 (keepalived+haproxy) 2C 4G 30G 11.0.1.148 master2 (keepalived+haproxy) 2C 4G 30G 11.0.1.149 node1 2C 4G 30G ç†è§£ kubeconfig æœ¬æ–‡æ˜¯ä½¿ç”¨ kubectl æ¥ç®¡ç† k8s é›†ç¾¤, æ‰€ä»¥ä½ éœ€è¦çŸ¥é“ kubeconfig çš„é…ç½®ç»“æ„, ä¹Ÿå¯ä»¥ç›´æ¥ copy-paste\nkubectl ç®¡ç†ä¼˜åŠ¿: å¯é€šè¿‡åˆ‡æ¢ context ä¸Šä¸‹æ–‡, æ›´æ¢æ“ä½œé›†ç¾¤ =\u0026gt; å¯ç®¡ç†é›†ç¾¤è”é‚¦\næ¨è: ç†è§£/ä½¿ç”¨ kubeconfig ç®¡ç†é›†ç¾¤ \u0026ndash; CSDN\næ€è·¯æ•´ç†: é¦–å…ˆç†æ¸…æ€è·¯, è¦ä½¿ç”¨ wsl ç®¡ç†è¿œç¨‹ k8s é›†ç¾¤\nç¡®ä¿ wsl èƒ½å¤Ÿè¿æ¥åˆ° k8s é›†ç¾¤ è¦ç®¡ç† k8s é›†ç¾¤, å°±éœ€è¦åœ¨ wsl ä¸Šå®‰è£… kubectl, ä¸å†éœ€è¦ kubeadm ä¸ kubelet è¦æƒ³ä½¿ç”¨ kubectl ç®¡ç†é›†ç¾¤, å°±éœ€è¦é›†ç¾¤çš„ kubeconfig ä¸ é›†ç¾¤è¯ä¹¦ åœ¨ wsl ä¸Šå®‰è£… kubectl 1 2 3 4 5 6 7 8 9 10 11 12 13 14 # å®‰è£…ä¾èµ– apt install apt-transport-https ca-certificates -y apt install vim lsof net-tools zip unzip tree wget curl bash-completion pciutils gcc make lrzsz tcpdump bind9-utils -y # ç¼–è¾‘é•œåƒæºæ–‡ä»¶ï¼Œæ–‡ä»¶æœ«å°¾åŠ å…¥é˜¿é‡Œäº‘k8sé•œåƒæºé…ç½® echo \u0026#39;deb https://mirrors.aliyun.com/kubernetes/apt kubernetes-xenial main\u0026#39; \u0026gt;\u0026gt; /etc/apt/sources.list #æ›´æ–°è¯ä¹¦ curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | sudo apt-key add #æ›´æ–°æº apt update # æŸ¥çœ‹ kubeadm ç‰ˆæœ¬ apt-cache madison kubeactl | grep 1.28 apt-get install -y kubectl=1.28.1-00 é…ç½®è‡ªåŠ¨è¡¥å…¨ 1 2 3 4 5 6 7 8 apt install bash-completion -y cat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; ~/.profile alias k=\u0026#39;kubectl\u0026#39; source \u0026lt;(kubectl completion bash) complete -F __start_kubectl k EOF source ~/.profile æ‹·è´ kubeconfig ç™»åˆ° k8s é›†ç¾¤çš„ master èŠ‚ç‚¹, æŠŠ kubeconfig æ‹·è´åˆ° wsl ssh å…å¯†ç™»å½•\n1 2 3 4 5 6 7 echo \u0026#34;172.28.18.117 wsl\u0026#34; \u0026gt;\u0026gt; /etc/hosts # æµ‹è¯•é“¾æ¥ ping wsl # æ‹·è´å…¬é’¥ ssh-copy-id -i ~/.ssh/id_rsa.pub root@wsl å¦‚æœæœ‰å®‰å…¨éœ€è¦çš„è¯, å°±ä¸è¦æŠŠå»ºç«‹ wsl ä¸ master çš„å…å¯†ç™»å½•\næ‹·è´ kubeconfig\n1 2 3 ssh root@wsl mkdir /root/.kube scp /root/.kube/config root@wsl:/root/.kube/config æµ‹è¯• kubectl 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 root@MKT:~# k get po -A NAMESPACE NAME READY STATUS RESTARTS AGE calico-apiserver calico-apiserver-69fc754d76-9w7p6 1/1 Running 1 (17m ago) 46h calico-apiserver calico-apiserver-69fc754d76-kdxt4 1/1 Running 1 (21m ago) 46h calico-system calico-kube-controllers-b9dcc57c4-gzlhk 1/1 Running 1 (21m ago) 46h calico-system calico-node-5jckf 1/1 Running 1 (17m ago) 46h calico-system calico-node-gq882 1/1 Running 1 (21m ago) 46h calico-system calico-node-zksvz 1/1 Running 1 (21m ago) 45h calico-system calico-typha-5cdb9d5d59-tnjzh 1/1 Running 1 (17m ago) 46h calico-system calico-typha-5cdb9d5d59-z7tnk 1/1 Running 1 (21m ago) 45h calico-system csi-node-driver-j4648 2/2 Running 2 (21m ago) 46h calico-system csi-node-driver-jf548 2/2 Running 2 (21m ago) 45h calico-system csi-node-driver-p9b8p 2/2 Running 2 (17m ago) 46h kube-system coredns-66f779496c-n4lwr 1/1 Running 1 46h kube-system coredns-66f779496c-tmjx9 1/1 Running 1 (21m ago) 46h kube-system etcd-master1 1/1 Running 3 (21m ago) 46h kube-system etcd-master2 1/1 Running 1 (21m ago) 45h kube-system kube-apiserver-master1 1/1 Running 3 (21m ago) 46h kube-system kube-apiserver-master2 1/1 Running 1 (21m ago) 45h kube-system kube-controller-manager-master1 1/1 Running 5 (21m ago) 46h kube-system kube-controller-manager-master2 1/1 Running 2 (20m ago) 45h kube-system kube-proxy-9tjjg 1/1 Running 1 (17m ago) 46h kube-system kube-proxy-chcc5 1/1 Running 1 (21m ago) 45h kube-system kube-proxy-mrp2v 1/1 Running 1 (21m ago) 46h kube-system kube-scheduler-master1 1/1 Running 5 (21m ago) 46h kube-system kube-scheduler-master2 1/1 Running 1 (21m ago) 45h tigera-operator tigera-operator-55585899bf-tcdhv 1/1 Running 4 (17m ago) 46h å‚è€ƒ:\nhttps://kubernetes.io/zh-cn/docs/concepts/configuration/organize-cluster-access-kubeconfig/ ","date":"2024-01-01T16:10:25+08:00","image":"https://blog-source-mkt.oss-cn-chengdu.aliyuncs.com/blog_source/public/kubernetes/kubectl.jpg","permalink":"/p/%E4%BD%BF%E7%94%A8-wsl-%E7%AE%A1%E7%90%86-k8s-%E9%9B%86%E7%BE%A4/","title":"ä½¿ç”¨ wsl ç®¡ç† k8s é›†ç¾¤"},{"content":"å†™æ—¶å¤åˆ¶ dockerfile ä¸€æ¡æŒ‡ä»¤å¯¹åº”ä¸€å±‚, æœ€å¤š 127 å±‚\nä» busybox å…¥æ‰‹ç†è§£ docker é•œåƒå±‚çš„å†™æ—¶å¤åˆ¶\ndockerfile:\n1 2 3 4 5 6 7 8 9 FROM busybox RUN mkdir -p /tmp/foo # æ–°å»ºä¸€ä¸ª 100M çš„æ–‡ä»¶ RUN dd if=/dev/zero of=/tmp/foo/bar bs=1M count=100 # åˆ é™¤æ–‡ä»¶ RUN rm /tmp/foo/bar ä¸€æ¡æŒ‡ä»¤å¯¹åº” 1 å±‚: 4 å±‚\n1 2 3 4 $ docker build -t busybox:copy-on-write -f dockerfile1 . $ docker images | grep busybox busybox copy-on-write 1f30f7a048eb About a minute ago 106MB busybox latest beae173ccac6 2 years ago 1.24MB çœ‹å¾—å‡ºæ¥å°±ç®—é•œåƒåˆ é™¤çš„æ–‡ä»¶, ä¸‹å±‚åˆ›å»ºçš„ä¸ä¼šæ¶ˆå¤±, åˆ é™¤æŒ‡ä»¤åˆ›å»ºçš„å±‚åªä¼šå åŠ ä¸Šå»\nä½¿ç”¨ docker inspect æŸ¥çœ‹å…·ä½“çš„å±‚ä¿¡æ¯\nbusybox:latest\n1 2 3 4 5 6 7 8 9 10 docker inspect busybox:latest ...... \u0026#34;RootFS\u0026#34;: { \u0026#34;Type\u0026#34;: \u0026#34;layers\u0026#34;, \u0026#34;Layers\u0026#34;: [ \u0026#34;sha256:82ae998286b2bba64ce571578647adcabef93d53867748d6046cc844ff193a83\u0026#34; ] }, ...... busybox:copy-on-write\n1 2 3 4 5 6 7 8 9 10 11 12 13 docker inspect busybox:copy-on-write ...... \u0026#34;RootFS\u0026#34;: { \u0026#34;Type\u0026#34;: \u0026#34;layers\u0026#34;, \u0026#34;Layers\u0026#34;: [ \u0026#34;sha256:82ae998286b2bba64ce571578647adcabef93d53867748d6046cc844ff193a83\u0026#34;, \u0026#34;sha256:f70c1ce3ef10664a7aacf002afd20aa16f56bf98a83729b640c97363b10d329c\u0026#34;, \u0026#34;sha256:3c38ae07f686f954897d06c4c56e65e17d1be5843f2c02e8f2d6734b4978dd83\u0026#34;, \u0026#34;sha256:69d9b35636c7fa1f62c4bfe15f3c65f247553b122fe38af17dc34666f8cb2314\u0026#34; ] }, ...... å¯ä»¥çœ‹åˆ° busybox:copy-on-write æ˜æ˜¾å¢åŠ äº†å±‚æ•°\nåˆ¶ä½œç²¾ç®€é•œåƒæ–¹æ³•: ä¸²è” Dockerfile æŒ‡ä»¤ é€‰ç”¨æ›´å°çš„é•œåƒ å‹ç¼©é•œåƒ æ¡ˆä¾‹: äºŒè¿›åˆ¶éƒ¨ç½² redis\nå¤šæ¡å‘½ä»¤æ„å»º 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 FROM ubuntu:trusty ENV VER 7.2.3 # å®‰è£…ä¾èµ– RUN apt update RUN apt install wget make gcc -y # è·å–æºç åŒ… RUN wget https://download.redis.io/releases/redis-$VER.tar.gz RUN tar zxvf redis-$VER.tar.gz WORKDIR redis-$VER # ç¼–è¯‘æºç åŒ… RUN make RUN mkdir /usr/local/redis RUN make install PREFIX=/usr/local/redis RUN apt-get clean \u0026amp;\u0026amp; apt-get remove -y wget gcc make # å¯åŠ¨ redis CMD [\u0026#34;/usr/local/redis/redis-server\u0026#34;, \u0026#34;/usr/local/redis/redis.conf\u0026#34;] æ„é€ é•œåƒ 1 docker build -t redis:many-lines-ubuntu -f dockerfile2 . ROOTFS 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 ...... \u0026#34;RootFS\u0026#34;: { \u0026#34;Type\u0026#34;: \u0026#34;layers\u0026#34;, \u0026#34;Layers\u0026#34;: [ \u0026#34;sha256:f2fa9f4cf8fd0a521d40e34492b522cee3f35004047e617c75fadeb8bfd1e6b7\u0026#34;, \u0026#34;sha256:30d3c4334a2379748937816c01f5c972a8291a5ccc958d6b33d735457a16196e\u0026#34;, \u0026#34;sha256:83109fa660b2ed9307948505abd3c1f24c27c64009691067edb765bd3714b98d\u0026#34;, \u0026#34;sha256:87c240db20b96e01aa53111dbf1a71b54095e95f2bb32076a7aee2de148aaaf1\u0026#34;, \u0026#34;sha256:c45a2d4a77a5eb88bd2bfaaa691468eade520c8da9b3d39d30813e9882ff7b0b\u0026#34;, \u0026#34;sha256:65faa09184aa345eeace30548ad9a337e4582f9b23d8a0871ad8a5be08fe6c09\u0026#34;, \u0026#34;sha256:af54af5d0e940764f3cd2b78d5ab121b2dba5eb1f527e81f8c70c3deeddf15b9\u0026#34;, \u0026#34;sha256:5f70bf18a086007016e948b04aed3b82103a36bea41755b6cddfaf10ace3c6ef\u0026#34;, \u0026#34;sha256:1819a309db341aed9bc39e040a3695151d2b33c9d1d267069d6f3918f3871a1d\u0026#34;, \u0026#34;sha256:e54f0072570654b50dd413197f5d921da283c90689d79336ed0c313112d3a591\u0026#34;, \u0026#34;sha256:b6499beec6f2099e86807b4fee915170820834dfafae3ca324309db26e5660fb\u0026#34;, \u0026#34;sha256:14a95f408690a544c45387595381902f921eb0356a53f8a73495198dc113b8a1\u0026#34;, \u0026#34;sha256:a545e5b1525c37272eb70af26d8baab872f592c5f71ba934353a7104f0680e21\u0026#34; ] }, ...... ç”±äºæˆ‘ä»¬å†™äº†å†™å¤šæ¡ RUN æŒ‡ä»¤, æ‰€ä»¥é•œåƒ ROOTFS æé€Ÿå¢é•¿\nä¸€æ¡å‘½ä»¤æ„å»º ubuntu 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 FROM ubuntu:trusty ENV VER 7.2.3 RUN apt update \u0026amp;\u0026amp; \\ apt install wget make gcc -y \u0026amp;\u0026amp; \\ wget https://download.redis.io/releases/redis-$VER.tar.gz \u0026amp;\u0026amp; \\ tar zxvf redis-$VER.tar.gz \u0026amp;\u0026amp; cd redis-$VER \u0026amp;\u0026amp; \\ make \u0026amp;\u0026amp; mkdir /usr/local/redis \u0026amp;\u0026amp; \\ make install PREFIX=/usr/local/redis \u0026amp;\u0026amp; \\ mkdir -p /usr/local/redis/{conf,bin} \u0026amp;\u0026amp; \\ cp redis.conf /usr/local/redis/conf \u0026amp;\u0026amp; \\ apt-get clean \u0026amp;\u0026amp; apt-get remove -y wget gcc make # å¯åŠ¨ redis CMD [\u0026#34;/usr/local/redis/bin/redis-server\u0026#34;, \u0026#34;/usr/local/redis/conf\u0026#34;] æ„é€ é•œåƒ 1 docker build -t redis:one-line-ubuntu -f dockerfile2 . ROOTFS 1 2 3 4 5 6 7 8 9 10 11 12 13 docker inspect redis:one-line-ubuntu ...... \u0026#34;RootFS\u0026#34;: { \u0026#34;Type\u0026#34;: \u0026#34;layers\u0026#34;, \u0026#34;Layers\u0026#34;: [ \u0026#34;sha256:f2fa9f4cf8fd0a521d40e34492b522cee3f35004047e617c75fadeb8bfd1e6b7\u0026#34;, \u0026#34;sha256:30d3c4334a2379748937816c01f5c972a8291a5ccc958d6b33d735457a16196e\u0026#34;, \u0026#34;sha256:83109fa660b2ed9307948505abd3c1f24c27c64009691067edb765bd3714b98d\u0026#34;, \u0026#34;sha256:72caaf8c025e80d97674e4d68ac4628b8dabab70dc9b73ef817c51b694c45daa\u0026#34; ] }, ...... å¯ä»¥çœ‹å‡ºæŒ‡ä»¤æ•°å‡å°‘, ROOTFS å±‚æ•°ä¹Ÿæ˜æ˜¾å‡å°‘\næ›´æ”¹åŸºç¡€é•œåƒä¸º debian å·¨å‘: debian ä¸ alpine çš„é•œåƒåœ¨åˆ‡æ¢å›½å†…æ—¶é—®é¢˜éå¸¸å¤š, å»ºè®®ç›´æ¥ä½¿ç”¨åŸå§‹é•œåƒçš„è½¯ä»¶æº(ç¡®ä¿èƒ½å¤Ÿè®¿é—®å¤–ç½‘)\né—®é¢˜æ¦‚è§ˆ:\ndebian ä½ç‰ˆæœ¬åˆ‡æ¢é˜¿é‡Œæºæ—¶, ä¸æ”¯æŒ https: éœ€è¦å°† http è½¯è¿æ¥ä¸º https æ˜¾ç¤º gpg key é”™è¯¯æ—¶: wget http://http.us.debian.org/debian/pool/main/d/debian-archive-keyring/debian-archive-keyring_2023.4_all.deb \u0026amp;\u0026amp; dpkg -i debian-archive-keyring_2023.4_all.deb alpline ä¸ debian å®‰è£…çš„ gcc å¯èƒ½ä¼šå‡ºç°ç‰ˆæœ¬é—®é¢˜, éœ€è¦ä½ æ›´æ¢ gcc ç‰ˆæœ¬ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 FROM debian ENV VER 7.2.3 RUN apt-get update \u0026amp;\u0026amp; \\ apt-get install wget make gcc -y \u0026amp;\u0026amp; \\ wget https://download.redis.io/releases/redis-$VER.tar.gz \u0026amp;\u0026amp; \\ tar zxvf redis-$VER.tar.gz \u0026amp;\u0026amp; cd redis-$VER \u0026amp;\u0026amp; \\ make \u0026amp;\u0026amp; mkdir /usr/local/redis \u0026amp;\u0026amp; \\ make install PREFIX=/usr/local/redis \u0026amp;\u0026amp; \\ mkdir -p /usr/local/redis/{conf,bin} \u0026amp;\u0026amp; \\ cp redis.conf /usr/local/redis/conf \u0026amp;\u0026amp; \\ apt-get clean \u0026amp;\u0026amp; apt-get remove -y wget gcc make # å¯åŠ¨ redis CMD [\u0026#34;/usr/local/redis/bin/redis-server\u0026#34;, \u0026#34;/usr/local/redis/conf\u0026#34;] æ„é€ é•œåƒ 1 docker build -t redis:one-line-debian -f dockerfile2 . ROOTFS 1 2 3 4 5 6 7 8 9 10 11 docker inspect redis:one-line-debian ...... \u0026#34;RootFS\u0026#34;: { \u0026#34;Type\u0026#34;: \u0026#34;layers\u0026#34;, \u0026#34;Layers\u0026#34;: [ \u0026#34;sha256:ae134c61b154341a1dd932bd88cb44e805837508284e5d60ead8e94519eb339f\u0026#34;, \u0026#34;sha256:98547bcc9e3b713c48a4f5ca069fd442eaa71bc61b68c9a3c00a4af0d73cbe2d\u0026#34; ] }, ...... å¯ä»¥çœ‹å‡ºå°†å¤šæ¡æŒ‡ä»¤åˆå¹¶ä¹¦å†™èƒ½å¤Ÿæœ‰æ•ˆå‡å°‘ ROOTFS å±‚æ•°\nä½¿ç”¨åˆ†æ®µæ„é€  å¤šæ®µæ„é€ , åœ¨åˆ°æœ€åä¸€æ®µ, æœ‰å°é•œåƒæ‰¿æ¥, å‰é¢æ®µçš„å†…å®¹ä¸ä¼šä¿ç•™ä¸‹æ¥\næ¨èé•œåƒ:\né•œåƒ è¯´æ˜ scrach ç©ºé•œåƒ, ä¸å¸¦ä»»ä½•è°ƒè¯•å·¥å…· busybox å°é•œåƒ, å¸¦æœ‰åŸºç¡€è°ƒè¯•å·¥å…· å› ä¸ºæˆ‘ä»¬éœ€è¦è§£å‹ tar åŒ…, scrath æ²¡æœ‰è§£å‹å·¥å…·, æˆ‘ä»¬ä½¿ç”¨ busybox æ¼”ç¤º\nä½¿ç”¨ busybox ä½œä¸ºåŸºç¡€é•œåƒ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 FROM ubuntu:trusty as builder ENV VER 7.2.3 RUN apt update \u0026amp;\u0026amp; \\ apt install wget make gcc -y \u0026amp;\u0026amp; \\ wget https://download.redis.io/releases/redis-$VER.tar.gz \u0026amp;\u0026amp; \\ tar zxvf redis-$VER.tar.gz \u0026amp;\u0026amp; cd redis-$VER \u0026amp;\u0026amp; \\ make \u0026amp;\u0026amp; mkdir /usr/local/redis \u0026amp;\u0026amp; \\ make install PREFIX=/usr/local/redis \u0026amp;\u0026amp; \\ cp redis.conf /usr/local/redis/conf \u0026amp;\u0026amp; \\ apt-get clean \u0026amp;\u0026amp; apt-get remove -y wget gcc make RUN tar cvf /123.tar /usr/local/redis/ FROM busybox COPY --from=builder /123.tar / RUN tar xvf /123.tar -C /usr/local/ # å¯åŠ¨ redis CMD [\u0026#34;/usr/local/redis/bin/redis-server\u0026#34;, \u0026#34;/usr/local/redis/conf\u0026#34;] æ„é€ é•œåƒ è¡¥å……: å¦‚æœä½ é‡åˆ° Dockerfile æ„é€ æ—¶çš„é”™è¯¯æ—¶, å¯ä»¥åŠ ä¸Š --progress=plain --no-cacheæŸ¥çœ‹è¯¦ç»†æ„å»ºæ—¥å¿—\n1 docker build -t redis:with-busybox -f dockerfile7 . --progress=plain ROOTFS 1 2 3 4 5 6 7 8 9 10 11 12 docker inspect redis:with-busybox ...... \u0026#34;RootFS\u0026#34;: { \u0026#34;Type\u0026#34;: \u0026#34;layers\u0026#34;, \u0026#34;Layers\u0026#34;: [ \u0026#34;sha256:82ae998286b2bba64ce571578647adcabef93d53867748d6046cc844ff193a83\u0026#34;, \u0026#34;sha256:335bc67496eb30fe68fe25e6c8f97cb6b74d9989a1c6b24012971097bf22a1a3\u0026#34;, \u0026#34;sha256:abf10e66d6bddcb7e00f41707d71515b1927b1984889aa13ca6b232f9fb78b27\u0026#34; ] }, ...... é•œåƒå‹ç¼© äº†è§£å³å¯ docker squashå·²ä¸åœ¨ç»´æŠ¤\nå®‰è£… 1 2 3 wget https://github.com/jwilder/docker-squash/releases/download/v0.2.0/docker-squash-linux-amd64-v0.2.0.tar.gz tar xzvf docker-squash-linux-amd64-v0.2.0.tar.gz -C /usr/local/bin/ ä½¿ç”¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 root@MKT:~/goproject/httppod/tmp# docker save redis:many-lines-ubuntu | docker-squash -verbose -t redis:squash | docker load Loading export from STDIN using /tmp/docker-squash272131964 for tempdir Loaded image w/ 13 layers - redis (1 tags) Extracting layers... - /tmp/docker-squash272131964/72c5745a74e809afa1c8bbb09164a25a99971cd6ebb60bf9a3c7c399932e2d92/layer.tar - /tmp/docker-squash272131964/e0d139e2e59aa8505f205730d7bd8924bf1289034504be42b618c284420cb9c2/layer.tar - /tmp/docker-squash272131964/10bc199db63a91cf1c3d75fddb1083740e09115320801e0e34f517f8160bd326/layer.tar - /tmp/docker-squash272131964/228aa3e189d788785b2d8c129b6bbf1553ad34e141608706f2d0459d5a1be035/layer.tar - /tmp/docker-squash272131964/42f6beebfd61e1ff415ab2237fdb49bd34dee9f319a1d49e2ca525dc18823e5d/layer.tar - /tmp/docker-squash272131964/45ce59804d1f796310cf5ba3e5878be2e63d644ba271c8d33a315230e737324f/layer.tar - /tmp/docker-squash272131964/462272b123320a876d404d41dac9f20ecf24140f22d979896cc2d0bfa487bae2/layer.tar - /tmp/docker-squash272131964/63b9671bfe8674a1e65dfbb88881ddb1c214eabf89f6ed98e3f0e1deaca9bd8f/layer.tar - /tmp/docker-squash272131964/075972677a1d485c0ba03f4d3b2fb6e3c39f273628f6f0d702149faa4e2831bd/layer.tar - /tmp/docker-squash272131964/88f0016636d34b6a24606c2db4d7ea26c0a02d830383e46aee831c2e1db897a9/layer.tar - /tmp/docker-squash272131964/a8626ef4bd7f2ec2fde454e5263f09eea4d369983ef770abb470f1688baa6681/layer.tar - /tmp/docker-squash272131964/a8ea63a42a3c2e60d8738e8bd81be0502d4bc6ecc827c8e472e171d4abf7e5cf/layer.tar - /tmp/docker-squash272131964/b795b8b69dcd58cbf17a234cba5e8d1de61da850032d781ae92b3ba9eb0fdb69/layer.tar Inserted new layer 2619184f193f after 228aa3e189d7 - 228aa3e189d7 -\u0026gt; 2619184f193f /bin/sh -c #(squash) from 228aa3e189d7 - 075972677a1d - 10bc199db63a - a8626ef4bd7f - 88f0016636d3 - e0d139e2e59a - 63b9671bfe86 - 45ce59804d1f - 462272b12332 - b795b8b69dcd - 42f6beebfd61 - a8ea63a42a3c - 72c5745a74e8 Squashing from 2619184f193f into 2619184f193f - Deleting whiteouts for layer 075972677a1d - Deleting whiteouts for layer 10bc199db63a Removing extracted layers Tagging 2619184f193f as redis:squash Tarring new image to STDOUT Done. New image created. - 228aa3e189d7 54.036378 years 206.1 MB - 2619184f193f 17 seconds /bin/sh -c #(squash) from 228aa3e189d7 370.1 MB Removing tempdir /tmp/docker-squash272131964 Loaded image: redis:many-lines-ubuntu æ€»ç»“ é•œåƒå¤§å°\n1 2 3 4 5 6 7 root@MKT:~/goproject/httppod/tmp# docker images REPOSITORY TAG IMAGE ID CREATED SIZE redis with-busybox a26dc68d9da9 17 minutes ago 65.1MB busybox copy-on-write e71e45a955a2 26 minutes ago 109MB redis many-lines-ubuntu cf3ded3f5a5f 43 minutes ago 565MB redis one-line-debian ac157643d4a6 About an hour ago 669MB redis one-line-ubuntu 86be0695bcf2 2 hours ago 562MB ç²¾ç®€é•œåƒæ–¹å¼:\nä½¿ç”¨å•æ¡æŒ‡ä»¤æ›¿æ¢å¤šæ¡æŒ‡ä»¤ ä½¿ç”¨æ›´å°çš„åŸºç¡€é•œåƒ ä½¿ç”¨é•œåƒå‹ç¼©å·¥å…· å‚è€ƒ:\nå®¹å™¨åŒ– | ä½¿ç”¨ Alpine æ„å»º Redis é•œåƒ - RadonDB - åšå®¢å›­ (cnblogs.com) åŸºäºalpineç”¨dockerfileåˆ›å»ºçš„nginxé•œåƒ - ä¸€æœ¬æ­£ç»çš„æäº‹æƒ… - åšå®¢å›­ (cnblogs.com) redisäºŒè¿›åˆ¶å®‰è£…_äºŒè¿›åˆ¶å®‰è£…redis-CSDNåšå®¢ apt get - Debian 8 Jessie archive.debian.org GPG error KEYEXPIRED since 2022-11-19 (what now?) - Stack Overflow ","date":"2024-01-01T15:01:35+08:00","image":"https://blog-source-mkt.oss-cn-chengdu.aliyuncs.com/blog_source/public/15839387687383.jpg","permalink":"/p/dockerfile-%E5%88%B6%E4%BD%9C%E7%B2%BE%E7%AE%80%E9%95%9C%E5%83%8F/","title":"Dockerfile: åˆ¶ä½œç²¾ç®€é•œåƒ"},{"content":"é—®é¢˜åœºæ™¯: k8s 1.28.1\né›†ç¾¤åæœŸæ–°å¢ vip\napiserver è¯ä¹¦ä¸æ”¯æŒ vip\nç¬¬äºŒä¸ª master èŠ‚ç‚¹æƒ³è¦åŠ å…¥é›†ç¾¤, ä½†æ˜¯åœ¨ etcd å¥åº·æ£€æŸ¥æ—¶, å®ç° vip ä¸åœ¨ apiserver è¯ä¹¦èŒƒå›´å†…\n1 2 3 4 5 6 7 8 [kubeconfig] Writing \u0026#34;scheduler.conf\u0026#34; kubeconfig file [control-plane] Using manifest folder \u0026#34;/etc/kubernetes/manifests\u0026#34; [control-plane] Creating static Pod manifest for \u0026#34;kube-apiserver\u0026#34; [control-plane] Creating static Pod manifest for \u0026#34;kube-controller-manager\u0026#34; [control-plane] Creating static Pod manifest for \u0026#34;kube-scheduler\u0026#34; [check-etcd] Checking that the etcd cluster is healthy error execution phase check-etcd: could not retrieve the list of etcd endpoints: Get \u0026#34;https://11.0.1.100:16443/api/v1/namespaces/kube-system/pods?labelSelector=component%3Detcd%2Ctier%3Dcontrol-plane\u0026#34;: tls: failed to verify certificate: x509: certificate is valid for 10.96.0.1, 11.0.1.150, not 11.0.1.100 To see the stack trace of this error execute with --v=5 or higher é—®é¢˜åˆ†æ: è¯´æ˜ api-server çš„è¯ä¹¦æ²¡æœ‰æ·»åŠ  11.0.1.100\né—®é¢˜è§£å†³: æŸ¥çœ‹ apiserver è¯ä¹¦æ”¯æŒçš„ ip æˆ– host 1 2 3 4 5 openssl x509 -noout -text -in /etc/kubernetes/pki/apiserver.crt è¾“å‡º: X509v3 Subject Alternative Name: DNS:kubernetes, DNS:kubernetes.default, DNS:kubernetes.default.svc, DNS:kubernetes.default.svc.cluster.local, DNS:master1, IP Address:10.96.0.1, IP Address:11.0.1.150 è¯´æ˜å½“å‰ apiserver ä¸æ”¯æŒ vip 11.0.1.100 çš„è¿æ¥\nä½¿ç”¨ openssl ç”Ÿæˆè¯ä¹¦: 1 2 3 4 5 6 7 8 9 10 11 12 mkdir /tmp/bak cp /etc/kubernetes/pki/ /tmp/bak/ -r # ç”Ÿæˆå¯†é’¥å¯¹ cd /etc/kubernetes/pki/ openssl genrsa -out apiserver.key 2048\t# æ–°å¢ apiserver.extæ–‡ä»¶ï¼ŒåŒ…å«æ‰€æœ‰çš„åœ°å€åˆ—è¡¨ï¼Œä»¥åŠæ–°å¢åœ°å€ subjectAltName = DNS:wudang,DNS:kubernetes,DNS:kubernetes.default,DNS:kubernetes.default.svc, DNS:kubernetes.default.svc.cluster.local, IP:10.96.0.1, IP:11.0.1.150, IP:11.0.1.100 # ç”Ÿæˆ openssl req -new -key apiserver.key -subj \u0026#34;/CN=kube-apiserver,\u0026#34; -out apiserver.csr å†æ¬¡æŸ¥çœ‹ apiserver è¯ä¹¦æ”¯æŒçš„ ip æˆ– host 1 2 3 4 5 6 openssl x509 -noout -text -in apiserver.crt è¾“å‡º: X509v3 extensions: X509v3 Subject Alternative Name: DNS:wudang, DNS:kubernetes, DNS:kubernetes.default, DNS:kubernetes.default.svc, DNS:kubernetes.default.svc.cluster.local, IP Address:10.96.0.1, IP Address:11.0.1.150, IP Address:11.0.1.100 å¯ä»¥çœ‹åˆ° 11.0.1.100 å·²ç»æˆåŠŸåŠ ä¸Šå»äº†\nå†æ¬¡å°è¯•å°† master åŠ ç‚¹åŠ å…¥ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 root@ubuntu:/etc/kubernetes/pki# kubeadm join 11.0.1.150:6443 --token iwqftg.rs9wydqac98ecqbv --discovery-token-ca-cert-hash sha256:698fef4be22b563ce3ae350971e8ca1302488eda76148df5c210a03ce29c0b1a --control-plane --certificate-key c994991c3445a3dc03fbe4f0d8794e8e51946a2b44c920c9a74fa5941b03261d [preflight] Running pre-flight checks [preflight] Reading configuration from the cluster... [preflight] FYI: You can look at this config file with \u0026#39;kubectl -n kube-system get cm kubeadm-config -o yaml\u0026#39; [preflight] Running pre-flight checks before initializing the new control plane instance [preflight] Pulling images required for setting up a Kubernetes cluster [preflight] This might take a minute or two, depending on the speed of your internet connection [preflight] You can also perform this action in beforehand using \u0026#39;kubeadm config images pull\u0026#39; W1230 19:00:20.797222 23382 checks.go:835] detected that the sandbox image \u0026#34;registry.aliyuncs.com/google_containers/pause:3.8\u0026#34; of the container runtime is inconsistent with that used by kubeadm. It is recommended that using \u0026#34;registry.aliyuncs.com/google_containers/pause:3.9\u0026#34; as the CRI sandbox image. [download-certs] Downloading the certificates in Secret \u0026#34;kubeadm-certs\u0026#34; in the \u0026#34;kube-system\u0026#34; Namespace [download-certs] Saving the certificates to the folder: \u0026#34;/etc/kubernetes/pki\u0026#34; [certs] Using certificateDir folder \u0026#34;/etc/kubernetes/pki\u0026#34; [certs] Generating \u0026#34;apiserver\u0026#34; certificate and key [certs] apiserver serving cert is signed for DNS names [kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local master2] and IPs [10.96.0.1 11.0.1.151 11.0.1.100] [certs] Generating \u0026#34;apiserver-kubelet-client\u0026#34; certificate and key [certs] Generating \u0026#34;front-proxy-client\u0026#34; certificate and key [certs] Generating \u0026#34;etcd/server\u0026#34; certificate and key [certs] etcd/server serving cert is signed for DNS names [localhost master2] and IPs [11.0.1.151 127.0.0.1 ::1] [certs] Generating \u0026#34;apiserver-etcd-client\u0026#34; certificate and key [certs] Generating \u0026#34;etcd/peer\u0026#34; certificate and key [certs] etcd/peer serving cert is signed for DNS names [localhost master2] and IPs [11.0.1.151 127.0.0.1 ::1] [certs] Generating \u0026#34;etcd/healthcheck-client\u0026#34; certificate and key [certs] Valid certificates and keys now exist in \u0026#34;/etc/kubernetes/pki\u0026#34; [certs] Using the existing \u0026#34;sa\u0026#34; key [kubeconfig] Generating kubeconfig files [kubeconfig] Using kubeconfig folder \u0026#34;/etc/kubernetes\u0026#34; W1230 19:00:21.802963 23382 endpoint.go:57] [endpoint] WARNING: port specified in controlPlaneEndpoint overrides bindPort in the controlplane address [kubeconfig] Writing \u0026#34;admin.conf\u0026#34; kubeconfig file W1230 19:00:22.105107 23382 endpoint.go:57] [endpoint] WARNING: port specified in controlPlaneEndpoint overrides bindPort in the controlplane address [kubeconfig] Writing \u0026#34;controller-manager.conf\u0026#34; kubeconfig file W1230 19:00:22.181303 23382 endpoint.go:57] [endpoint] WARNING: port specified in controlPlaneEndpoint overrides bindPort in the controlplane address [kubeconfig] Writing \u0026#34;scheduler.conf\u0026#34; kubeconfig file [control-plane] Using manifest folder \u0026#34;/etc/kubernetes/manifests\u0026#34; [control-plane] Creating static Pod manifest for \u0026#34;kube-apiserver\u0026#34; [control-plane] Creating static Pod manifest for \u0026#34;kube-controller-manager\u0026#34; [control-plane] Creating static Pod manifest for \u0026#34;kube-scheduler\u0026#34; [check-etcd] Checking that the etcd cluster is healthy [kubelet-start] Writing kubelet configuration to file \u0026#34;/var/lib/kubelet/config.yaml\u0026#34; [kubelet-start] Writing kubelet environment file with flags to file \u0026#34;/var/lib/kubelet/kubeadm-flags.env\u0026#34; [kubelet-start] Starting the kubelet [kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap... [etcd] Announced new etcd member joining to the existing etcd cluster [etcd] Creating static Pod manifest for \u0026#34;etcd\u0026#34; [etcd] Waiting for the new etcd member to join the cluster. This can take up to 40s The \u0026#39;update-status\u0026#39; phase is deprecated and will be removed in a future release. Currently it performs no operation [mark-control-plane] Marking the node master2 as control-plane by adding the labels: [node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers] [mark-control-plane] Marking the node master2 as control-plane by adding the taints [node-role.kubernetes.io/control-plane:NoSchedule] This node has joined the cluster and a new control plane instance was created: * Certificate signing request was sent to apiserver and approval was received. * The Kubelet was informed of the new secure connection details. * Control plane label and taint were applied to the new node. * The Kubernetes control plane instances scaled up. * A new etcd member was added to the local/stacked etcd cluster. To start administering your cluster from this node, you need to run the following as a regular user: mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config Run \u0026#39;kubectl get nodes\u0026#39; to see this node join the cluster. æ–°å¢çš„ master èŠ‚ç‚¹æˆåŠŸåŠ å…¥é›†ç¾¤\nå‚è€ƒ Kuberneteså­¦ä¹ (è§£å†³x509 certificate is valid for xxx, not yyy) | Z.S.K.\u0026rsquo;s Records (izsk.me) è§£å†³ Kubeadm æ·»åŠ æ–° Master èŠ‚ç‚¹åˆ°é›†ç¾¤å‡ºç° ETCD å¥åº·æ£€æŸ¥å¤±è´¥é”™è¯¯_error execution phase check-etcd: etcd cluster is -CSDNåšå®¢ https://cloud.tencent.com/developer/article/1692388 ","date":"2023-12-30T20:10:27+08:00","image":"https://blog-source-mkt.oss-cn-chengdu.aliyuncs.com/blog_source/public/kubernetes/2t5ys00st6.png","permalink":"/p/%E6%89%A9%E5%B1%95-apiserver-%E8%BF%9E%E6%8E%A5%E8%AE%A4%E8%AF%81-ip-%E8%AF%81%E4%B9%A6%E6%9B%B4%E6%96%B0/","title":"æ‰©å±• apiserver è¿æ¥è®¤è¯ ip, è¯ä¹¦æ›´æ–°"},{"content":"é›†ç¾¤é…ç½® é…ç½®æ¸…å• OSï¼š ubuntu 20.04 kubernetesï¼š 1.28.1 Container Runtimeï¼šContainerd 1.7.11 CRI: runc 1.10 CNI: cni-plugin 1.4 é›†ç¾¤è§„åˆ’ IP Host é…ç½® 11.0.1.147 master1 (keepalived+nginx) 2C 4G 30G 11.0.1.148 master2 (keepalived+nginx) 2C 4G 30G 11.0.1.149 node1 2C 4G 30G 11.0.1.150 node2 2C 4G 30G 11.0.1.151 node3 2C 4G 30G é›†ç¾¤ç½‘ç»œè§„åˆ’ Pod ç½‘ç»œ: 10.244.0.0/16 Service ç½‘ç»œ: 10.96.0.0/12 Node ç½‘ç»œ: 11.0.1.0/24 å®‰è£…é…ç½® keepalived 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 # åœ¨è§„åˆ’çš„ vip èŠ‚ç‚¹ apt install keepalived -y # master1 cat \u0026gt; /etc/keepalived/keepalived.conf \u0026lt;\u0026lt; EOF ! Configuration File for keepalived global_defs { router_id LVS_DEVEL vrrp_skip_check_adv_addr vrrp_strict vrrp_garp_interval 0 vrrp_gna_interval 0 } vrrp_instance VI_1 { state MASTER interface ens33 virtual_router_id 50 priority 100 advert_int 1 authentication { auth_type PASS auth_pass root } virtual_ipaddress { 11.0.1.100 } } EOF # master2 cat \u0026gt; /etc/keepalived/keepalived.conf \u0026lt;\u0026lt; EOF ! Configuration File for keepalived global_defs { router_id LVS_DEVEL vrrp_skip_check_adv_addr vrrp_strict vrrp_garp_interval 0 vrrp_gna_interval 0 } vrrp_instance VI_1 { state BACKUP interface ens33 virtual_router_id 50 nopreempt priority 70 advert_int 1 virtual_ipaddress { 11.0.1.100 } } EOF # é‡å¯ keepalived systemctl restart keepalived.service \u0026amp;\u0026amp; systemctl enable keepalived.service systemctl status keepalived.service # æŸ¥çœ‹ vip ip a | grep 11.0.1.100 # å¯åœæ‰ master1 çœ‹ vip æ˜¯å¦ä¼šæ¼‚ç§»åˆ° master2 å®‰è£…é…ç½® nginx 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 apt install nginx -y systemctl status nginx # ä¿®æ”¹ nginx é…ç½®æ–‡ä»¶ cat /etc/nginx/nginx.conf user user; worker_processes auto; pid /run/nginx.pid; include /etc/nginx/modules-enabled/*.conf; events { worker_connections 768; # multi_accept on; } #æ·»åŠ äº†stream è¿™ä¸€æ®µï¼Œå…¶ä»–çš„ä¿æŒé»˜è®¤å³å¯ stream { log_format main \u0026#39;$remote_addr $upstream_addr - [$time_local] $status $upstream_bytes_sent\u0026#39;; access_log /var/log/nginx/k8s-access.log main; upstream k8s-apiserver { server 11.0.1.147:6443; #master01çš„IPå’Œ6443ç«¯å£ server 11.0.1.148:6443; #master02çš„IPå’Œ6443ç«¯å£ } server { listen 16443; #ç›‘å¬çš„æ˜¯16443ç«¯å£ï¼Œå› ä¸ºnginxå’Œmasterå¤ç”¨æœºå™¨ï¼Œæ‰€ä»¥ä¸èƒ½æ˜¯6443ç«¯å£ proxy_pass k8s-apiserver; #ä½¿ç”¨proxy_passæ¨¡å—è¿›è¡Œåå‘ä»£ç† } } http { ## # Basic Settings ## sendfile on; tcp_nopush on; tcp_nodelay on; keepalive_timeout 65; types_hash_max_size 2048; # server_tokens off; # server_names_hash_bucket_size 64; # server_name_in_redirect off; include /etc/nginx/mime.types; default_type application/octet-stream; ## # SSL Settings ## ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3; # Dropping SSLv3, ref: POODLE ssl_prefer_server_ciphers on; ## # Logging Settings ## access_log /var/log/nginx/access.log; error_log /var/log/nginx/error.log; ## # Gzip Settings ## gzip on; # gzip_vary on; # gzip_proxied any; # gzip_comp_level 6; # gzip_buffers 16 8k; # gzip_http_version 1.1; # gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript; ## # Virtual Host Configs ## include /etc/nginx/conf.d/*.conf; include /etc/nginx/sites-enabled/*; } # é‡å¯ nginx æœåŠ¡ systemctl restart nginx \u0026amp;\u0026amp; systemctl enable nginx \u0026amp;\u0026amp; systemctl status nginx # ç«¯å£æ£€æŸ¥ netstat -lntup| grep 16443 é…ç½®é«˜å¯ç”¨ ApiServer å¯ä»¥ä½¿ç”¨ kubeadm init åˆå§‹åŒ–é›†ç¾¤æ—¶, æŒ‡å®šé«˜å¯ç”¨åœ°å€ command line 1 2 3 4 5 6 7 8 kubeadm init \\ --apiserver-advertise-address=11.0.1.147 \\ --apiserver-bind-port=6443 \\ --control-plane-endpoint=11.0.1.100:16443 \\ # æŒ‡å®š vip + nginx ç«¯å£ --image-repository registry.aliyuncs.com/google_containers \\ --kubernetes-version v1.28.1 \\ --service-cidr=10.96.0.0/12 \\ --pod-network-cidr=10.244.0.0/16 yaml æ–¹å¼åˆå§‹åŒ– kubeadm åˆå§‹åŒ–é›†ç¾¤æ–‡ä»¶ Kubernetes-cluster.yaml:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 apiVersion: kubeadm.k8s.io/v1beta3 bootstrapTokens: - groups: - system:bootstrappers:kubeadm:default-node-token token: abcdef.0123456789abcdef ttl: 24h0m0s usages: - signing - authentication kind: InitConfiguration localAPIEndpoint: # å°†æ­¤å¤„IPåœ°å€æ›¿æ¢ä¸ºä¸»èŠ‚ç‚¹IP ETCDå®¹å™¨ä¼šè¯•å›¾é€šè¿‡æ­¤åœ°å€ç»‘å®šç«¯å£ å¦‚æœä¸»æœºä¸å­˜åœ¨åˆ™ä¼šå¤±è´¥ advertiseAddress: 11.0.1.147 bindPort: 6443 nodeRegistration: criSocket: unix:///run/containerd/containerd.sock imagePullPolicy: IfNotPresent name: master1 # èŠ‚ç‚¹ hostname taints: null --- # controlPlaneEndpoint å¯é…ç½®é«˜å¯ç”¨çš„ ApiServer apiServer: timeoutForControlPlane: 4m0s apiVersion: kubeadm.k8s.io/v1beta3 controlPlaneEndpoint: 11.0.1.100:6443 # ä½¿ç”¨ keepalived + nginx çš„é«˜å¯ç”¨åœ°å€ certificatesDir: /etc/kubernetes/pki clusterName: kubernetes controllerManager: {} dns: {} etcd: # å¯ä½¿ç”¨å¤–æ¥ etcd é›†ç¾¤ local: dataDir: /var/lib/etcd imageRepository: registry.aliyuncs.com/google_containers # å›½å†…æº kind: ClusterConfiguration kubernetesVersion: 1.28.1 networking: dnsDomain: cluster.local # å¢åŠ é…ç½® æŒ‡å®špodç½‘æ®µ podSubnet: \u0026#34;10.244.0.0/16\u0026#34; serviceSubnet: 10.96.0.0/12 scheduler: {} --- apiVersion: kubeproxy.config.k8s.io/v1alpha1 kind: KubeProxyConfiguration mode: ipvs # kubeproxy ä½¿ç”¨ ipvs --- kind: KubeletConfiguration apiVersion: kubelet.config.k8s.io/v1beta1 cgroupDriver: systemd åœ¨å·²æœ‰é›†ç¾¤ä¸Šæ·»åŠ é«˜å¯ç”¨åœ°å€ 1 2 3 kubectl -n kube-system edit cm kubeadm-config # æŠŠ controlPlaneEndpoint ä¿®æ”¹ä¸ºé«˜å¯ç”¨åœ°å€å³å¯ å• master è½¬ vip é«˜å¯ç”¨çš„å‘:\nå¦‚æœé‡åˆ°åŠ å…¥æ–°èŠ‚ç‚¹æ—¶, å‡ºç° tls ç›¸å…³æŠ¥é”™, æ˜¾ç¤ºè¿æ¥ ip ä¸æ”¯æŒ, åˆ™éœ€è¦æ›´æ–° apiserver è¯ä¹¦\n","date":"2023-12-24T20:48:26+08:00","image":"https://blog-source-mkt.oss-cn-chengdu.aliyuncs.com/blog_source/public/kubernetes/1c9798a03347452295e1b66af9606f57.png","permalink":"/p/keepalived-nginx%E5%AE%9E%E7%8E%B0%E9%AB%98%E5%8F%AF%E7%94%A8apiserver/","title":"Keepalived+nginxå®ç°é«˜å¯ç”¨apiserver"},{"content":"é›†ç¾¤é…ç½® é…ç½®æ¸…å• OSï¼š ubuntu 20.04 kubernetesï¼š 1.28.1 Container Runtimeï¼šContainerd 1.7.11 CRI: runc 1.10 CNI: cni-plugin 1.4 é›†ç¾¤è§„åˆ’ IP Hostname é…ç½® 11.0.1.147 master1 2C 4G 30G 11.0.1.148 master2 2C 4G 30G 11.0.1.149 node1 2C 4G 30G 11.0.1.150 node2 2C 4G 30G 11.0.1.151 node3 2C 4G 30G é›†ç¾¤ç½‘ç»œè§„åˆ’ Pod ç½‘ç»œ: 10.244.0.0/16 Service ç½‘ç»œ: 10.96.0.0/12 Node ç½‘ç»œ: 11.0.1.0/24 ç¯å¢ƒåˆå§‹åŒ– ä¸»æœºé…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 # ä¿®æ”¹ä¸»æœºå hostnamectl set-hostname master1 hostnamectl set-hostname master2 hostnamectl set-hostname node1 hostnamectl set-hostname node2 hostnamectl set-hostname node3 # å°†èŠ‚ç‚¹åŠ å…¥ hosts cat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; /etc/hosts 11.0.1.147 master1 11.0.1.148 master2 11.0.1.149 node1 11.0.1.150 node2 11.0.1.151 node3 EOF # æ—¶é—´åŒæ­¥ timedatectl set-timezone Asia/Shanghai #å®‰è£…chronyï¼Œè”ç½‘åŒæ­¥æ—¶é—´ apt install chrony -y \u0026amp;\u0026amp; systemctl enable --now chronyd # é…ç½® ssh å…å¯†ç™»å½• ssh-copy-id -i /root/.ssh/id_rsa.pub root@11.0.1.148 ssh-copy-id -i /root/.ssh/id_rsa.pub root@11.0.1.149 ssh-copy-id -i /root/.ssh/id_rsa.pub root@11.0.1.150 ssh-copy-id -i /root/.ssh/id_rsa.pub root@11.0.1.151 ç¦ç”¨ swap 1 sudo swapoff -a \u0026amp;\u0026amp; sed -i \u0026#39;/swap/s/^/#/\u0026#39; /etc/fstab å®‰è£… ipvs 1 apt install -y ipset ipvsadm è°ƒæ•´å†…æ ¸å‚æ•° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 # é…ç½®éœ€è¦çš„å†…æ ¸æ¨¡å— cat \u0026lt;\u0026lt;EOF | sudo tee /etc/modules-load.d/k8s.conf overlay br_netfilter EOF # å¯åŠ¨æ¨¡å— sudo modprobe overlay sudo modprobe br_netfilter cat \u0026lt;\u0026lt;EOF | sudo tee /etc/sysctl.d/k8s.conf net.bridge.bridge-nf-call-iptables = 1 net.bridge.bridge-nf-call-ip6tables = 1 net.ipv4.ip_forward = 1 EOF # æ˜¯ sysctl å‚æ•°ç”Ÿæ•ˆ sudo sysctl --system # æ£€éªŒæ˜¯å¦é…ç½®æˆåŠŸ lsmod | grep br_netfilter lsmod | grep overlay sysctl net.bridge.bridge-nf-call-iptables net.bridge.bridge-nf-call-ip6tables net.ipv4.ip_forward # é…ç½® ipvs å†…æ ¸å‚æ•° cat \u0026lt;\u0026lt;EOF | sudo tee /etc/modules-load.d/ipvs.conf ip_vs ip_vs_rr ip_vs_wrr ip_vs_sh nf_conntrack EOF # å†…æ ¸åŠ è½½ ipvs sudo modprobe ip_vs sudo modprobe ip_vs_rr sudo modprobe ip_vs_wrr sudo modprobe ip_vs_sh sudo modprobe nf_conntrack # ç¡®è®¤ipvsæ¨¡å—åŠ è½½ lsmod |grep -e ip_vs -e nf_conntrack å®‰è£… Containerd äºŒè¿›åˆ¶å®‰è£… containerd 1 2 3 4 5 6 7 8 9 10 11 wget -c https://github.com/containerd/containerd/releases/download/v1.7.11/containerd-1.7.11-linux-amd64.tar.gz tar -xzvf containerd-1.7.11-linux-amd64.tar.gz #è§£å‹å‡ºæ¥ä¸€ä¸ªbinç›®å½•,containerdå¯æ‰§è¡Œæ–‡ä»¶éƒ½åœ¨binç›®å½•é‡Œé¢ mv bin/* /usr/local/bin/ rm -rf bin #ä½¿ç”¨systemcdæ¥ç®¡ç†containerd wget https://raw.githubusercontent.com/containerd/containerd/main/containerd.service mv containerd.service /usr/lib/systemd/system/ systemctl daemon-reload \u0026amp;\u0026amp; systemctl enable --now containerd systemctl status containerd å®‰è£… OCI Interface runc 1 2 3 4 #å®‰è£…runc #runcæ˜¯å®¹å™¨è¿è¡Œæ—¶ï¼Œruncå®ç°äº†å®¹å™¨çš„initï¼Œrunï¼Œcreateï¼Œps...æˆ‘ä»¬åœ¨è¿è¡Œå®¹å™¨æ‰€éœ€è¦çš„cmdï¼š curl -LO https://github.com/opencontainers/runc/releases/download/v1.1.10/runc.amd64 \u0026amp;\u0026amp; \\ install -m 755 runc.amd64 /usr/local/sbin/runc å®‰è£… CNI plugins 1 2 3 4 wget -c https://github.com/containernetworking/plugins/releases/download/v1.4.0/cni-plugins-linux-amd64-v1.4.0.tgz #æ ¹æ®å®˜ç½‘çš„å®‰è£…æ­¥éª¤æ¥ï¼Œåˆ›å»ºä¸€ä¸ªç›®å½•ç”¨äºå­˜æ”¾cniæ’ä»¶ mkdir -p /opt/cni/bin tar -xzvf cni-plugins-linux-amd64-v1.4.0.tgz -C /opt/cni/bin/ ä¿®æ”¹ Containd é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 #ä¿®æ”¹containerdçš„é…ç½®ï¼Œå› ä¸ºcontainerdé»˜è®¤ä»k8så®˜ç½‘æ‹‰å–é•œåƒ #åˆ›å»ºä¸€ä¸ªç›®å½•ç”¨äºå­˜æ”¾containerdçš„é…ç½®æ–‡ä»¶ mkdir -p /etc/containerd #æŠŠcontainerdé…ç½®å¯¼å‡ºåˆ°æ–‡ä»¶ containerd config default | sudo tee /etc/containerd/config.toml # ä¿®æ”¹æ²™ç®±é•œåƒ sed -i \u0026#39;s#sandbox_image = \u0026#34;registry.k8s.io/pause:3.8\u0026#34;#sandbox_image = \u0026#34;registry.aliyuncs.com/google_containers/pause:3.8\u0026#34;#\u0026#39; /etc/containerd/config.toml # ä¿®æ”¹ cgroup ä¸º systemd sed -i \u0026#39;s#SystemdCgroup = false#SystemdCgroup = true#\u0026#39; /etc/containerd/config.toml # é…ç½®é•œåƒåŠ é€Ÿ sed -i \u0026#39;s#config_path = \u0026#34;\u0026#34;#config_path = \u0026#34;/etc/containerd/certs.d\u0026#34;#\u0026#39; /etc/containerd/config.toml é…ç½® Containerd é•œåƒæº 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 # docker hubé•œåƒåŠ é€Ÿ mkdir -p /etc/containerd/certs.d/docker.io cat \u0026gt; /etc/containerd/certs.d/docker.io/hosts.toml \u0026lt;\u0026lt; EOF server = \u0026#34;https://docker.io\u0026#34; [host.\u0026#34;https://dockerproxy.com\u0026#34;] capabilities = [\u0026#34;pull\u0026#34;, \u0026#34;resolve\u0026#34;] [host.\u0026#34;https://docker.m.daocloud.io\u0026#34;] capabilities = [\u0026#34;pull\u0026#34;, \u0026#34;resolve\u0026#34;] [host.\u0026#34;https://reg-mirror.qiniu.com\u0026#34;] capabilities = [\u0026#34;pull\u0026#34;, \u0026#34;resolve\u0026#34;] [host.\u0026#34;https://registry.docker-cn.com\u0026#34;] capabilities = [\u0026#34;pull\u0026#34;, \u0026#34;resolve\u0026#34;] [host.\u0026#34;http://hub-mirror.c.163.com\u0026#34;] capabilities = [\u0026#34;pull\u0026#34;, \u0026#34;resolve\u0026#34;] EOF # registry.k8s.ioé•œåƒåŠ é€Ÿ mkdir -p /etc/containerd/certs.d/registry.k8s.io tee /etc/containerd/certs.d/registry.k8s.io/hosts.toml \u0026lt;\u0026lt; \u0026#39;EOF\u0026#39; server = \u0026#34;https://registry.k8s.io\u0026#34; [host.\u0026#34;https://k8s.m.daocloud.io\u0026#34;] capabilities = [\u0026#34;pull\u0026#34;, \u0026#34;resolve\u0026#34;, \u0026#34;push\u0026#34;] EOF # docker.elastic.coé•œåƒåŠ é€Ÿ mkdir -p /etc/containerd/certs.d/docker.elastic.co tee /etc/containerd/certs.d/docker.elastic.co/hosts.toml \u0026lt;\u0026lt; \u0026#39;EOF\u0026#39; server = \u0026#34;https://docker.elastic.co\u0026#34; [host.\u0026#34;https://elastic.m.daocloud.io\u0026#34;] capabilities = [\u0026#34;pull\u0026#34;, \u0026#34;resolve\u0026#34;, \u0026#34;push\u0026#34;] EOF # gcr.ioé•œåƒåŠ é€Ÿ mkdir -p /etc/containerd/certs.d/gcr.io tee /etc/containerd/certs.d/gcr.io/hosts.toml \u0026lt;\u0026lt; \u0026#39;EOF\u0026#39; server = \u0026#34;https://gcr.io\u0026#34; [host.\u0026#34;https://gcr.m.daocloud.io\u0026#34;] capabilities = [\u0026#34;pull\u0026#34;, \u0026#34;resolve\u0026#34;, \u0026#34;push\u0026#34;] EOF # ghcr.ioé•œåƒåŠ é€Ÿ mkdir -p /etc/containerd/certs.d/ghcr.io tee /etc/containerd/certs.d/ghcr.io/hosts.toml \u0026lt;\u0026lt; \u0026#39;EOF\u0026#39; server = \u0026#34;https://ghcr.io\u0026#34; [host.\u0026#34;https://ghcr.m.daocloud.io\u0026#34;] capabilities = [\u0026#34;pull\u0026#34;, \u0026#34;resolve\u0026#34;, \u0026#34;push\u0026#34;] EOF # k8s.gcr.ioé•œåƒåŠ é€Ÿ mkdir -p /etc/containerd/certs.d/k8s.gcr.io tee /etc/containerd/certs.d/k8s.gcr.io/hosts.toml \u0026lt;\u0026lt; \u0026#39;EOF\u0026#39; server = \u0026#34;https://k8s.gcr.io\u0026#34; [host.\u0026#34;https://k8s-gcr.m.daocloud.io\u0026#34;] capabilities = [\u0026#34;pull\u0026#34;, \u0026#34;resolve\u0026#34;, \u0026#34;push\u0026#34;] EOF # mcr.m.daocloud.ioé•œåƒåŠ é€Ÿ mkdir -p /etc/containerd/certs.d/mcr.microsoft.com tee /etc/containerd/certs.d/mcr.microsoft.com/hosts.toml \u0026lt;\u0026lt; \u0026#39;EOF\u0026#39; server = \u0026#34;https://mcr.microsoft.com\u0026#34; [host.\u0026#34;https://mcr.m.daocloud.io\u0026#34;] capabilities = [\u0026#34;pull\u0026#34;, \u0026#34;resolve\u0026#34;, \u0026#34;push\u0026#34;] EOF # nvcr.ioé•œåƒåŠ é€Ÿ mkdir -p /etc/containerd/certs.d/nvcr.io tee /etc/containerd/certs.d/nvcr.io/hosts.toml \u0026lt;\u0026lt; \u0026#39;EOF\u0026#39; server = \u0026#34;https://nvcr.io\u0026#34; [host.\u0026#34;https://nvcr.m.daocloud.io\u0026#34;] capabilities = [\u0026#34;pull\u0026#34;, \u0026#34;resolve\u0026#34;, \u0026#34;push\u0026#34;] EOF # quay.ioé•œåƒåŠ é€Ÿ mkdir -p /etc/containerd/certs.d/quay.io tee /etc/containerd/certs.d/quay.io/hosts.toml \u0026lt;\u0026lt; \u0026#39;EOF\u0026#39; server = \u0026#34;https://quay.io\u0026#34; [host.\u0026#34;https://quay.m.daocloud.io\u0026#34;] capabilities = [\u0026#34;pull\u0026#34;, \u0026#34;resolve\u0026#34;, \u0026#34;push\u0026#34;] EOF # registry.jujucharms.comé•œåƒåŠ é€Ÿ mkdir -p /etc/containerd/certs.d/registry.jujucharms.com tee /etc/containerd/certs.d/registry.jujucharms.com/hosts.toml \u0026lt;\u0026lt; \u0026#39;EOF\u0026#39; server = \u0026#34;https://registry.jujucharms.com\u0026#34; [host.\u0026#34;https://jujucharms.m.daocloud.io\u0026#34;] capabilities = [\u0026#34;pull\u0026#34;, \u0026#34;resolve\u0026#34;, \u0026#34;push\u0026#34;] EOF # rocks.canonical.comé•œåƒåŠ é€Ÿ mkdir -p /etc/containerd/certs.d/rocks.canonical.com tee /etc/containerd/certs.d/rocks.canonical.com/hosts.toml \u0026lt;\u0026lt; \u0026#39;EOF\u0026#39; server = \u0026#34;https://rocks.canonical.com\u0026#34; [host.\u0026#34;https://rocks-canonical.m.daocloud.io\u0026#34;] capabilities = [\u0026#34;pull\u0026#34;, \u0026#34;resolve\u0026#34;, \u0026#34;push\u0026#34;] EOF #é‡å¯containerd systemctl restart containerd systemctl status containerd åˆ›å»ºå®¹å™¨ç¡®ä¿ containerd æ­£ç¡®è¿è¡Œ(å¯é€‰) 1 2 3 4 5 6 7 8 #æ‹‰å–é•œåƒï¼Œæµ‹è¯•containerdæ˜¯å¦èƒ½åˆ›å»ºå’Œå¯åŠ¨æˆåŠŸ ctr i pull docker.io/library/nginx:alpine\t#èƒ½æ­£å¸¸æ‹‰å–é•œåƒè¯´æ˜æ²¡å•¥é—®é¢˜ ctr images ls\t#æŸ¥çœ‹é•œåƒ ctr c create --net-host docker.io/library/nginx:alpine nginx #åˆ›å»ºå®¹å™¨ ctr task start -d nginx\t#å¯åŠ¨å®¹å™¨ï¼Œæ­£å¸¸è¯´æ˜containerdæ²¡å•¥é—®é¢˜ ctr containers ls #æŸ¥çœ‹å®¹å™¨ ctr tasks kill -s SIGKILL nginx\t#ç»ˆæ­¢å®¹å™¨ ctr containers rm nginx\t#åˆ é™¤å®¹å™¨ å®‰è£… kubeadmã€kubeletã€kubectl 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # å®‰è£…ä¾èµ– apt install apt-transport-https ca-certificates -y apt install vim lsof net-tools zip unzip tree wget curl bash-completion pciutils gcc make lrzsz tcpdump bind9-utils -y # ç¼–è¾‘é•œåƒæºæ–‡ä»¶ï¼Œæ–‡ä»¶æœ«å°¾åŠ å…¥é˜¿é‡Œäº‘k8sé•œåƒæºé…ç½® echo \u0026#39;deb https://mirrors.aliyun.com/kubernetes/apt kubernetes-xenial main\u0026#39; \u0026gt;\u0026gt; /etc/apt/sources.list #æ›´æ–°è¯ä¹¦ curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | sudo apt-key add #æ›´æ–°æº apt update # æŸ¥çœ‹ kubeadm ç‰ˆæœ¬ apt-cache madison kubeadm | grep 1.28 apt-get install -y kubeadm=1.28.1-00 kubectl=1.28.1-00 kubelet=1.28.1-00 # kubelet å¼€æœºè‡ªå¯ systemctl enable kubelet é…ç½® crictl socket 1 2 crictl config runtime-endpoint unix:///run/containerd.sock crictl config image-endpoint unix:///run/containerd/containerd.sock kubeadm init ä¸€: ç›´æ¥é€šè¿‡ kubeadm init åˆå§‹åŒ–é›†ç¾¤ å¯æå‰æ‹‰å–é•œåƒ 1 2 kubeadm config images list --kubernetes-version=v1.28.1 --image-repository=registry.aliyuncs.com/google_containers kubeadm config images pull --kubernetes-version=v1.28.1 --image-repository=registry.aliyuncs.com/google_containers åˆå§‹åŒ–é›†ç¾¤ ä»¥ä¸‹æ˜¯å®‰è£…æ˜¯éé«˜å¯ç”¨è¿™å¹¶ä¸å½±å“é«˜å¯ç”¨çš„é…ç½®, æˆ‘å¦ä¸€ç¯‡åšå®¢ keepalived+nginxå®ç°é«˜å¯ç”¨apiserver, åˆå§‹åŒ–é›†ç¾¤ä¸é«˜å¯ç”¨çš„ apiserver ä¸¤æ­¥éª¤å¯ä»¥å®Œå…¨ç‹¬ç«‹, è¿™ä¸¤ç¯‡åšå®¢å¸¦ä½ äº†è§£ kubeadm init çš„å¤šç§æ–¹å¼\n1 2 3 4 5 6 kubeadm init \\ --apiserver-advertise-address=11.0.1.147 \\ --image-repository registry.aliyuncs.com/google_containers \\ --kubernetes-version v1.28.1 \\ --service-cidr=10.96.0.0/12 \\ --pod-network-cidr=10.244.0.0/16 äºŒ: é€šè¿‡åŠ è½½é…ç½®æ–‡ä»¶åˆå§‹åŒ–é›†ç¾¤ è·å–é›†ç¾¤åˆå§‹åŒ–é…ç½®æ–‡ä»¶ 1 2 kubeadm config print init-defaults \u0026gt;Kubernetes-cluster.yaml vim Kubernetes-cluster.yaml Kubernetes-cluster.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 apiVersion: kubeadm.k8s.io/v1beta3 bootstrapTokens: - groups: - system:bootstrappers:kubeadm:default-node-token token: abcdef.0123456789abcdef ttl: 24h0m0s usages: - signing - authentication kind: InitConfiguration localAPIEndpoint: # å°†æ­¤å¤„IPåœ°å€æ›¿æ¢ä¸ºä¸»èŠ‚ç‚¹IP ETCDå®¹å™¨ä¼šè¯•å›¾é€šè¿‡æ­¤åœ°å€ç»‘å®šç«¯å£ å¦‚æœä¸»æœºä¸å­˜åœ¨åˆ™ä¼šå¤±è´¥ advertiseAddress: 11.0.1.147 bindPort: 6443 nodeRegistration: criSocket: unix:///run/containerd/containerd.sock imagePullPolicy: IfNotPresent name: master1 # èŠ‚ç‚¹ hostname taints: null --- # controlPlaneEndpoint å¯é…ç½®é«˜å¯ç”¨çš„ ApiServer apiServer: timeoutForControlPlane: 4m0s apiVersion: kubeadm.k8s.io/v1beta3 certificatesDir: /etc/kubernetes/pki clusterName: kubernetes controllerManager: {} dns: {} etcd: # å¯ä½¿ç”¨å¤–æ¥ etcd é›†ç¾¤ local: dataDir: /var/lib/etcd imageRepository: registry.aliyuncs.com/google_containers # å›½å†…æº kind: ClusterConfiguration kubernetesVersion: 1.28.1 networking: dnsDomain: cluster.local # å¢åŠ é…ç½® æŒ‡å®špodç½‘æ®µ podSubnet: \u0026#34;10.244.0.0/16\u0026#34; serviceSubnet: 10.96.0.0/12 scheduler: {} --- apiVersion: kubeproxy.config.k8s.io/v1alpha1 kind: KubeProxyConfiguration mode: ipvs # kubeproxy ä½¿ç”¨ ipvs --- kind: KubeletConfiguration apiVersion: kubelet.config.k8s.io/v1beta1 cgroupDriver: systemd è·å–æˆ–ä¿®æ”¹: kubectl -n kube-system edit cm kubeadm-config\nä½¿ç”¨é…ç½®æ–‡ä»¶åˆå§‹åŒ–é›†ç¾¤ 1 kubeadm init --config Kubernetes-cluster.yaml å¤åˆ¶ kubeconfig 1 2 3 mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config åŠ å…¥èŠ‚ç‚¹ åŠ å…¥ å·¥ä½œèŠ‚ç‚¹ å¯ç›´æ¥å¤åˆ¶ kubeadm init åçš„ join åŠ å…¥\n1 2 kubeadm join 11.0.1.147:6443 --token abcdef.0123456789abcdef \\ --discovery-token-ca-cert-hash sha256:7b465a19bae495131a16b51967a0c329bce9fe7d49136c641929eda69cfd6969 åŠ å…¥ master å¦‚æœ kubeadm init åæœ‰åŠ å…¥ master çš„å‘½ä»¤ç›´æ¥å¤åˆ¶å°±è¡Œ\nå¦‚æœæ²¡æœ‰å°±è‡ªå·±åˆ›å»º control-plane çš„ cert\nåˆ›å»º cert-key 1 2 3 $ kubeadm init phase upload-certs --upload-certs [upload-certs] Using certificate key: d38fbc73dc4c113409597a59d65ee66e4641ca220a463b1efeac9baa14f2924a åˆ›å»º token ä¹Ÿå¯ä»¥ç›´æ¥ç”¨ kubeadm init äº§ç”Ÿçš„ token 1 2 $ kubeadm token create --print-join-command kubeadm join 11.0.1.147:6443 --token m4l8th.81p28vmm5dh3nxl9 --discovery-token-ca-cert-hash sha256:7b465a19bae495131a16b51967a0c329bce9fe7d49136c641929eda69cfd6969 åŠ å…¥ master2 1 kubeadm join 11.0.1.147:6443 --token m4l8th.81p28vmm5dh3nxl9 --discovery-token-ca-cert-hash sha256:7b465a19bae495131a16b51967a0c329bce9fe7d49136c641929eda69cfd6969 --control-plane --certificate-key d38fbc73dc4c113409597a59d65ee66e4641ca220a463b1efeac9baa14f2924a æ’é”™\nå¦‚ä½•å‘Kubernetesé›†ç¾¤ä¸­æ·»åŠ masterèŠ‚ç‚¹ï¼ˆåŸé›†ç¾¤åªæœ‰ä¸€ä¸ªmasterèŠ‚ç‚¹ï¼‰\n1 2 3 4 5 6 7 8 9 10 11 12 [preflight] FYI: You can look at this config file with \u0026#39;kubectl -n kube-system get cm kubeadm-config -o yaml\u0026#39; error execution phase preflight: One or more conditions for hosting a new control plane instance is not satisfied. unable to add a new control plane instance to a cluster that doesn\u0026#39;t have a stable controlPlaneEndpoint address Please ensure that: * The cluster has a stable controlPlaneEndpoint address. * The certificates that must be shared among control plane instances are provided. To see the stack trace of this error execute with --v=5 or higher è¯´æ˜ apiserver æ²¡æœ‰ç»‘å®šåˆ°å›ºå®š IP, å¯ä»¥åœ¨ master1\n1 2 3 kubectl -n kube-system edit cm kubeadm-config # ä¿®æ”¹ data ä¸­ controlPlaneEndpoint ä¸ºä¸€ä¸ªé™æ€ IP(è¦ç¡®ä¿é™æ€ IP èƒ½å¤Ÿè®¿é—® apiserver æ³¨æ„è¯ä¹¦, åæœŸå¯é€šè¿‡ keepalived/nginx é…ç½® apiserver çš„é«˜å¯ç”¨, 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 root@ubuntu:~# kubeadm join 11.0.1.147:6443 --token m4l8th.81p28vmm5dh3nxl9 --discovery-token-ca-cert-hash sha256:7b465a19bae495131a16b51967a0c329bce9fe7d49136c641929eda69cfd6969 --control-plane --certificate-key d38fbc73dc4c113409597a59d65ee66e4641ca220a463b1efeac9baa14f2924a [preflight] Running pre-flight checks [preflight] Reading configuration from the cluster... [preflight] FYI: You can look at this config file with \u0026#39;kubectl -n kube-system get cm kubeadm-config -o yaml\u0026#39; [preflight] Running pre-flight checks before initializing the new control plane instance [preflight] Pulling images required for setting up a Kubernetes cluster [preflight] This might take a minute or two, depending on the speed of your internet connection [preflight] You can also perform this action in beforehand using \u0026#39;kubeadm config images pull\u0026#39; W1223 14:04:19.065758 16517 checks.go:835] detected that the sandbox image \u0026#34;registry.aliyuncs.com/google_containers/pause:3.8\u0026#34; of the container runtime is inconsistent with that used by kubeadm. It is recommended that using \u0026#34;registry.aliyuncs.com/google_containers/pause:3.9\u0026#34; as the CRI sandbox image. [download-certs] Downloading the certificates in Secret \u0026#34;kubeadm-certs\u0026#34; in the \u0026#34;kube-system\u0026#34; Namespace [download-certs] Saving the certificates to the folder: \u0026#34;/etc/kubernetes/pki\u0026#34; [certs] Using certificateDir folder \u0026#34;/etc/kubernetes/pki\u0026#34; [certs] Generating \u0026#34;front-proxy-client\u0026#34; certificate and key [certs] Generating \u0026#34;apiserver-etcd-client\u0026#34; certificate and key [certs] Generating \u0026#34;etcd/healthcheck-client\u0026#34; certificate and key [certs] Generating \u0026#34;etcd/server\u0026#34; certificate and key [certs] etcd/server serving cert is signed for DNS names [localhost master2] and IPs [11.0.1.148 127.0.0.1 ::1] [certs] Generating \u0026#34;etcd/peer\u0026#34; certificate and key [certs] etcd/peer serving cert is signed for DNS names [localhost master2] and IPs [11.0.1.148 127.0.0.1 ::1] [certs] Generating \u0026#34;apiserver\u0026#34; certificate and key [certs] apiserver serving cert is signed for DNS names [kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local master2] and IPs [10.96.0.1 11.0.1.148 11.0.1.147] [certs] Generating \u0026#34;apiserver-kubelet-client\u0026#34; certificate and key [certs] Valid certificates and keys now exist in \u0026#34;/etc/kubernetes/pki\u0026#34; [certs] Using the existing \u0026#34;sa\u0026#34; key [kubeconfig] Generating kubeconfig files [kubeconfig] Using kubeconfig folder \u0026#34;/etc/kubernetes\u0026#34; [kubeconfig] Writing \u0026#34;admin.conf\u0026#34; kubeconfig file [kubeconfig] Writing \u0026#34;controller-manager.conf\u0026#34; kubeconfig file [kubeconfig] Writing \u0026#34;scheduler.conf\u0026#34; kubeconfig file [control-plane] Using manifest folder \u0026#34;/etc/kubernetes/manifests\u0026#34; [control-plane] Creating static Pod manifest for \u0026#34;kube-apiserver\u0026#34; [control-plane] Creating static Pod manifest for \u0026#34;kube-controller-manager\u0026#34; [control-plane] Creating static Pod manifest for \u0026#34;kube-scheduler\u0026#34; [check-etcd] Checking that the etcd cluster is healthy [kubelet-start] Writing kubelet configuration to file \u0026#34;/var/lib/kubelet/config.yaml\u0026#34; [kubelet-start] Writing kubelet environment file with flags to file \u0026#34;/var/lib/kubelet/kubeadm-flags.env\u0026#34; [kubelet-start] Starting the kubelet [kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap... [etcd] Announced new etcd member joining to the existing etcd cluster [etcd] Creating static Pod manifest for \u0026#34;etcd\u0026#34; [etcd] Waiting for the new etcd member to join the cluster. This can take up to 40s The \u0026#39;update-status\u0026#39; phase is deprecated and will be removed in a future release. Currently it performs no operation [mark-control-plane] Marking the node master2 as control-plane by adding the labels: [node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers] [mark-control-plane] Marking the node master2 as control-plane by adding the taints [node-role.kubernetes.io/control-plane:NoSchedule] This node has joined the cluster and a new control plane instance was created: * Certificate signing request was sent to apiserver and approval was received. * The Kubelet was informed of the new secure connection details. * Control plane label and taint were applied to the new node. * The Kubernetes control plane instances scaled up. * A new etcd member was added to the local/stacked etcd cluster. To start administering your cluster from this node, you need to run the following as a regular user: mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config Run \u0026#39;kubectl get nodes\u0026#39; to see this node join the cluster. é…ç½®å‘½ä»¤è¡Œè‡ªåŠ¨è¡¥å…¨(å¯é€‰) 1 2 3 4 5 6 7 8 apt install bash-completion -y cat \u0026lt;\u0026lt; EOF \u0026gt;\u0026gt; ~/.profile alias k=\u0026#39;kubectl\u0026#39; source \u0026lt;(kubectl completion bash) complete -F __start_kubectl k EOF source ~/.profile å®‰è£… calico 1 2 3 4 kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.0/manifests/tigera-operator.yaml wget https://raw.githubusercontent.com/projectcalico/calico/v3.27.0/manifests/custom-resources.yaml vi custom-resources.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 # This section includes base Calico installation configuration. # For more information, see: https://docs.tigera.io/calico/latest/reference/installation/api#operator.tigera.io/v1.Installation apiVersion: operator.tigera.io/v1 kind: Installation metadata: name: default spec: # Configures Calico networking. calicoNetwork: # Note: The ipPools section cannot be modified post-install. ipPools: - blockSize: 26 cidr: 10.244.0.0/16 # ä¸åˆ’åˆ†çš„ pod ç½‘æ®µä¸€è‡´ encapsulation: VXLANCrossSubnet natOutgoing: Enabled nodeSelector: all() --- # This section configures the Calico API server. # For more information, see: https://docs.tigera.io/calico/latest/reference/installation/api#operator.tigera.io/v1.APIServer apiVersion: operator.tigera.io/v1 kind: APIServer metadata: name: default spec: {} éªŒè¯é›†ç¾¤ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 root@ubuntu:~# k get po -A NAMESPACE NAME READY STATUS RESTARTS AGE calico-apiserver calico-apiserver-66cb6b4b7f-8l67s 1/1 Running 0 57s calico-apiserver calico-apiserver-66cb6b4b7f-p8xs9 0/1 Running 0 57s calico-system calico-kube-controllers-86d48c97dc-vzzcd 1/1 Running 0 5m32s calico-system calico-node-29snn 1/1 Running 0 5m32s calico-system calico-node-cqrrf 1/1 Running 0 5m32s calico-system calico-node-gvpjn 1/1 Running 0 5m32s calico-system calico-node-wq4mh 1/1 Running 0 5m32s calico-system calico-node-xfvkw 1/1 Running 0 5m32s calico-system calico-typha-55fd77b9db-2x8sv 1/1 Running 0 5m24s calico-system calico-typha-55fd77b9db-4r98k 1/1 Running 0 5m33s calico-system calico-typha-55fd77b9db-qk7cm 1/1 Running 0 5m24s calico-system csi-node-driver-bhzpm 2/2 Running 0 5m32s calico-system csi-node-driver-bptcd 2/2 Running 0 5m32s calico-system csi-node-driver-g884s 2/2 Running 0 5m32s calico-system csi-node-driver-vm4p7 0/2 ContainerCreating 0 5m32s calico-system csi-node-driver-zgmds 2/2 Running 0 5m32s kube-system coredns-66f779496c-6fmh9 1/1 Running 0 17h kube-system coredns-66f779496c-p47zp 1/1 Running 0 17h kube-system etcd-master1 1/1 Running 2 17h kube-system etcd-master2 1/1 Running 0 16h kube-system kube-apiserver-master1 1/1 Running 2 17h kube-system kube-apiserver-master2 1/1 Running 0 16h kube-system kube-controller-manager-master1 1/1 Running 4 17h kube-system kube-controller-manager-master2 1/1 Running 1 (11h ago) 16h kube-system kube-proxy-bb2qd 1/1 Running 0 17h kube-system kube-proxy-c4zqw 1/1 Running 0 17h kube-system kube-proxy-cnwnl 1/1 Running 0 16h kube-system kube-proxy-mtgn6 1/1 Running 0 17h kube-system kube-proxy-tlgln 1/1 Running 0 17h kube-system kube-scheduler-master1 1/1 Running 4 17h kube-system kube-scheduler-master2 1/1 Running 1 (11h ago) 16h tigera-operator tigera-operator-55585899bf-mcs5f 1/1 Running 0 5m46s root@ubuntu:~# k get no NAME STATUS ROLES AGE VERSION master1 Ready control-plane 17h v1.28.1 master2 Ready control-plane 16h v1.28.1 node1 Ready \u0026lt;none\u0026gt; 17h v1.28.1 node2 Ready \u0026lt;none\u0026gt; 17h v1.28.1 node3 Ready \u0026lt;none\u0026gt; 17h v1.28.1 å‚è€ƒæ–‡ç« : å°† Docker Engine èŠ‚ç‚¹ä» dockershim è¿ç§»åˆ° cri-dockerd | Kubernetes ä½¿ç”¨ kubeadm å¼•å¯¼é›†ç¾¤ | Kubernetes ubuntuå®‰è£…æŒ‡å®šç‰ˆæœ¬docker(åŒ…å«å®˜æ–¹/å›½å†…å®‰è£…æ–¹æ³•)_ubuntu 18.04 å®‰è£…docker 20.10.7-CSDNåšå®¢ ubuntu 20.4å®‰è£…k8s 1.24.0ã€1.28.0ï¼ˆä½¿ç”¨containerdï¼‰_ubuntu containerd å®‰è£…-CSDNåšå®¢ kubeadm éƒ¨ç½²k8s v1.28.3é›†ç¾¤ - å°å‰çŒ« - åšå®¢å›­ (cnblogs.com) å¦‚ä½•å‘Kubernetesé›†ç¾¤ä¸­æ·»åŠ masterèŠ‚ç‚¹ï¼ˆåŸé›†ç¾¤åªæœ‰ä¸€ä¸ªmasterèŠ‚ç‚¹ï¼‰ - çŸ¥ä¹ (zhihu.com) [containerd] é•œåƒåŠ é€Ÿ_containerd é•œåƒåŠ é€Ÿ-CSDNåšå®¢ ","date":"2023-12-24T15:08:15+08:00","image":"https://blog-source-mkt.oss-cn-chengdu.aliyuncs.com/blog_source/public/kubernetes/Kubernetes-Scheduling.png","permalink":"/p/%E5%9F%BA%E4%BA%8E-containerd-%E9%83%A8%E7%BD%B2k8s-1.28.1-ubuntu-20.04/","title":"åŸºäº Containerd éƒ¨ç½²k8s 1.28.1 (Ubuntu 20.04)"},{"content":"ä¸»æœºè§„åˆ’ ä¸»æœº IP node1 11.0.1.144 node2 11.0.1.145 node3 11.0.1.146 ç¡®ä¿ Go ç‰ˆæœ¬ 1.15+\netcd é›†ç¾¤è¯ä¹¦ å®‰è£… cfssl 1 apt install golang-cfssl -y ç”Ÿæˆé»˜è®¤è¯ä¹¦ 1 2 cfssl print-defaults config \u0026gt; ca-config.json cfssl print-defaults crs \u0026gt; ca-crs.json ä¿®æ”¹è¯ä¹¦ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 root@ubuntu:~/tls# cat ca-config.json { \u0026#34;signing\u0026#34;: { \u0026#34;default\u0026#34;: { \u0026#34;expiry\u0026#34;: \u0026#34;876000h\u0026#34; }, \u0026#34;profiles\u0026#34;: { \u0026#34;etcdha\u0026#34;: { \u0026#34;expiry\u0026#34;: \u0026#34;876000h\u0026#34;, \u0026#34;usages\u0026#34;: [ \u0026#34;signing\u0026#34;, \u0026#34;key encipherment\u0026#34;, \u0026#34;client auth\u0026#34;, \u0026#34;server auth\u0026#34; ] } } } } root@ubuntu:~/tls# cat ca-csr.json { \u0026#34;CN\u0026#34;: \u0026#34;CA\u0026#34;, \u0026#34;key\u0026#34;: { \u0026#34;algo\u0026#34;: \u0026#34;rsa\u0026#34;, \u0026#34;size\u0026#34;: 2048 }, \u0026#34;names\u0026#34;: [ { \u0026#34;C\u0026#34;: \u0026#34;CN\u0026#34;, \u0026#34;O\u0026#34;: \u0026#34;etcd\u0026#34;, \u0026#34;ST\u0026#34;: \u0026#34;xian\u0026#34;, \u0026#34;L\u0026#34;: \u0026#34;chengdu\u0026#34;, \u0026#34;OU\u0026#34;: \u0026#34;system\u0026#34; } ] } ç”Ÿæˆ CA è¯ä¹¦ 1 cfssl gencert -initca ca-csr.json | cfssljson -bare ca åˆ›å»º etcd è¯ä¹¦ç­¾åè¯·æ±‚ï¼ˆetcd-csr.json) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 root@ubuntu:~/tls# cat etcd-csr.json { \u0026#34;CN\u0026#34;: \u0026#34;etcd\u0026#34;, \u0026#34;hosts\u0026#34;: [ \u0026#34;127.0.0.1\u0026#34;, \u0026#34;11.0.1.144\u0026#34;, \u0026#34;11.0.1.145\u0026#34;, \u0026#34;11.0.1.146\u0026#34; ], \u0026#34;key\u0026#34;: { \u0026#34;algo\u0026#34;: \u0026#34;rsa\u0026#34;, \u0026#34;size\u0026#34;: 2048 }, \u0026#34;names\u0026#34;: [ { \u0026#34;C\u0026#34;: \u0026#34;CN\u0026#34;, \u0026#34;O\u0026#34;: \u0026#34;etcdha\u0026#34; } ] } ä½¿ç”¨ ca è¯ä¹¦ç­¾å‘ etcd è¯ä¹¦ 1 2 3 4 cfssl gencert -ca ca.pem -ca-key ca-key.pem -config ca-config.json -profile etcdha etcd-csr.json | cfssljson -bare etcd root@ubuntu:~/tls# ls ca-config.json ca.csr ca-csr.json ca-key.pem ca.pem etcd.csr etcd-csr.json etcd-key.pem etcd.pem å¤åˆ¶è¯ä¹¦ 1 2 3 4 5 6 7 mkdir /opt/etcd -p cp etcd*.pem ca*.pem /opt/etcd/ssl/ cd /opt/etcd/ssl # ç¡®ä¿äº‹å…ˆæœ‰ç›¸åº”ç›®å½• scp *.pem root@11.0.1.145:/opt/etcd/ssl/ scp *.pem root@11.0.1.146:/opt/etcd/ssl/ etcd HA éƒ¨ç½² å®‰è£… etcd 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 ETCD_VER=v3.5.11 # choose either URL GOOGLE_URL=https://storage.googleapis.com/etcd GITHUB_URL=https://github.com/etcd-io/etcd/releases/download DOWNLOAD_URL=${GOOGLE_URL} rm -f /tmp/etcd-${ETCD_VER}-linux-amd64.tar.gz rm -rf /tmp/etcd-download-test \u0026amp;\u0026amp; mkdir -p /tmp/etcd-download-test curl -L ${DOWNLOAD_URL}/${ETCD_VER}/etcd-${ETCD_VER}-linux-amd64.tar.gz -o /tmp/etcd-${ETCD_VER}-linux-amd64.tar.gz tar xzvf /tmp/etcd-${ETCD_VER}-linux-amd64.tar.gz -C /tmp/etcd-download-test --strip-components=1 rm -f /tmp/etcd-${ETCD_VER}-linux-amd64.tar.gz /tmp/etcd-download-test/etcd --version /tmp/etcd-download-test/etcdctl version /tmp/etcd-download-test/etcdutl version mv /tmp/etcd-download-test/etcd /bin/ mv /tmp/etcd-download-test/etcdctl /bin/ mv /tmp/etcd-download-test/etcdutl /bin/ åˆ†åˆ«åœ¨å„ä¸ªèŠ‚ç‚¹å¯åŠ¨ etcd node1:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 nohup etcd --name infra0 \\ --data-dir=/tmp/etcd/infra0 \\ --listen-peer-urls https://11.0.1.144:2380 \\ --initial-advertise-peer-urls https://11.0.1.144:2380 \\ --listen-client-urls https://11.0.1.144:2379 \\ --advertise-client-urls https://11.0.1.144:2379 \\ --initial-cluster-token etcd-cluster-1 \\ --initial-cluster infra0=https://11.0.1.144:2380,infra1=https://11.0.1.145:2380,infra2=https://11.0.1.146:2380 \\ --initial-cluster-state new \\ --client-cert-auth --trusted-ca-file=/opt/etcd/ssl/ca.pem \\ --cert-file=/opt/etcd/ssl/etcd.pem \\ --key-file=/opt/etcd/ssl/etcd-key.pem \\ --peer-client-cert-auth --peer-trusted-ca-file=/opt/etcd/ssl/ca.pem \\ --peer-cert-file=/opt/etcd/ssl/etcd.pem \\ --peer-key-file=/opt/etcd/ssl/etcd-key.pem 2\u0026gt;\u0026amp;1 \u0026gt; /var/log/infra0.log \u0026amp; node2:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 nohup etcd --name infra1 \\ --data-dir=/tmp/etcd/infra1 \\ --listen-peer-urls https://11.0.1.145:2380 \\ --initial-advertise-peer-urls https://11.0.1.145:2380 \\ --listen-client-urls https://11.0.1.145:2379 \\ --advertise-client-urls https://11.0.1.145:2379 \\ --initial-cluster-token etcd-cluster-1 \\ --initial-cluster infra0=https://11.0.1.144:2380,infra1=https://11.0.1.145:2380,infra2=https://11.0.1.146:2380 \\ --initial-cluster-state new \\ --client-cert-auth --trusted-ca-file=/opt/etcd/ssl/ca.pem \\ --cert-file=/opt/etcd/ssl/etcd.pem \\ --key-file=/opt/etcd/ssl/etcd-key.pem \\ --peer-client-cert-auth --peer-trusted-ca-file=/opt/etcd/ssl/ca.pem \\ --peer-cert-file=/opt/etcd/ssl/etcd.pem \\ --peer-key-file=/opt/etcd/ssl/etcd-key.pem 2\u0026gt;\u0026amp;1 \u0026gt; /var/log/infra1.log \u0026amp; node3:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 nohup etcd --name infra2 \\ --data-dir=/tmp/etcd/infra2 \\ --listen-peer-urls https://11.0.1.146:2380 \\ --initial-advertise-peer-urls https://11.0.1.146:2380 \\ --listen-client-urls https://11.0.1.146:2379 \\ --advertise-client-urls https://11.0.1.146:2379 \\ --initial-cluster-token etcd-cluster-1 \\ --initial-cluster infra0=https://11.0.1.144:2380,infra1=https://11.0.1.145:2380,infra2=https://11.0.1.146:2380 \\ --initial-cluster-state new \\ --client-cert-auth --trusted-ca-file=/opt/etcd/ssl/ca.pem \\ --cert-file=/opt/etcd/ssl/etcd.pem \\ --key-file=/opt/etcd/ssl/etcd-key.pem \\ --peer-client-cert-auth --peer-trusted-ca-file=/opt/etcd/ssl/ca.pem \\ --peer-cert-file=/opt/etcd/ssl/etcd.pem \\ --peer-key-file=/opt/etcd/ssl/etcd-key.pem 2\u0026gt;\u0026amp;1 \u0026gt; /var/log/infra2.log \u0026amp; æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ 1 2 3 4 5 6 7 8 root@ubuntu:/opt/etcd/ssl# etcdctl --endpoints=https://11.0.1.144:2379 --cacert /opt/etcd/ssl/ca.pem --cert /opt/etcd/ssl/etcd.pem --key /opt/etcd/ssl/etcd-key.pem member list -wtable +------------------+---------+--------+-------------------------+-------------------------+------------+ | ID | STATUS | NAME | PEER ADDRS | CLIENT ADDRS | IS LEARNER | +------------------+---------+--------+-------------------------+-------------------------+------------+ | 68e936a39e332ee | started | infra1 | https://11.0.1.145:2380 | https://11.0.1.145:2379 | false | | 65d6166ada62ab60 | started | infra0 | https://11.0.1.144:2380 | https://11.0.1.144:2379 | false | | 8a036567f69e370a | started | infra2 | https://11.0.1.146:2380 | https://11.0.1.146:2379 | false | +------------------+---------+--------+-------------------------+-------------------------+------------+ etcd é›†ç¾¤å¤‡ä»½ä¸æ¢å¤ æ’å…¥æ•°æ® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 root@ubuntu:~# etcdctl --endpoints=https://11.0.1.144:2379 --cacert /opt/etcd/ssl/ca.pem --cert /opt/etcd/ssl/etcd.pem --key /opt/etcd/ssl/etcd-key.pem put /test1 val1 OK root@ubuntu:~# etcdctl --endpoints=https://11.0.1.144:2379 --cacert /opt/etcd/ssl/ca.pem --cert /opt/etcd/ssl/etcd.pem --key /opt/etcd/ssl/etcd-key.pem put /test2 val2 OK root@ubuntu:~# etcdctl --endpoints=https://11.0.1.144:2379 --cacert /opt/etcd/ssl/ca.pem --cert /opt/etcd/ssl/etcd.pem --key /opt/etcd/ssl/etcd-key.pem put /test1/t1 val1/v1 OK root@ubuntu:~# etcdctl --endpoints=https://11.0.1.144:2379 --cacert /opt/etcd/ssl/ca.pem --cert /opt/etcd/ssl/etcd.pem --key /opt/etcd/ssl/etcd-key.pem get --prefix /test /test1 val1 /test1/t1 val1/v1 /test2 val2 å¤‡ä»½ etcd æ•°æ® 1 2 3 4 etcdctl --endpoints=https://11.0.1.144:2379 --cacert /opt/etcd/ssl/ca.pem --cert /opt/etcd/ssl/etcd.pem --key /opt/etcd/ssl/etcd-key.pem snapshot save /tmp/snapshot.db scp /tmp/snapshot.db root@11.0.1.145:/tmp/ scp /tmp/snapshot.db root@11.0.1.146:/tmp/ æ€æ‰ä¸ªèŠ‚ç‚¹ etcd è¿›ç¨‹ 1 2 ps -ef | grep infra | grep -v grep | awk \u0026#39;{print $2}\u0026#39; | xargs kill -9 ps -ef | grep etcd åˆ é™¤ etcd æ•°æ® 1 rm -rf /tmp/etcd æ¢å¤ etcd æ•°æ® node1:\n1 2 3 4 5 6 7 export ETCDCTL_API=3 etcdctl snapshot restore /tmp/snapshot.db \\ --name infra0 \\ --data-dir=/tmp/etcd/infra0 \\ --initial-cluster infra0=https://11.0.1.144:2380,infra1=https://11.0.1.145:2379,infra2=https://11.0.1.146:2379 \\ --initial-cluster-token etcd-cluster-1 \\ --initial-advertise-peer-urls https://11.0.1.144:2380 node2:\n1 2 3 4 5 6 7 export ETCDCTL_API=3 etcdctl snapshot restore /tmp/snapshot.db \\ --name infra1 \\ --data-dir=/tmp/etcd/infra1 \\ --initial-cluster infra0=https://11.0.1.144:2380,infra1=https://11.0.1.145:2380,infra2=https://11.0.1.146:2380 \\ --initial-cluster-token etcd-cluster-1 \\ --initial-advertise-peer-urls https://11.0.1.145:2380 node3:\n1 2 3 4 5 6 7 export ETCDCTL_API=3 etcdctl snapshot restore /tmp/snapshot.db \\ --name infra2 \\ --data-dir=/tmp/etcd/infra2 \\ --initial-cluster infra0=https://11.0.1.144:2380,infra1=https://11.0.1.145:2380,infra2=https://11.0.1.146:2380 \\ --initial-cluster-token etcd-cluster-1 \\ --initial-advertise-peer-urls https://11.0.1.146:2380 é‡å¯ etcd node1:\n1 2 3 4 5 6 7 8 9 10 11 nohup etcd --name infra0 \\ --data-dir=/tmp/etcd/infra0 \\ --listen-peer-urls https://11.0.1.144:2380 \\ --listen-client-urls https://11.0.1.144:2379 \\ --advertise-client-urls https://11.0.1.144:2379 \\ --client-cert-auth --trusted-ca-file=/opt/etcd/ssl/ca.pem \\ --cert-file=/opt/etcd/ssl/etcd.pem \\ --key-file=/opt/etcd/ssl/etcd-key.pem \\ --peer-client-cert-auth --peer-trusted-ca-file=/opt/etcd/ssl/ca.pem \\ --peer-cert-file=/opt/etcd/ssl/etcd.pem \\ --peer-key-file=/opt/etcd/ssl/etcd-key.pem 2\u0026gt;\u0026amp;1 \u0026gt; /var/log/infra0.log \u0026amp; node2:\n1 2 3 4 5 6 7 8 9 10 11 nohup etcd --name infra1 \\ --data-dir=/tmp/etcd/infra1 \\ --listen-peer-urls https://11.0.1.145:2380 \\ --listen-client-urls https://11.0.1.145:2379 \\ --advertise-client-urls https://11.0.1.145:2379 \\ --client-cert-auth --trusted-ca-file=/opt/etcd/ssl/ca.pem \\ --cert-file=/opt/etcd/ssl/etcd.pem \\ --key-file=/opt/etcd/ssl/etcd-key.pem \\ --peer-client-cert-auth --peer-trusted-ca-file=/opt/etcd/ssl/ca.pem \\ --peer-cert-file=/opt/etcd/ssl/etcd.pem \\ --peer-key-file=/opt/etcd/ssl/etcd-key.pem 2\u0026gt;\u0026amp;1 \u0026gt; /var/log/infra1.log \u0026amp; node3:\n1 2 3 4 5 6 7 8 9 10 11 nohup etcd --name infra2 \\ --data-dir=/tmp/etcd/infra2 \\ --listen-peer-urls https://11.0.1.146:2380 \\ --listen-client-urls https://11.0.1.146:2379 \\ --advertise-client-urls https://11.0.1.146:2379 \\ --client-cert-auth --trusted-ca-file=/opt/etcd/ssl/ca.pem \\ --cert-file=/opt/etcd/ssl/etcd.pem \\ --key-file=/opt/etcd/ssl/etcd-key.pem \\ --peer-client-cert-auth --peer-trusted-ca-file=/opt/etcd/ssl/ca.pem \\ --peer-cert-file=/opt/etcd/ssl/etcd.pem \\ --peer-key-file=/opt/etcd/ssl/etcd-key.pem 2\u0026gt;\u0026amp;1 \u0026gt; /var/log/infra2.log \u0026amp; æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 root@ubuntu:/tmp# etcdctl --endpoints=https://11.0.1.146:2379 --cacert /opt/etcd/ssl/ca.pem --cert /opt/etcd/ssl/etcd.pem --key /opt/etcd/ssl/etcd-key.pem member list -wtable +------------------+-----------+--------+-------------------------+-------------------------+------------+ | ID | STATUS | NAME | PEER ADDRS | CLIENT ADDRS | IS LEARNER | +------------------+-----------+--------+-------------------------+-------------------------+------------+ | 68e936a39e332ee | started | infra1 | https://11.0.1.145:2380 | https://11.0.1.145:2379 | false | | 65d6166ada62ab60 | unstarted | | https://11.0.1.144:2380 | | false | | 8a036567f69e370a | started | infra2 | https://11.0.1.146:2380 | https://11.0.1.146:2379 | false | +------------------+-----------+--------+-------------------------+-------------------------+------------+ root@ubuntu:/tmp# etcdctl --endpoints=https://11.0.1.146:2379 --cacert /opt/etcd/ssl/ca.pem --cert /opt/etcd/ssl/etcd.pem --key /opt/etcd/ssl/etcd-key.pem get --prefix / /test1 val1 /test1/t1 val1/v1 /test2 val2 infra0æœªå¯åŠ¨æˆåŠŸ, å…¶ä½™ä¸¤ä¸ªèŠ‚ç‚¹æ­£å¸¸, åŸå› æœªçŸ¥, å¾…å¤§ä½¬æŒ‡æ­£\nå‚è€ƒ:\netcdä½¿ç”¨Cfsslç”Ÿæˆè‡ªç­¾è¯ä¹¦(pem) - è¥¿ç“œå›~ - åšå®¢å›­ (cnblogs.com) [svc]è¯ä¹¦å„ä¸ªå­—æ®µçš„å«ä¹‰ - _æ¯›å° - åšå®¢å›­ (cnblogs.com) ","date":"2023-12-20T18:25:32+08:00","image":"https://blog-source-mkt.oss-cn-chengdu.aliyuncs.com/blog_source/public/etcd-v3-confusion.png","permalink":"/p/etcd%E9%AB%98%E5%8F%AF%E7%94%A8%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/","title":"Etcdé«˜å¯ç”¨é›†ç¾¤éƒ¨ç½²"},{"content":"Dockerfile ç›®æ ‡ï¼šæ˜“ç®¡ç†ã€å°‘æ¼æ´ã€é•œåƒå°ã€å±‚çº§å°‘ã€åˆ©ç”¨ç¼“å­˜ã€‚ Dockerfile æœ€ä½³å®è·µ ä¸è¦å®‰è£…æ— æ•ˆè½¯ä»¶åŒ…ã€‚\nåº”ç®€åŒ–é•œåƒä¸­åŒæ—¶è¿è¡Œçš„è¿›ç¨‹æ•°ï¼Œç†æƒ³çŠ¶å†µä¸‹ï¼Œæ¯ä¸ªé•œåƒåº”è¯¥åªæœ‰ä¸€ä¸ªè¿›ç¨‹ã€‚\nå½“æ— æ³•é¿å…åŒä¸€é•œåƒè¿è¡Œå¤šè¿›ç¨‹æ—¶ï¼Œåº”é€‰æ‹©åˆç†çš„åˆå§‹åŒ–è¿›ç¨‹ï¼ˆinitprocessï¼‰ã€‚\næœ€å°åŒ–å±‚çº§æ•°\næœ€æ–°çš„dockeråªæœ‰RUNï¼ŒCOPYï¼ŒADDåˆ›å»ºæ–°å±‚ï¼Œå…¶ä»–æŒ‡ä»¤åˆ›å»ºä¸´æ—¶å±‚ï¼Œä¸ä¼šå¢åŠ é•œåƒå¤§å°ã€‚ æ¯”å¦‚EXPOSEæŒ‡ä»¤å°±ä¸ä¼šç”Ÿæˆæ–°å±‚ã€‚ å¤šæ¡RUNå‘½ä»¤å¯é€šè¿‡è¿æ¥ç¬¦è¿æ¥æˆä¸€æ¡æŒ‡ä»¤é›†ä»¥å‡å°‘å±‚æ•°ã€‚ é€šè¿‡å¤šæ®µæ„å»ºå‡å°‘é•œåƒå±‚æ•°ã€‚ æŠŠå¤šè¡Œå‚æ•°æŒ‰å­—æ¯æ’åºï¼Œå¯ä»¥å‡å°‘å¯èƒ½å‡ºç°çš„é‡å¤å‚æ•°ï¼Œå¹¶ä¸”æé«˜å¯è¯»æ€§ã€‚\nç¼–å†™dockerfileçš„æ—¶å€™ï¼Œåº”è¯¥æŠŠå˜æ›´é¢‘ç‡ä½çš„ç¼–è¯‘æŒ‡ä»¤ä¼˜å…ˆæ„å»ºä»¥ä¾¿æ”¾åœ¨é•œåƒåº•å±‚ä»¥æœ‰æ•ˆåˆ©ç”¨buildcacheã€‚\nå¤åˆ¶æ–‡ä»¶æ—¶ï¼Œæ¯ä¸ªæ–‡ä»¶åº”ç‹¬ç«‹å¤åˆ¶ï¼Œè¿™ç¡®ä¿æŸä¸ªæ–‡ä»¶å˜æ›´æ—¶ï¼Œåªå½±å“æ”¹æ–‡ä»¶å¯¹åº”çš„ç¼“å­˜ã€‚\nç†è§£ Dockerfile Dockerfile å¯ä»¥çœ‹æˆæ„å»ºé•œåƒçš„ä¸€æ¡æ¡æŒ‡ä»¤, ç»“åˆ docker é•œåƒæ‰“åŒ…ç†è§£, ä¸€æ¡æŒ‡ä»¤å¤§å¤šå¯¹åº”ä¸€å±‚, è¿½æ±‚å…±ç”¨å±‚\nå±‚çš„æ¦‚å¿µ:\ndocker build æ„å»ºé•œåƒ 1 $ docker build [é€‰é¡¹] \u0026lt;ä¸Šä¸‹æ–‡è·¯å¾„/URL/-\u0026gt; é€šè¿‡ docker build æ„å»ºé•œåƒä¼šè‡ªåŠ¨æ‰«æ Dockerfile åŠå…¶ç›®å½•ä¸‹çš„å­ç›®å½•, é€šå¸¸å°† Dockerfile ç½®äºé¡¹ç›®æ ¹ç›®å½•, å¦‚æœæ–‡ä»¶æ–‡ä»¶è¿‡å¤š, é•œåƒè¿‡ç¨‹ä¹Ÿä¼šå˜æ…¢\nDockerfile å¸¸ç”¨æŒ‡ä»¤ From æŒ‡å®šé•œåƒ, é»˜è®¤ä» docker hub ä¸Šæ‹‰å»\nLABEL ç”¨äºä¸ºé•œåƒæ·»åŠ å…ƒæ•°æ®\n1 æ ¼å¼: LABEL \u0026lt;key\u0026gt;=\u0026lt;value\u0026gt; \u0026lt;key\u0026gt;=\u0026lt;value\u0026gt; \u0026lt;key\u0026gt;=\u0026lt;value\u0026gt; ... é…åˆ label filter è¿›è¡Œè¿‡æ»¤\n1 $ docker images -f label=multi.label1=\u0026#34;value1\u0026#34; æ³¨ï¼š\nä½¿ç”¨LABELæŒ‡å®šå…ƒæ•°æ®æ—¶ï¼Œä¸€æ¡LABELæŒ‡å®šå¯ä»¥æŒ‡å®šä¸€æˆ–å¤šæ¡å…ƒæ•°æ®ï¼ŒæŒ‡å®šå¤šæ¡å…ƒæ•°æ®æ—¶ä¸åŒå…ƒæ•°æ®\nä¹‹é—´é€šè¿‡ç©ºæ ¼åˆ†éš”ã€‚æ¨èå°†æ‰€æœ‰çš„å…ƒæ•°æ®é€šè¿‡ä¸€æ¡LABELæŒ‡ä»¤æŒ‡å®šï¼Œä»¥å…ç”Ÿæˆè¿‡å¤šçš„ä¸­é—´é•œåƒã€‚\nENV è®¾ç½®ç¯å¢ƒå˜é‡\nRUN æ„å»ºé•œåƒæ—¶æ‰§è¡Œçš„å‘½ä»¤\n1 2 3 4 5 6 æ ¼å¼ï¼š RUN [\u0026#34;executable\u0026#34;, \u0026#34;param1\u0026#34;, \u0026#34;param2\u0026#34;] ç¤ºä¾‹ï¼š RUN [\u0026#34;executable\u0026#34;, \u0026#34;param1\u0026#34;, \u0026#34;param2\u0026#34;] RUN apk update RUN [\u0026#34;/etc/execfile\u0026#34;, \u0026#34;arg1\u0026#34;, \u0026#34;arg1\u0026#34;] æ³¨ï¼šRUNæŒ‡ä»¤åˆ›å»ºçš„ä¸­é—´é•œåƒä¼šè¢«ç¼“å­˜ï¼Œå¹¶ä¼šåœ¨ä¸‹æ¬¡æ„å»ºä¸­ä½¿ç”¨ã€‚å¦‚æœä¸æƒ³ä½¿ç”¨è¿™äº›ç¼“å­˜é•œåƒï¼Œ\nå¯ä»¥åœ¨æ„å»ºæ—¶æŒ‡å®š\u0026ndash;no-cacheå‚æ•°ï¼Œå¦‚ï¼šdocker build \u0026ndash;no-cache\nCMD æ„å»ºé•œåƒåè°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯åœ¨å®¹å™¨å¯åŠ¨æ—¶æ‰è¿›è¡Œè°ƒç”¨ã€‚\n1 2 3 4 5 6 7 æ ¼å¼ï¼š CMD [\u0026#34;executable\u0026#34;,\u0026#34;param1\u0026#34;,\u0026#34;param2\u0026#34;] (æ‰§è¡Œå¯æ‰§è¡Œæ–‡ä»¶ï¼Œä¼˜å…ˆ) CMD [\u0026#34;param1\u0026#34;,\u0026#34;param2\u0026#34;] (è®¾ç½®äº†ENTRYPOINTï¼Œåˆ™ç›´æ¥è°ƒç”¨ENTRYPOINTæ·»åŠ å‚æ•°) CMD command param1 param2 (æ‰§è¡Œshellå†…éƒ¨å‘½ä»¤) ç¤ºä¾‹ï¼š CMD echo \u0026#34;This is a test.\u0026#34; | wc -l CMD [\u0026#34;/usr/bin/wc\u0026#34;,\u0026#34;--help\u0026#34;] æ³¨ï¼šCMDä¸åŒäºRUNï¼ŒCMDç”¨äºæŒ‡å®šåœ¨å®¹å™¨å¯åŠ¨æ—¶æ‰€è¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œè€ŒRUNç”¨äºæŒ‡å®šé•œåƒæ„å»ºæ—¶æ‰€è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚\nENTRYPOINT é•œåƒçš„ç¬¬ä¸€ä¸ªè¿›ç¨‹\n1 2 3 4 5 6 7 8 æ ¼å¼ï¼š ENTRYPOINT [\u0026#34;executable\u0026#34;, \u0026#34;param1\u0026#34;, \u0026#34;param2\u0026#34;] (å¯æ‰§è¡Œæ–‡ä»¶, ä¼˜å…ˆ) ENTRYPOINT command param1 param2 (shellå†…éƒ¨å‘½ä»¤) ç¤ºä¾‹ï¼š FROM ubuntu ENTRYPOINT [\u0026#34;ls\u0026#34;, \u0026#34;/usr/local\u0026#34;] CMD [\u0026#34;/usr/local/tomcat\u0026#34;] ä¹‹åï¼Œdocker run ä¼ é€’çš„å‚æ•°ï¼Œéƒ½ä¼šå…ˆè¦†ç›–cmd,ç„¶åç”±cmd ä¼ é€’ç»™entrypoint ,åšåˆ°çµæ´»åº”ç”¨ æ³¨ï¼šENTRYPOINTä¸CMDéå¸¸ç±»ä¼¼ï¼Œä¸åŒçš„æ˜¯é€šè¿‡docker runæ‰§è¡Œçš„å‘½ä»¤ä¸ä¼šè¦†ç›–ENTRYPOINTï¼Œ\nè€Œdocker runå‘½ä»¤ä¸­æŒ‡å®šçš„ä»»ä½•å‚æ•°ï¼Œéƒ½ä¼šè¢«å½“åšå‚æ•°å†æ¬¡ä¼ é€’ç»™CMDã€‚\nDockerfileä¸­åªå…è®¸æœ‰ä¸€ä¸ªENTRYPOINTå‘½ä»¤ï¼Œå¤šæŒ‡å®šæ—¶ä¼šè¦†ç›–å‰é¢çš„è®¾ç½®ï¼Œ\nè€Œåªæ‰§è¡Œæœ€åçš„ENTRYPOINTæŒ‡ä»¤ã€‚\né€šå¸¸æƒ…å†µä¸‹ï¼Œ\tENTRYPOINT ä¸CMDä¸€èµ·ä½¿ç”¨ï¼ŒENTRYPOINT å†™é»˜è®¤å‘½ä»¤ï¼Œå½“éœ€è¦å‚æ•°æ—¶å€™ ä½¿ç”¨CMDä¼ å‚\nDockerfile: ENTRYPOINTå’ŒCMDçš„åŒºåˆ« - çŸ¥ä¹ (zhihu.com)\nWORKDIR å·¥ä½œç›®å½•ï¼Œç±»ä¼¼äºcdå‘½ä»¤\nADD å°†æœ¬åœ°æ–‡ä»¶æ·»åŠ åˆ°å®¹å™¨ä¸­ï¼Œtarç±»å‹æ–‡ä»¶ä¼šè‡ªåŠ¨è§£å‹(ç½‘ç»œå‹ç¼©èµ„æºä¸ä¼šè¢«è§£å‹)ï¼Œå¯ä»¥è®¿é—®ç½‘ç»œèµ„æºï¼Œç±»ä¼¼wget\n1 2 3 4 5 6 7 8 æ ¼å¼ï¼š ADD \u0026lt;src\u0026gt;... \u0026lt;dest\u0026gt; ADD [\u0026#34;\u0026lt;src\u0026gt;\u0026#34;,... \u0026#34;\u0026lt;dest\u0026gt;\u0026#34;] ç”¨äºæ”¯æŒåŒ…å«ç©ºæ ¼çš„è·¯å¾„ ç¤ºä¾‹ï¼š ADD hom* /mydir/ # æ·»åŠ æ‰€æœ‰ä»¥\u0026#34;hom\u0026#34;å¼€å¤´çš„æ–‡ä»¶ ADD hom?.txt /mydir/ # ? æ›¿ä»£ä¸€ä¸ªå•å­—ç¬¦,ä¾‹å¦‚ï¼š\u0026#34;home.txt\u0026#34; ADD test relativeDir/ # æ·»åŠ  \u0026#34;test\u0026#34; åˆ° `WORKDIR`/relativeDir/ ADD test /absoluteDir/ # æ·»åŠ  \u0026#34;test\u0026#34; åˆ° /absoluteDir/ COPY ä¸ ADD ç›¸ä¼¼, ä½†ä¸èƒ½è®¿é—®ç½‘ç»œèµ„æº, ä¹Ÿä¸èƒ½è§£å‹, ä»¥ ADD ç›¸æ¯”, è¡Œä¸ºç®€å•, å› æ­¤å¯æ§, æ¨èä½¿ç”¨\nVOLUME æŒ‚è½½\n1 2 3 4 VOLUME [\u0026#34;/path/to/dir\u0026#34;] ç¤ºä¾‹: VOLUME [\u0026#34;/data\u0026#34;] VOLUME [\u0026#34;/var/www\u0026#34;, \u0026#34;/var/log/apache2\u0026#34;, \u0026#34;/etc/apache2\u0026#34; æ³¨ï¼šä¸€ä¸ªå·å¯ä»¥å­˜åœ¨äºä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨çš„æŒ‡å®šç›®å½•ï¼Œè¯¥ç›®å½•å¯ä»¥ç»•è¿‡è”åˆæ–‡ä»¶ç³»ç»Ÿï¼Œå¹¶å…·æœ‰ä»¥ä¸‹åŠŸèƒ½ï¼š\nå·å¯ä»¥å®¹å™¨é—´å…±äº«å’Œé‡ç”¨ å®¹å™¨å¹¶ä¸ä¸€å®šè¦å’Œå…¶å®ƒå®¹å™¨å…±äº«å· ä¿®æ”¹å·åä¼šç«‹å³ç”Ÿæ•ˆ å¯¹å·çš„ä¿®æ”¹ä¸ä¼šå¯¹é•œåƒäº§ç”Ÿå½±å“ å·ä¼šä¸€ç›´å­˜åœ¨ï¼Œç›´åˆ°æ²¡æœ‰ä»»ä½•å®¹å™¨åœ¨ä½¿ç”¨å®ƒ EXPOSE æš´éœ²ç«¯å£\n1 EXPOSE \u0026lt;port\u0026gt; [\u0026lt;port\u0026gt;...] æ³¨ï¼šEXPOSEå¹¶ä¸ä¼šè®©å®¹å™¨çš„ç«¯å£è®¿é—®åˆ°ä¸»æœºã€‚è¦ä½¿å…¶å¯è®¿é—®ï¼Œéœ€è¦åœ¨docker runè¿è¡Œå®¹å™¨æ—¶é€šè¿‡-pæ¥å‘å¸ƒè¿™äº›ç«¯å£ï¼Œæˆ–é€šè¿‡-På‚æ•°æ¥å‘å¸ƒEXPOSEå¯¼å‡ºçš„æ‰€æœ‰ç«¯å£\nå¦‚æœæ²¡æœ‰æš´éœ²ç«¯å£ï¼ŒåæœŸä¹Ÿå¯ä»¥é€šè¿‡-p 8080:80æ–¹å¼æ˜ å°„ç«¯å£ï¼Œä½†æ˜¯ä¸èƒ½é€šè¿‡-På½¢å¼æ˜ å°„\nUSER æŒ‡å®šè¿è¡Œå®¹å™¨çš„ç”¨æˆ·/ç»„, ä¸æŒ‡å®šé»˜è®¤ root, æŒ‡å®šçš„ Dockerfile ä¸­å…¶åçš„å‘½ä»¤RUNã€CMDã€ENTRYPOINTéƒ½å°†ä½¿ç”¨è¯¥ç”¨æˆ·, å¢å¼ºå®¹å™¨çš„å®‰å…¨æ€§è€ƒè™‘, åšåˆ° POLP(æœ€å°ç‰¹æƒåŸåˆ™)ã€‚\næ³¨ï¼š é•œåƒæ„å»ºå®Œæˆåï¼Œé€šè¿‡docker runè¿è¡Œå®¹å™¨æ—¶ï¼Œå¯ä»¥é€šè¿‡-uå‚æ•°æ¥è¦†ç›–æ‰€æŒ‡å®šçš„ç”¨æˆ·ã€‚\nARG ç”¨äºæŒ‡å®šä¼ é€’ç»™æ„å»ºè¿è¡Œæ—¶çš„å˜é‡(ç»™dockerfileä¼ å‚)ï¼Œç›¸å½“äºæ„å»ºé•œåƒæ—¶å¯ä»¥åœ¨å¤–éƒ¨ä¸ºé‡Œé¢ä¼ å‚\n1 2 3 4 5 6 7 8 9 From centos:7 ARG parameter VOLUME /usr/share/nginx RUN yum -y install $parameter EXPOSE 80 443 CMD nginx -g \u0026#34;daemon off;\u0026#34; # å¯ä»¥è¿™å¦‚ä¸‹è¿™æ ·çµæ´»ä¼ å‚ docker build --build-arg=parameter=net-tools -t nginx:01 . Dockerfile æ¨¡ç‰ˆ äºŒè¿›åˆ¶æ„å»º nginx 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 # Base images åŸºç¡€é•œåƒ FROM centos #MAINTAINER ç»´æŠ¤è€…ä¿¡æ¯ MAINTAINER Ai-feier #ENV è®¾ç½®ç¯å¢ƒå˜é‡ ENV PATH /usr/local/nginx/sbin:$PATH #ADD æ–‡ä»¶æ”¾åœ¨å½“å‰ç›®å½•ä¸‹ï¼Œæ‹·è¿‡å»ä¼šè‡ªåŠ¨è§£å‹ ADD nginx-1.8.0.tar.gz /usr/local/ ADD epel-release-latest-7.noarch.rpm /usr/local/ #RUN æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ RUN rpm -ivh /usr/local/epel-release-latest-7.noarch.rpm RUN yum install -y wget lftp gcc gcc-c++ make openssl-devel pcre-devel pcre \u0026amp;\u0026amp; yum clean all RUN useradd -s /sbin/nologin -M www #WORKDIR ç›¸å½“äºcd WORKDIR /usr/local/nginx-1.8.0 RUN ./configure --prefix=/usr/local/nginx --user=www --group=www --with-http_ssl_module --with-pcre \u0026amp;\u0026amp; make \u0026amp;\u0026amp; make install RUN echo \u0026#34;daemon off;\u0026#34; \u0026gt;\u0026gt; /etc/nginx.conf #EXPOSE æ˜ å°„ç«¯å£ EXPOSE 80 #CMD è¿è¡Œä»¥ä¸‹å‘½ä»¤ CMD [\u0026#34;nginx\u0026#34;] apt æ„å»º nginx 1 2 3 4 5 6 # Base images åŸºç¡€é•œåƒ FROM ubuntu RUN apt-get update \u0026amp;\u0026amp; apt-get install nginx -y \u0026amp;\u0026amp; apt-get clean CMD [\u0026#34;nginx\u0026#34;] æ„å»ºspringbootåº”ç”¨ 1 2 3 4 5 6 7 8 FROM openjdk:8-jre # jaråŒ…åŸºäºjdk ,waråŒ…åŸºäºtomcat WORKDIR /app ADD demo-0.0.1-SNAPSHOT.jar app.jar # å°†ä¸Šä¸‹æ–‡ä¸­ jaråŒ…å¤åˆ¶åˆ° /appç›®å½•ä¸‹ï¼Œå¹¶ä¸”é‡å‘½åä¸ºapp.jar EXPOSE 8081 # æš´éœ²ç«¯å£ ENTRYPOINT[ \u0026#34;java\u0026#34; , \u0026#34;-jar\u0026#34; ] # å¯åŠ¨åº”ç”¨å›ºå®šå‘½ä»¤ CMD [\u0026#34;app.jar\u0026#34;] # åŠ¨æ€ä¼ é€’jaråŒ…å # CMD [\u0026#34;/bin/sh\u0026#34;,\u0026#34;-c\u0026#34;,\u0026#34;java -jar app.jar\u0026#34;] åœ¨ k8s ä¼˜é›…ç»ˆæ­¢æ—¶, ä¼šå‘é€ terminal ä¿¡å·, ç»™åº”ç”¨è¿›è¡Œä¼˜é›…ç»ˆæ­¢, ä½†æ˜¯, /bin/sh ä¼šæ— è§†è¿™ä¸ªä¿¡å·, æœ€åç›´æ¥è¢« kill æ‰\nDockerfile å¤šæ®µæ„é€  ç›®çš„: å°†é¡¹ç›®ç¼–è¯‘, ä¾èµ–ç­‰, æ”¾åˆ° Dockerfile çš„æ—©æœŸæ„å»º, æœ€åç•™ä¸‹ä¸€ä¸ªå¹²å‡€çš„é•œåƒ, æœ‰æ•ˆå‡å°‘é•œåƒå±‚çº§\nç¤ºä¾‹:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 FROM golang:1.16-alpine AS build RUN apkadd --no-cache git RUN go get github.com/golang/dep/cmd/dep COPY Gopkg.lock Gopkg.toml /go/src/project/ WORKDIR /go/src/project/ RUN dep ensure -vendor-only COPY .. /go/src/project/ RUN go build -o /bin/projectï¼ˆåªæœ‰è¿™ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶æ˜¯äº§çº¿éœ€è¦çš„ï¼Œå…¶ä»–éƒ½æ˜¯wasteï¼‰ FROM scratch # ç›´æ¥æŠŠé•œåƒç¼–è¯‘çš„åŒ…æ‹·è´ä¸‹æ¥ COPY --from=build /bin/project /bin/project ENTRYPOINT [\u0026#34;/bin/project\u0026#34;] CMD [\u0026#34;--help\u0026#34;] æ·±å…¥ [æŒç»­æ›´æ–°\u0026hellip;\u0026hellip;] Dockerfile: åˆ¶ä½œç²¾ç®€é•œåƒ \u0026ndash; CSDN ç»ƒä¹  [æŒç»­æ›´æ–°\u0026hellip;\u0026hellip;] Dockerfile: åˆ¶ä½œç²¾ç®€é•œåƒ \u0026ndash; CSDN Kubernetes WebHook å…¥é—¨ \u0026ndash; å…¥é—¨æ¡ˆä¾‹: apiserver æ¥å…¥ github \u0026ndash; CSDN ","date":"2023-12-18T02:12:07+08:00","image":"https://blog-source-mkt.oss-cn-chengdu.aliyuncs.com/blog_source/public/270-docker_-build_image_thumbnail.png","permalink":"/p/dockerfile/","title":"Dockerfile"},{"content":"docker ç½‘ç»œæ¨¡å¼ æ¨¡å¼ è¯´æ˜ Null(\u0026ndash;net=None) æŠŠå®¹å™¨æ”¾å…¥ç‹¬ç«‹ç½‘ç»œç©ºé—´, ä½†ä¸åšç½‘ç»œé…ç½® Host å¤ç”¨ä¸»æœºç½‘ç»œ Container é‡ç”¨å…¶ä»–å®¹å™¨ç½‘ç»œ Bridge docker å®¹å™¨åˆ›å»ºçš„é»˜è®¤æ¨¡å¼, å®¹å™¨é€šè¿‡ veth pair è¿æ¥åˆ° docker0 ç½‘æ¡¥ veth pair å¯è·¨ net namespace\nBridge docker åˆ›å»ºå®¹å™¨çš„é»˜è®¤æ¨¡å¼\nåˆ›å»º veth pair å°† veth pair çš„ä¸€ç«¯è¿æ¥åˆ° docker0 veth pair å¦ä¸€ç«¯è®¾ç½®ä¸ºå®¹å™¨çš„ eth0 ä¸ºå®¹å™¨æ˜ç©ºé—´çš„ eth0 åˆ†é… ip ä¸»æœºçš„ Iptables è§„åˆ™: PREROUTING-A DOCKER ! -idocker0 -p tcp-m tcp\u0026ndash;dport 2333 -j DNAT \u0026ndash;to destination 172.17.0.2:22 è§£é‡Š: å¦‚æœä½ çš„åè®®æ˜¯ tcp, ç›®æ ‡ç«¯å£æ˜¯ 2333, å°±è½¬åˆ° å®¹å™¨ 172.17.0.2 çš„ 22 ç«¯å£\nä¸º Null æ¨¡å¼é‡æ–°é…ç½®ç½‘ç»œ Create network ns 1 2 mkdir -p /var/run/netns find -L /var/run/netns -type l -delete Start nginx docker with non network mode 1 docker run --network=none -d nginx Check corresponding pid 1 2 3 4 5 6 docker ps|grep nginx docker inspect \u0026lt;containerid\u0026gt;|grep -i pid \u0026#34;Pid\u0026#34;: 876884, \u0026#34;PidMode\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;PidsLimit\u0026#34;: null, Check network config for the container 1 2 3 4 5 6 nsenter -t 558754 -n ip a 1: lo: \u0026lt;LOOPBACK,UP,LOWER_UP\u0026gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 inet 127.0.0.1/8 scope host lo valid_lft forever preferred_lft forever Link network namespace 1 2 3 export pid=558754 ln -s /proc/$pid/ns/net /var/run/netns/$pid ip netns list Check docker bridge on the host 1 2 3 4 5 6 7 8 brctl show ip a 4: docker0: \u0026lt;BROADCAST,MULTICAST,UP,LOWER_UP\u0026gt; mtu 1500 qdisc noqueue state UP group default link/ether 02:42:35:40:d3:8b brd ff:ff:ff:ff:ff:ff inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0 valid_lft forever preferred_lft forever inet6 fe80::42:35ff:fe40:d38b/64 scope link valid_lft forever preferred_lft forever Create veth pair 1 ip link add A type veth peer name B Config A 1 2 brctl addif docker0 A ip link set A up Config B 1 2 3 4 5 6 7 8 9 SETIP=172.17.0.10 SETMASK=16 GATEWAY=172.17.0.1 ip link set B netns $pid ip netns exec $pid ip link set dev B name eth0 ip netns exec $pid ip link set eth0 up ip netns exec $pid ip addr add $SETIP/$SETMASK dev eth0 ip netns exec $pid ip route add default via $GATEWAY Check connectivity 1 curl 172.17.0.10 å®¹å™¨çš„å¤šä¸»æœºé—´é€šä¿¡ Underlay ä¸ºå®¹å™¨çš„é¢„ç•™ä¸€ç«¯ IP, ä¸»æœºå°±æ¸…æ¥šå…¶ IP çš„è·¯ç”±, åˆ™èƒ½è§£å†³ä¸»æœºé—´å®¹å™¨çš„äº’é€š\nOverlay éš§é“æ¨¡å¼, ä¸ºæ•°æ®åŒ…å¤šå°è£…ä¸€å±‚, åœ¨å¯¹ç«¯ä¸»æœºè§£åŒ…\n","date":"2023-12-18T02:11:39+08:00","image":"https://blog-source-mkt.oss-cn-chengdu.aliyuncs.com/blog_source/public/203.docker-networking-1.png","permalink":"/p/docker%E7%BD%91%E7%BB%9C/","title":"Dockerç½‘ç»œ"},{"content":"grep è¯­æ³•æ ¼å¼:\ngrep [option] [pattern] [file1, file2] command | grep [option] [pattern] grep å‚æ•°:\nå‚æ•° å«ä¹‰ -v ä¸æ˜¾ç¤ºåŒ¹é…ä¿¡æ¯ -i å¿½ç•¥å¤§å°å†™ -n æ˜¾ç¤ºè¡Œå· -r é€’å½’æœç´¢ -E æ”¯æŒæ‰©å±•æ­£åˆ™è¡¨è¾¾å¼ (egrep) -F ä¸æŒ‰æ­£åˆ™è¡¨è¾¾å¼åŒ¹é… ä»¥ä¸‹ä¸ºä¸å¸¸ç”¨å‚æ•° -c åªæ˜¾ç¤ºåŒ¹é…è¡Œæ€»æ•° -w åŒ¹é…æ•´è¯ -x åŒ¹é…æ•´è¡Œ -l åªæ˜¾ç¤ºæ–‡ä»¶å, ä¸æ˜¾ç¤ºå†…å®¹ -s ä¸æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ 1 2 3 4 5 $ grep \u0026#39;py.*\u0026#39; file # grep æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼ $ grep -E \u0026#34;python|PYTHON\u0026#34; file # æ”¯æŒæ‰©å±•æ­£åˆ™è¡¨è¾¾å¼ $ grep -F \u0026#34;py.*\u0026#34; file # ä¼šæŒ‰åŸå§‹è¯­ä¹‰æœç´¢ egrep egrep ä¸ grep -E ç­‰ä»·\n1 2 3 $ grep -E \u0026#39;python|PYTHON\u0026#39; file $ egrep \u0026#39;python|PYTHON\u0026#39; file ","date":"2023-12-17T15:17:00+08:00","image":"https://blog-source-mkt.oss-cn-chengdu.aliyuncs.com/blog_source/public/grep%20command%20example%20in%20Linux%20%281%29.png","permalink":"/p/%E6%96%87%E6%9C%AC%E5%A4%84%E7%90%86%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bgrep/","title":"æ–‡æœ¬å¤„ç†ä¸‰å‰‘å®¢ä¹‹grep"},{"content":"sed å·¥ä½œæ¨¡å¼ sed æ˜¯æµç¼–è¾‘å™¨, å¯¹æ ‡å‡†è¾“å‡ºæ–‡ä»¶é€è¡Œå¤„ç†\nåŒ¹é… + æ‰§è¡Œ : é»˜è®¤ä¼šæ‰“å°åŸå§‹ä¿¡æ¯, è¿˜ä¼šæ‰“å°æ‰§è¡Œåçš„ç»“æœ\nè¯­æ³•æ ¼å¼:\nstdout | sed [option] \u0026ldquo;pattern command\u0026rdquo; sed [optoin] \u0026ldquo;pattern command\u0026rdquo; pattern æ˜¯å¯é€‰çš„\nsed å‚æ•° é€‰é¡¹ å«ä¹‰ -n é™é»˜æ¨¡å¼ -e è¿›è¡Œå¤šæ¡åŒ¹é…è§„åˆ™ -f ä½¿ç”¨æ–‡ä»¶, æ–‡ä»¶ä¸ºåŒ¹é…è§„åˆ™ -r æ”¯æŒæ‰©å±•æ­£åˆ™è¡¨è¾¾å¼ -i ç›´æ¥ä¿®æ”¹æ–‡ä»¶å†…å®¹ 1 2 3 4 5 6 7 8 9 10 11 $ sed -n \u0026#39;/python/p\u0026#39; set.txt # p ä¸ºæ‰“å°æ“ä½œ $ sed -n -e \u0026#39;/python/p\u0026#39; -e \u0026#39;/PYTHON/p\u0026#39; sed.txt # æ‰§è¡Œå¤šæ¡ # print.sed: /python/p $ sed -n -f print.sed sed.txt $ sed -n -r \u0026#39;/python|PYTHON/p\u0026#39; sed.txt # g: å…¨éƒ¨ä¿®æ”¹; p: æ‰“å°åˆ°ç»ˆç«¯; -i ç›´æ¥ä¿®æ”¹åˆ°æ–‡ä»¶ $ sed -i \u0026#39;s/love/like/g;p\u0026#39; sed.txt pattern ç”¨æ³• åŒ¹é…æ¨¡å¼\nåŒ¹é…æ¨¡å¼ å«ä¹‰ 10command åŒ¹é…ç¬¬ 10 è¡Œ 10,20command ä»ç¬¬ 10 è¡Œå¼€å§‹, åˆ°ç¬¬ 20 è¡Œç»“æŸ 10,+5command ä»ç¬¬ 10 è¡Œå¼€å§‹, åˆ°ç¬¬ 16 è¡Œç»“æŸ /pattern1/command (//d) åŒ¹é… pattern1 çš„è¡Œ /pattern1/,/pattern2/command (//,//p) åŒ¹é… pattern1 çš„è¡Œå¼€å§‹, åˆ° pattern2 çš„è¡Œç»“æŸ 10,/pattern1/command ä»ç¬¬ 10 è¡Œå¼€å§‹, åˆ°åŒ¹é… pattern1 çš„è¡Œç»“æŸ /pattern1/,10command ä»åŒ¹é… pattern1 çš„è¡Œå¼€å§‹, åˆ°ç¬¬ 10 è¡Œç»“æŸ 1 2 3 4 5 6 7 8 9 10 $ sed -n \u0026#39;10p\u0026#39; /etc/passwd $ sed -n \u0026#39;10,20p\u0026#39; /etc/passwd $ sed -n \u0026#39;10,+5p\u0026#39; /etc/passwd $ sed -n \u0026#39;/^root/p\u0026#39; /etc/passwd $ sed -n \u0026#39;/^root/,/^nginx/p\u0026#39; /etc/passwd $ sed -n \u0026#39;/4,/^nginx/p\u0026#39; /etc/passwd $ sed -n \u0026#39;/^root/,10p\u0026#39; /etc/passwd sed ç¼–è¾‘å‘½ä»¤ æ‰“å° å‘½ä»¤ å«ä¹‰ p æ‰“å° 1 $ sed \u0026#39;/^root/p\u0026#39; /etc/passwd åˆ é™¤ å‘½ä»¤ å«ä¹‰ d åˆ é™¤è¡Œ 1 2 3 $ sed -i \u0026#39;/\\/sbin\\/nologin/d\u0026#39; passwd $ sed -i \u0026#39;/^mail/,/^ftp/d\u0026#39; passwd å¢åŠ  å‘½ä»¤ å«ä¹‰ a è¡Œåè¿½åŠ  i è¡Œå‰è¿½åŠ  r ä»å¤–éƒ¨è¯»å…¥æ–‡ä»¶, è¿½åŠ åˆ°è¡Œå w æŠŠç»“æœå†™åˆ°å¯¹åº”æ–‡ä»¶ 1 2 3 4 5 6 7 $ sed -i \u0026#39;/^root/,/^nginx/a AAAAAA\u0026#39; passwd # åŒ¹é…åˆ°çš„æ¯ä¸€è¡Œåè¿½åŠ  $ sed -i \u0026#39;/^root/,/^nginx/i AAAAAA\u0026#39; passwd # åŒ¹é…åˆ°çš„æ¯ä¸€è¡Œå‰è¿½åŠ  $ sed -i \u0026#39;/root/,/nginx/r ./list\u0026#39; passwd $ sed -n \u0026#39;/\\/bin\\/bash/w /tmp/login\u0026#39; passwd æ˜¾ç¤ºè¡Œå· å‘½ä»¤ å«ä¹‰ = æ˜¾ç¤ºè¡Œå· 1 $ sed \u0026#39;/\\/bin\\/bash/=\u0026#39; passwd ä¿®æ”¹ å‘½ä»¤ å«ä¹‰ s/æ—§/æ–°/ æ›´æ”¹æ¯è¡Œç¬¬ä¸€ä¸ª s/æ—§/æ–°/3 æ›´æ”¹æ¯è¡Œç¬¬ä¸€ä¸ª s/æ—§/æ–°/3 æ›´æ”¹æ¯è¡Œæ‰€æœ‰ s/æ—§/æ–°/2g æ›´æ”¹æ¯è¡Œç¬¬ 2 å¼€å§‹æ‰€æœ‰ s/æ—§/æ–°/ig æ›´æ”¹æ¯è¡Œæ‰€æœ‰, å¿½ç•¥å¤§å°å†™ 1 2 3 4 5 6 7 8 9 $ sed -i \u0026#39;s/HADOOP/hadoop/\u0026#39; file $ sed -i \u0026#39;s/HADOOP/hadoop/2\u0026#39; file $ sed -i \u0026#39;s/HADOOP/hadoop/g\u0026#39; file $ sed -i \u0026#39;s/HADOOP/hadoop/2g\u0026#39; file $ sed -i \u0026#39;s/HADOOP/hadoop/ig\u0026#39; file åå‘å¼•ç”¨ \u0026amp;ä¸\\1 , \\1éœ€è¦ä¸()ä¸€èµ·ä½¿ç”¨(éƒ¨åˆ†å¼•ç”¨æ—¶)\n1 2 3 4 $ sed -i \u0026#39;s/had..../\u0026amp;s/g\u0026#39; file $ sed -i \u0026#39;s/had..../\\1s/g\u0026#39; file $ sed -i \u0026#39;s/\\(had=)..../\\1DOOP/g\u0026#39; file å˜é‡å¼•ç”¨ ç”¨åŒå¼•å· ç”¨å•å¼•å·å˜é‡ 1 2 3 $ sed -i \u0026#34;s/$str1/str2/g\u0026#34; file $ sed -i \u0026#39;s/\u0026#39;$str1\u0026#39;/\u0026#39;$str2\u0026#39;/g\u0026#39; file è„šæœ¬ç»ƒä¹ : æŸ¥è¯¢ mysql é…ç½®æ–‡ä»¶ çŸ¥è¯†ç‚¹:\nåˆ©ç”¨sedè¿›è¡Œæ–‡ä»¶æŸ¥è¯¢\né¢„æœŸ:\n1 2 3 4 mysqld\u0026#39;s num: 22 client\u0026#39;s num: 1 mysql\u0026#39;s num: 1 server\u0026#39;s num: 6 æ€è·¯:\nè·å–æ‰€æœ‰æ®µ æ ¹æ®è·å–çš„æ®µä¿¡æ¯, è·å–æ¯ä¸€æ®µä¸‹çš„é…ç½®é¡¹æ•°ç›® æ‰“å°ç»“æœ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 #!/bin/bash # FILENAME=\u0026#34;/root/sed/my.ini\u0026#34; # 1. è·å–æ‰€æœ‰æ®µ function get_segments { item=`sed -n \u0026#39;/\\[.*\\]/p\u0026#39; $FILENAME | sed \u0026#39;s/\\[//g\u0026#39; | sed \u0026#39;s/\\]//g\u0026#39;` echo $item } # 2. æ ¹æ®è·å–çš„æ®µä¿¡æ¯, è·å–æ¯ä¸€æ®µä¸‹çš„é…ç½®é¡¹æ•°ç›® function count_segment_num { # æ ¹æ® sed çš„èŒƒå›´åŒ¹é… # æ ¹æ®å‚æ•°æä¾›æ®µèŒƒå›´åŒ¹é… | å»é™¤ [ å¼€å¤´ | å»é™¤ # å¼€å¤´ | å»é™¤ç©ºè¡Œ items=`sed -n \u0026#39;/\\[\u0026#39;$1\u0026#39;\\]/,/\\[.*\\]/p\u0026#39; $FILENAME | grep -v \u0026#34;^\\[\u0026#34; | grep -v \u0026#34;^#\u0026#34; | grep -v \u0026#34;^$\u0026#34;` # ç»Ÿè®¡æ‰€æœ‰é¡¹ index=0 for item in $items do index=`expr $index + 1` done echo $index } for seg in `get_segments` do item_count=`count_segment_num $seg` echo \u0026#34;${seg}\u0026#39;s num: $item_count\u0026#34; done sed æ–‡æœ¬ç»ƒä¹  æ–‡æœ¬åˆ é™¤: åˆ é™¤ç©ºè¡Œå’Œæ³¨é‡Šè¡Œ\n1 2 3 4 5 6 7 8 $ sed -i \u0026#39;/^#/d\u0026#39; nginx.conf # åˆ é™¤å¼€å¤´ # $ sed -i \u0026#39;/^$/d\u0026#39; nginx.conf # åˆ é™¤ç©ºè¡Œ $ sed -i \u0026#39;/[:blank]*#/d\u0026#39; nginx.conf # åˆ é™¤ # å‰æœ‰ç©ºæ ¼ # åˆå¹¶å†™æ³• $ sed -i \u0026#39;/[:blank]*#/d;/^$/d\u0026#39; nginx.conf å¯¹ä»¥é # å¼€å¤´è¡ŒåŠ  *\n1 2 # é # : [^#] $ sed -i \u0026#39;s/^[^#]/\\*\u0026amp;/g\u0026#39; nginx.conf æ–‡æœ¬æŸ¥æ‰¾ åŒ¹é…åˆ°ä»¥ root å¼€å§‹çš„è¡Œ, æŠŠ login æ”¹ä¸º LOGIN\n1 sed -i \u0026#39;/^root/s/login/LOGIN/\u0026#39; passwd ä¿®æ”¹ä»¥ root å¼€å§‹çš„è¡Œ, åˆ°åŒ…å« mail çš„è¡Œ, ä¿®æ”¹ bin ä¸º BIN\n1 sed -i \u0026#39;/^root/,/mail/s/bin/BIN/g\u0026#39; passwd æŠŠæ–‡æœ¬ä¸­æ•°å­—åˆ é™¤\n1 sed -i \u0026#39;s/[0-9]*//g\u0026#39; file æ–‡æœ¬è¿½åŠ  æ ¹æ®è¡Œå·\n1 $ sed -i \u0026#39;3,7/a Append\u0026#39; passwd åŒ¹é…åˆ° /bin/bash çš„è¡Œ, æ°”å€™è¿½åŠ  After\n1 $ sed -i \u0026#39;/\\/bin\\/bash/a After\u0026#39; passwd ä»¥ nginx å¼€å¤´çš„è¡Œå‰, æ·»åŠ  Before\n1 $ sed -i \u0026#39;/^nginx/i Before\u0026#39; passwd æ¯ä¸€è¡Œå‰åŠ  Before\n1 $ sed -i \u0026#39;i Before\u0026#39; passwd æŠŠ /etc/fstab å†…å®¹è¿½åŠ åˆ°å« /bin/bash çš„è¡Œå\n1 $ sed -i \u0026#39;/\\/bin\\/bash/r /etc/fstab\u0026#39; passwd **æŠŠ /bin/bash çš„è¡Œ, å†™å…¥ /tmp/sed.txt **\n1 $ sed -i \u0026#39;/\\bin\\/bash/w /tmp/sed.txt\u0026#39; passwd æŠŠç¬¬ 10 è¡Œåˆ°ä»¥ nginx å¼€å¤´çš„è¡Œå†™å…¥ /tmp/sed.txt\n1 $ sed -i \u0026#39;10,/\\bin\\/bash/w /tmp/sed.txt\u0026#39; passwd ","date":"2023-12-17T15:16:34+08:00","image":"https://blog-source-mkt.oss-cn-chengdu.aliyuncs.com/blog_source/public/sed.webp","permalink":"/p/%E6%96%87%E6%9C%AC%E5%A4%84%E7%90%86%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bsed/","title":"æ–‡æœ¬å¤„ç†ä¸‰å‰‘å®¢ä¹‹sed"},{"content":"awk å·¥ä½œæ¨¡å¼ ä¸ sed ç›¸åŒ, éƒ½æ˜¯é€è¡Œå¤„ç†\nè¯­æ³•æ ¼å¼ awk \u0026lsquo;BEGIN{}pattern{commands}END{} filename\u0026rsquo; stdout | awk \u0026lsquo;BEGIN{}pattern{commands}END{}\u0026rsquo; è¯­æ³•æ ¼å¼ è¯´æ˜ BEGIN{} å¤„ç†æ–‡æœ¬å‰æ‰§è¡Œ pattern åŒ¹é…æ¨¡å¼ {commands} å¤„ç†å‘½ä»¤, ;éš”å¼€ END{} å¤„ç†æ–‡æœ¬åæ‰§è¡Œ BEGIN{}, pattern, END{} å¤šå¯çœç•¥\nå†…ç½®å˜é‡ å†…ç½®å˜é‡ å«ä¹‰ $0 æ•´è¡Œå†…å®¹ $1-$n æŒ‰åˆ†éš”ç¬¦çš„ç¬¬ 1-n ä¸ªå­—æ®µ NF (Number Field) å½“å‰è¡Œçš„å­—æ®µä¸ªæ•°(å¤šå°‘åˆ—) NR (Number Row) å½“å‰è¡Œè¡Œå·, ä» 1 å¼€å§‹è®¡æ•° FNR (File Number Row) å¤šæ–‡ä»¶å¤„ç†æ—¶, æ¯ä¸ªæ–‡ä»¶å•ç‹¬æŠ€æœ¯, ä» 1 å¼€å§‹ FS (Field Separate) è¾“å…¥å­—æ®µåˆ†éš”ç¬¦, ä¸æŒ‡å®šä¸ºç©ºæ ¼æˆ– tab RS (Row Separator) è¾“å…¥è¡Œåˆ†éš”ç¬¦, é»˜è®¤å›è½¦ OFS (Output Field Separator) è¾“å‡ºå­—æ®µåˆ†éš”ç¬¦ ORS (Output Row Separator) è¾“å‡ºè¡Œåˆ†éš”ç¬¦, é»˜è®¤å›è½¦ FILENAME å½“å‰è¾“å…¥æ–‡ä»¶å ARGC å‘½ä»¤è¡Œå‚æ•°ä¸ªæ•° ARGV å‘½ä»¤è¡Œå‚æ•°æ•°ç»„ åŸºæœ¬ä½¿ç”¨:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 $ awk \u0026#39;{print $0}\u0026#39; passwd $ awk \u0026#39;{print $1,$3}\u0026#39; list $ awk \u0026#39;{print NF}\u0026#39; list $ awk \u0026#39;{print NR}\u0026#39; list $ awk \u0026#39;{print FNR}\u0026#39; list awk.txt $ awk \u0026#39;BEGIN{FS=\u0026#34;:\u0026#34;}{print $1}\u0026#39; passwd $ awk \u0026#39;BEGIN{RS=\u0026#34;--\u0026#34;}{print $0}\u0026#39; list $ awk \u0026#39;BEGIN{FS=\u0026#34;:\u0026#34;;OFS=\u0026#34;|\u0026#34;}{print $1,$3}\u0026#39; passwd # æ¯è¡Œè¾“å‡ºå­—æ®µ $ awk \u0026#39;BEGIN{ORS=\u0026#34;--\u0026#34;}{print $0}\u0026#39; passwd $ awk \u0026#39;{print FILENAME}\u0026#39; passwd $ awk \u0026#39;{print ARGC}\u0026#39; passwd list # 3 ä¸ªå‚æ•° awk, passwd, list æ ¼å¼åŒ–è¾“å‡º printf æ ¼å¼ç¬¦ å«ä¹‰ %s å­—ç¬¦ä¸² %d åè¿›åˆ¶ %f æµ®ç‚¹æ•° %x åå…­è¿›åˆ¶ %o å…«è¿›åˆ¶ %e ç§‘å­¦è®¡æ•°æ³• %c å•ä¸ªå­—ç¬¦ ä¿®é¥°ç¬¦:\nä¿®é¥°ç¬¦ å«ä¹‰ - å·¦å¯¹é½ + å³å¯¹é½ # æ‰“å° åå…­è¿›åˆ¶ä¸å…«è¿›åˆ¶æ—¶ä½¿ç”¨, åœ¨å‰æ‰“å°è¿›åˆ¶æ ‡è¯† ç¤ºä¾‹\n1 2 3 4 5 6 7 8 9 10 11 12 # %s: é»˜è®¤å·¦å¯¹é½ # %10s: é»˜è®¤å³å¯¹é½ $ awk \u0026#39;BEGIN{FS=\u0026#34;:\u0026#34;}{printf \u0026#34;%s\u0026#34;,$7}\u0026#39; passwd $ awk \u0026#39;BEGIN{FS=\u0026#34;:\u0026#34;}{printf \u0026#34;%10s\u0026#34;,$7}\u0026#39; passwd $ awk \u0026#39;BEGIN{FS=\u0026#34;:\u0026#34;}{printf \u0026#34;%-10s\u0026#34;,$7}\u0026#39; passwd $ awk \u0026#39;BEGIN{FS=\u0026#34;:\u0026#34;}{printf \u0026#34;%d\u0026#34;,$3}\u0026#39; passwd $ awk \u0026#39;BEGIN{FS=\u0026#34;:\u0026#34;}{printf \u0026#34;%0.3f\u0026#34;,$3}\u0026#39; passwd $ awk \u0026#39;BEGIN{FS=\u0026#34;:\u0026#34;}{printf \u0026#34;%x\u0026#34;,$3}\u0026#39; passwd $ awk \u0026#39;BEGIN{FS=\u0026#34;:\u0026#34;}{printf \u0026#34;%#x\u0026#34;,$3}\u0026#39; passwd # æ˜¾ç¤º 16 è¿›åˆ¶æ ‡è¯† $ awk \u0026#39;BEGIN{FS=\u0026#34;:\u0026#34;}{printf \u0026#34;%0\u0026#34;,$3}\u0026#39; passwd $ awk \u0026#39;BEGIN{FS=\u0026#34;:\u0026#34;}{printf \u0026#34;%e\u0026#34;,$3}\u0026#39; passwd æ¨¡å¼åŒ¹é… æ­£åˆ™è¡¨è¾¾å¼ (å›ºå®šå†™æ³•//) å…³ç³»è¿ç®—åŒ¹é… æ­£åˆ™è¡¨è¾¾å¼:****\n1 2 3 4 # å«æœ‰ root çš„è¡Œ $ awk \u0026#39;BEGIN{FS=\u0026#39;:\u0026#39;}/root/{print $0}\u0026#39; passwd # ä»¥ nginx å¼€å¤´ $ awk \u0026#39;BEGIN{FS=\u0026#39;:\u0026#39;}/^nginx/{print $0}\u0026#39; passwd å…³ç³»è¿ç®—ç¬¦:\nå…³ç³»è¿ç®—ç¬¦ å«ä¹‰ \u0026lt; æ•°å€¼ å°äº \u0026gt; æ•°å€¼ å¤§äº \u0026lt;= æ•°å€¼ å°äºç­‰äº \u0026gt;= æ•°å€¼ å¤§äºç­‰äº == ç­‰äº != ä¸ç­‰äº ~ åŒ¹é…æ­£åˆ™ !~ ä¸åŒ¹é…æ­£åˆ™ 1 2 3 4 5 6 7 8 9 # ç¬¬ 3 ä¸ªå­—æ®µå°äº 50 $ awk \u0026#39;BEGIN{FS=\u0026#34;:\u0026#34;}$3\u0026lt;50{print $0}\u0026#39; passwd # ç¬¬ 7 ä¸ªå­—æ®µä¸º /bin/bash $ awk \u0026#39;BEGIN{FS=\u0026#34;:\u0026#34;}$7==\u0026#34;/bin/bash\u0026#34;{print $0}\u0026#39; passwd $ awk \u0026#39;BEGIN{FS=\u0026#34;:\u0026#34;}$7!=\u0026#34;/bin/bash\u0026#34;{print $0}\u0026#39; passwd # ç¬¬ 3 ä¸ªå­—æ®µåŒ…å« 3 ä¸ªåŠä»¥ä¸Šæ•°å­— $ awk \u0026#39;BEGIN{FS=\u0026#34;:\u0026#34;}$3~/[0-9]{3,}/{print $0}\u0026#39; passwd é€»è¾‘è¿ç®—ç¬¦:\né€»è¾‘è¿ç®—ç¬¦ å«ä¹‰ || æˆ– \u0026amp;\u0026amp; ä¸ ! é 1 2 3 $ awk \u0026#39;BEGIN{FS=\u0026#34;:\u0026#34;}$1==\u0026#34;root\u0026#34;||$1==\u0026#34;nginx\u0026#34;{print $0}\u0026#39; passwd $ awk \u0026#39;BEGIN{FS=\u0026#34;:\u0026#34;}$3\u0026lt;50 \u0026amp;\u0026amp; $3 \u0026gt;30 {print $0}\u0026#39; passwd awk ç®—æ•°è¿ç®— è¿ç®—ç¬¦ å«ä¹‰ + åŠ  - å‡ * ä¹˜ / é™¤ % å–ä½™ ^ æˆ– ** ä¹˜æ–¹ x++ ; x\u0026ndash; å…ˆè¿”å› x, å +/- x ++x ; \u0026ndash;x å…ˆ +/- x, å è¿”å› x ç»ƒä¹ è®¡ç®—è¯¾ç¨‹å¹³å‡å€¼\n1 2 3 4 # å³å¯¹é½ $ awk \u0026#39;BEGIN{printf \u0026#34;%10s%10s%10s%10s%10s\\n\u0026#34;,\u0026#34;Name\u0026#34;, \u0026#34;YuWen\u0026#34;,\u0026#34;ShuXue\u0026#34;, \u0026#34;English\u0026#34;, \u0026#34;AVG\u0026#34;}{total=$1+$2+$3;AVG=total/3;printf \u0026#34;%10s%10d%10d%10d%10.2f\\n\u0026#34;,$1,$2,$3,$4,AVG}\u0026#39; list $ awk \u0026#39;BEGIN{printf \u0026#34;%-10s%-10s%-10s%-10s%-10s\\n\u0026#34;,\u0026#34;Name\u0026#34;, \u0026#34;YuWen\u0026#34;,\u0026#34;ShuXue\u0026#34;, \u0026#34;English\u0026#34;, \u0026#34;AVG\u0026#34;}{total=$1+$2+$3;AVG=total/3;printf \u0026#34;%-10s%-10d%-10d%-10d%-10.2f\\n\u0026#34;,$1,$2,$3,$4,AVG}\u0026#39; list æ¡ä»¶è¯­å¥ if-else\nç¤ºä¾‹: script.awk\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 BEGIN{ FS=\u0026#34;:\u0026#34; } { if($3\u0026lt;50) { printf \u0026#34;%-20s%-10s%10d\\n\u0026#34;,\u0026#34;UID\u0026lt;50\u0026#34;,$1,$3 } else if($3\u0026gt;50 \u0026amp;\u0026amp; $3 \u0026lt;100) { printf \u0026#34;%-20s%-10s%10d\\n\u0026#34;,\u0026#34;50\u0026lt;UID\u0026lt;100\u0026#34;,$1,$3 } else { printf \u0026#34;%-20s%-10s%10d\\n\u0026#34;,\u0026#34;UID\u0026gt;100\u0026#34;,$1,$3 } } 1 $ awk -f script.awk /etc/passwd å¾ªç¯è¯­å¥ do-while while for è®¡ç®— 1+2+\u0026hellip;100\ndo-while 1 2 3 4 5 6 7 8 9 BEGIN{ do{ sum += i i++ }while(i\u0026lt;=100) print sum } while 1 2 3 4 5 6 7 8 BEGIN{ while(i\u0026lt;=100) { sum += i i++ } print sum } for 1 2 3 4 5 6 7 8 BEGIN{ for(i=0;i\u0026lt;=100;i++) { sum += i } print sum } ç»ƒä¹ : æ‰“å°å¹³å‡åˆ†å¤§äº 70çš„, å¹¶è®¡ç®—å¹³å‡åˆ†\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 BEGIN{ printf \u0026#34;%-10s%-10s%-10s%-10s%-10s\\n\u0026#34;,\u0026#34;Name\u0026#34;,\u0026#34;YuWen\u0026#34;,\u0026#34;Math\u0026#34;,\u0026#34;English\u0026#34;,\u0026#34;AVG\u0026#34; } { total = $2 + $3 + $3 avg = total / 3 if (avg \u0026gt; 70) { printf \u0026#34;%-10s%-10d%-10d%-10d%-0.2f\\n\u0026#34;,$1,$2,$3,$4,avg score_yuwen += $2 score_math += $3 score_english += $4 score_avg += avg count++ } } END{ printf \u0026#34;%-10s%-10.2f%-10.2f%-10.2f%-0.2f\\n\u0026#34;,\u0026#34;\u0026#34;,score_yuwen/count,score_math/count,score_english/count,score_avg/count } å­—ç¬¦ä¸²å‡½æ•° å‡½æ•°å è§£é‡Š è¿”å›å€¼ length(str) è®¡ç®—å­—ç¬¦ä¸²é•¿åº¦ é•¿åº¦å€¼ index(str1,str2) åœ¨ str1 ä¸­æŸ¥æ‰¾ str2 è¿”å›ä½ç½®ç´¢å¼•, ä» 1 è®¡æ•° tolower(str) è½¬å°å†™ è½¬å°å†™åçš„å­—ç¬¦ä¸² toupper(str) è½¬å¤§å†™ è½¬å¤§å†™åçš„å­—ç¬¦ä¸² substr(str,m,n) ä» str m å­—ç¬¦, æˆªå– n ä½(n å¯çœç•¥) æˆªå–åçš„å­ä¸² split(str,arr,fs) æŒ‰ fs åˆ‡å‰²å­—ç¬¦ä¸², ç»“æœä¿å­˜åˆ° arr åˆ‡å‰²åçš„å­ä¸²ä¸ªæ•° match(str,RE) ä¸ index() ç±»ä¼¼, ä½†æ”¯æŒæ­£åˆ™(RE) è¿”å›ç´¢å¼•ä½ç½® sub(RE,RepStr,str) åœ¨ str ä¸­æœç´¢ç¬¦åˆ RE çš„å­ä¸²å°†å…¶æ›¿æ¢ä¸º RepStr; åªæ›¿æ¢ç¬¬ä¸€ä¸ª æ›¿æ¢ä¸ªæ•° gsub(RE,RepStr,str) åœ¨ str ä¸­æœç´¢ç¬¦åˆ RE çš„å­ä¸²å°†å…¶æ›¿æ¢ä¸º RepStr; æ›¿æ¢å…¨éƒ¨ æ›¿æ¢ä¸ªæ•° 1. æ‰“å° passwd æ¯ä¸ªå­—æ®µé•¿åº¦:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 BEGIN{ FS=\u0026#34;:\u0026#34; } { i=1 while(i\u0026lt;=NF) { if(i==NF) printf \u0026#34;%d\u0026#34;,length($i) else printf \u0026#34;%d:\u0026#34;,length($i) i++ } print \u0026#34;\u0026#34; } 2. æŸ¥è¯¢\u0026quot;I have a dream\u0026quot;ä¸­\u0026quot;ea\u0026quot;ç´¢å¼•\n1 2 3 4 $ awk \u0026#39;BEGIN{str=\u0026#34;I have a dream\u0026#34;;localtion=index(str,\u0026#34;ea\u0026#34;);print localtion}\u0026#39; # 12 $ awk \u0026#39;BEGIN{str=\u0026#34;I have a dream\u0026#34;;localtion=match(str,\u0026#34;ea\u0026#34;);print localtion}\u0026#39; # 12 3. å¤§å°å†™è½¬æ¢\n1 2 3 4 $ awk \u0026#39;BEGIN{str=\u0026#34;I have a dream\u0026#34;;print tolower(str)}\u0026#39; # i have a dream $ awk \u0026#39;BEGIN{str=\u0026#34;I have a dream\u0026#34;;print toupper(str)}\u0026#39; # I HAVE A DREAM 4. åˆ‡åˆ†æ•°ç»„\n1 2 3 4 5 6 7 8 9 10 $ awk \u0026#39;BEGIN{str=\u0026#34;I have a dream\u0026#34;;split(str,arr,\u0026#34; \u0026#34;);print arr[2]}\u0026#39; $ awk \u0026#39;BEGIN{str=\u0026#34;I have a dream\u0026#34;;split(str,arr);print arr[2]}\u0026#39; # é»˜è®¤ç©ºæ ¼åˆ†éš” # have # éå†, ä¸æ˜¯é¡ºåºéå† $ awk \u0026#39;BEGIN{str=\u0026#34;I have a dream\u0026#34;;split(str,arr);for(a in arr) print arr[a]}\u0026#39; # dream # I # have # a 5. æœç´¢ç¬¬ä¸€ä¸ªå‡ºç°çš„æ•°å­—\n1 2 3 # æ­£åˆ™å¿…é¡»ç”¨ // $ awk \u0026#39;BEGIN{str=\u0026#34;I have a 123 dream\u0026#34;; print match(str, /[0-9]/)}\u0026#39; # 10 6. æˆªå–å­ä¸²\n1 2 3 4 5 $ awk \u0026#39;BEGIN{str=\u0026#34;I have a 123 dream\u0026#34;; print substr(str,3,7)}\u0026#39; # have a $ awk \u0026#39;BEGIN{str=\u0026#34;I have a 123 dream\u0026#34;; print substr(str,3)}\u0026#39; # have a 123 dream 7. æ›¿æ¢æ•°å­—\n1 2 3 4 5 6 7 $ awk \u0026#39;BEGIN{str=\u0026#34;I have a 123 dream 324 hello\u0026#34;; print sub(/[0-9]+/,\u0026#34;$\u0026#34;,str); print str}\u0026#39; # 1 # I have a $ dream 324 hello $ awk \u0026#39;BEGIN{str=\u0026#34;I have a 123 dream 324 hello\u0026#34;; print gsub(/[0-9]+/,\u0026#34;$\u0026#34;,str); print str}\u0026#39; # 2 # I have a $ dream $ hello awk å¸¸ç”¨é€‰é¡¹ é€‰é¡¹ è¯´æ˜ -v å‚æ•°ä¼ é€’ -f æŒ‡å®šè„šæœ¬æ–‡ä»¶ -F æŒ‡å®šåˆ†éš”ç¬¦ -V æŸ¥çœ‹ç‰ˆæœ¬ å¦‚æœå˜é‡æœ‰ç©ºæ ¼, è¦ä½¿ç”¨\u0026quot;\u0026quot;\n1 2 3 4 5 6 7 8 9 10 $ num=13 $ var=\u0026#34;hello world\u0026#34; $ awk -v num1=$num -v var1=$var \u0026#39;BEGIN{print num1,var1}\u0026#39; # awk: fatal: cannot open file `BEGIN{print num1,var1}\u0026#39; for reading (No such file or directory) $ awk -v num1=\u0026#34;$num\u0026#34; -v var1=\u0026#34;$var\u0026#34; \u0026#39;BEGIN{print num1,var1}\u0026#39; # 13 hello world $ awk -F \u0026#34;:\u0026#34; \u0026#39;{print $0}\u0026#39; /etc/passwd awk ä¸ shell ä¸­æ•°ç»„ shell ä¸­æ•°ç»„ ä¸‹æ ‡ä» 0 å¼€å§‹\næ‰“å°æ•°ç»„:\n1 2 3 4 5 6 7 8 9 10 $ arr=(\u0026#34;kubernetes\u0026#34; \u0026#34;etcd\u0026#34; \u0026#34;time\u0026#34; \u0026#34;redis\u0026#34;) # æ‰“å°æ•°ç»„ $ echo ${arr[@]} $ echo ${arr[*]} # kubernetes etcd time redis # æ‰“å°å…ƒç´  $ echo ${arr[2]} # time æ‰“å°æ•°ç»„/å…ƒç´ é•¿åº¦; åˆ†ç‰‡è®¿é—®; å…ƒç´ æ“ä½œ; åˆ é™¤å…ƒç´ :\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 $ arr=(\u0026#34;kubernetes\u0026#34; \u0026#34;etcd\u0026#34; \u0026#34;time\u0026#34; \u0026#34;redis\u0026#34;) # æ‰“å°æ•°ç»„ $ echo ${#arr[@]} $ echo ${#arr[*]} # 4 # æ‰“å°å…ƒç´  $ echo ${#arr[3]} # 5 # åˆ†ç‰‡è®¿é—® $ echo ${arr[@]:1:3} # etcd time redis # å…ƒç´ èµ‹å€¼ $ arr[2]=mysqlserver $ echo ${arr[@]} # kubernetes etcd mysqlserver redis # å…ƒç´ å†…å®¹æ›¿æ¢ $ echo ${arr[@]/e/E} # kubErnetes Etcd mysqlsErver rEdis $ echo ${arr[@]//e/E} # kubErnEtEs Etcd mysqlsErvEr rEdis # å…ƒç´ åˆ é™¤ *** é€šè¿‡ä¸‹æ ‡åˆ é™¤å, è¢«åˆ é™¤çš„ä¸‹æ ‡çš„å…ƒç´ ä¸ºç©º, åŸæ•°ç»„çš„å…¶ä»–å…ƒç´ ä¸‹æ ‡ä¸å˜ $ unset arr[0] $ echo ${arr[@]} # etcd mysqlserver redis $ unset arr[0] $ echo ${arr[@]} # etcd mysqlserver redis $ unset arr[1] $ echo ${arr[@]} # mysqlserver redis # åˆ é™¤æ•°ç»„ $ unset arr é€šè¿‡ä¸‹æ ‡åˆ é™¤å, è¢«åˆ é™¤çš„ä¸‹æ ‡çš„å…ƒç´ ä¸ºç©º, åŸæ•°ç»„çš„å…¶ä»–å…ƒç´ ä¸‹æ ‡ä¸å˜\næ•°ç»„çš„éå†\n1 2 3 4 5 6 $ arr=(\u0026#34;kubernetes\u0026#34; \u0026#34;etcd\u0026#34; \u0026#34;time\u0026#34; \u0026#34;redis\u0026#34;) $ for a in ${arr[@]}; do echo $a; done # kubernetes # etcd # time # redis awk ä¸­æ•°ç»„ è„šæœ¬ç»ƒä¹  æ•°æ®ç”Ÿæˆè„šæœ¬:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 #!/bin/bash # function create_random() { min=$1 max=$(($2-$min+1)) num=$(date +%s%N) echo $(($num%$max+min)) } INDEX=1 while true do for user in allen mike jerry tracy han lilei do COUNT=$RANDOM NUM1=`create_random 1 $COUNT` NUM2=`expr $COUNT - $NUM1` echo \u0026#34;`date \u0026#39;+%Y-%m-%d %H:%M:%S\u0026#39;` $INDEX Batches: user $user insert $COUNT records into database:product table:detail, insert $NUM1 records successfully, failed $NUM2 records\u0026#34; \u0026gt;\u0026gt; ./db.log.`date +%Y%m%d` INDEX=`expr $INDEX + 1` done done æ•°æ®æ ¼å¼\n1 2 3 4 5 2023-12-12 02:49:31 1 Batches: user allen insert 25719 records into database:product table:detail, insert 24482 records successfully, failed 1237 records 2023-12-12 02:49:31 2 Batches: user mike insert 32653 records into database:product table:detail, insert 26055 records successfully, failed 6598 records 2023-12-12 02:49:31 3 Batches: user jerry insert 16986 records into database:product table:detail, insert 11636 records successfully, failed 5350 records 2023-12-12 02:49:31 4 Batches: user tracy insert 31899 records into database:product table:detail, insert 9250 records successfully, failed 22649 records 2023-12-12 02:49:31 5 Batches: user han insert 24256 records into database:product table:detail, insert 24033 records successfully, failed 223 records ç»Ÿè®¡æ‰€æœ‰æˆåŠŸ, å¤±è´¥, æ€»å…±è®°å½•æ•°\ncount.awk:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 BEGIN{ printf \u0026#34;%-10s%-20s%-20s%-20s\\n\u0026#34;,\u0026#34;User\u0026#34;,\u0026#34;Total\u0026#34;,\u0026#34;Sucess\u0026#34;,\u0026#34;Failed\u0026#34; } { TOTAL[$6]+=$8 SUCESS[$6]+=$14 FAILED[$6]+=$18 } END{ for(t in TOTAL) { total += TOTAL[t] sucess += SUCESS[t] failed += FAILED[t] printf \u0026#34;%-10s%-20s%-20s%-20s\\n\u0026#34;,t,TOTAL[t],SUCESS[t],FAILED[t] } printf \u0026#34;%-10s%-20s%-20s%-20s\\n\u0026#34;,\u0026#34;\u0026#34;,total,sucess,failed } 1 $ awk -f count.awk db.log.20231212 1 2 3 4 5 6 7 8 User Total Sucess Failed tracy 6096344 2963340 3133004 allen 6293470 3182865 3110605 mike 5845083 2912982 2932101 jerry 5996178 3080723 2915455 lilei 6217104 3028971 3188133 han 5923975 3089899 2834076 36372154 18258780 18113374 2. æ‰“å°ä¸¢å¤±è®°å½•çš„è¡Œæ•°\nä¸€æ¡è®°å½•è¡Œä¸­, æ€»è®°å½•æ•° != æˆåŠŸè®°å½•æ•° + å¤±è´¥è®°å½•æ•°\n1 $ awk \u0026#39;{if($8 != $14 + $18) print NR}\u0026#39; db.log.20231212 ","date":"2023-12-17T15:16:07+08:00","image":"https://blog-source-mkt.oss-cn-chengdu.aliyuncs.com/blog_source/public/awk-conditional-statements.jpg","permalink":"/p/%E6%96%87%E6%9C%AC%E5%A4%84%E7%90%86%E4%B8%89%E5%89%91%E5%AE%A2%E4%B9%8Bawk/","title":"æ–‡æœ¬å¤„ç†ä¸‰å‰‘å®¢ä¹‹awk"},{"content":"å‡½æ•°åŠŸèƒ½åˆ’åˆ†: å‡½æ•°å®šä¹‰ å‡½æ•°åŠŸèƒ½ function get_all_group è·å–æ‰€æœ‰è¿›ç¨‹ç»„ function get_all_process è·å–æ‰€æœ‰è¿›ç¨‹ function get_process_info è¿”å›è¿›ç¨‹è¯¦ç»†ä¿¡æ¯(è¿è¡ŒçŠ¶æ€, PID, CPU, MEM, å¯åŠ¨æ—¶é—´) function get_all_process_by_group è¿”å›è¿›ç¨‹ç»„ä¸­æ‰€æœ‰è¿›ç¨‹åç§° å‡½æ•°å®ç°: function get_all_group: æ ¹æ®å¯¹åº”å­—æ®µè·å–å…¶ä¸‹çš„æ‰€æœ‰ç»„å\n1 2 3 4 5 6 7 8 9 10 11 12 13 HOME_DIR=\u0026#34;/root/shell\u0026#34; CONFIG_FILE=\u0026#34;process.cfg\u0026#34; function get_all_group { if [ ! -e $HOME_DIR/$CONFIG_FILE ]; then echo \u0026#34;$CONFIG_FIEL is not exist. Please check...\u0026#34; exit 1 else G_LIST=`sed -n \u0026#39;/\\[GROUP_LIST\\]/,/\\[.*\\]/p\u0026#39; process.cfg | egrep -v \u0026#34;(\\[.*\\]|^$)\u0026#34;` echo \u0026#34;$G_LIST\u0026#34; fi } function get_all_process éå†æ‰€æœ‰ç»„, è·å–å…¶ä¸‹çš„æ‰€æœ‰è¿›ç¨‹\n1 2 3 4 5 6 7 function get_all_processes { for g in `get_all_group`;do P_LIST=`sed -n \u0026#39;/\\[\u0026#39;$g\u0026#39;\\]/,/\\[.*\\]/p\u0026#39; process.cfg | egrep -v \u0026#34;^\\[|^$\u0026#34;` echo $P_LIST done } function get_process_info ç»§ç»­æ‹†åˆ†å‡½æ•°, æ‹†åˆ†ä¸º get_process_pid_by_name, get_process_info_by_pid å¯ç›´æ¥ä½¿ç”¨ ps aux æŠŠç»Ÿè®¡çš„åç§°çš„æ•°æ®ä¸€å¹¶å¤„ç† get_process_pid_by_name:\n1 2 3 4 5 6 7 8 9 10 11 function get_process_pid_by_name { # åªæ¥å—ä¸€ä¸ªå‚æ•° if [ $# != 1 ]; then return 1 # é 0 å³ä¸ºé”™è¯¯ else # è¿‡æ»¤æ‰è„šæœ¬æœ¬èº« pids=`ps -ef | grep \u0026#34;$1\u0026#34; | grep -v grep | grep -v $0 | awk \u0026#39;{print $2}\u0026#39;` echo $pids fi } get_process_info_by_pid:\n1 2 3 4 5 6 7 8 9 10 11 function get_process_info_by_pid { if [ `ps -ef | awk -v p_id=$1 \u0026#39;$2==p_id{print}\u0026#39; | wc -l` == 1 ]; then pro_status=\u0026#34;RUNNING\u0026#34; else pro_status=\u0026#34;STOPED\u0026#34; fi pro_cpu=`ps aux | awk -v p_id=$1 \u0026#39;$2==p_id{print $3}\u0026#39;` pro_mem=`ps aux | awk -v p_id=$1 \u0026#39;$2==p_id{print $4}\u0026#39;` pro_start=\u0026#34;`ps -p $1 -o lstart`\u0026#34; } function get_all_process_by_group 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 function is_group_in_config { for g in `get_all_group`;do if [ \u0026#34;$1\u0026#34; == $g ];then return 0 fi done return 1 } function get_all_processes_by_group { is_group_in_config $1 if [ $? == 0 ];then p_list=`sed -n \u0026#39;/\\[\u0026#39;$1\u0026#39;\\]/,/\\[.*\\]/p\u0026#39; $HOME_DIR/$CONFIG_FILE | egrep -v \u0026#34;(^$|^#|^\\[)\u0026#34;` echo $p_list else echo \u0026#34;GroupName $1 is not in process.cfg\u0026#34; fi } ä¸»æµç¨‹è®¾è®¡ æ¥å—å‚æ•° è¡Œä¸º æ— å‚æ•° æ‰“å°æ‰€æœ‰ä¿¡æ¯ -g ç»„å æ¥å—å¤šä¸ªç»„å, æ‰“å°ç»„ä¸‹æ‰€æœ‰è¿›ç¨‹ è¿›ç¨‹å æ‰“å°æŒ‡å®šè¿›ç¨‹å 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 if [ $# -gt 0 ];then if [ $1 == \u0026#34;-g\u0026#34; ];then # æ¥å—ç»„å, æŠŠå‚æ•°å·¦ç§», å»æ‰ -g shift for gn in $@; do is_group_in_config $gn || continue for pn in `get_all_processes_by_group`;do is_process_in_config $pn \u0026amp;\u0026amp; format_print $pn $gn done done else for pn in $@;do is_process_in_config $pn \u0026amp;\u0026amp; format_print $pn $gn done fi else # æ²¡æœ‰å‚æ•°, æ‰“å°æ‰€æœ‰ for pn in `get_all_processes`;do gn=`get_group_by_process_name $pn` is_process_in_config $pn \u0026amp;\u0026amp; format_print $pn $gn done fi å®Œæ•´è„šæœ¬ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 #!/bin/bash # # Func: Get app info from process.cfg HOME_DIR=\u0026#34;/root/shell\u0026#34; CONFIG_FILE=\u0026#34;process.cfg\u0026#34; this_pid=$$ function get_all_group { G_LIST=`sed -n \u0026#39;/\\[GROUP_LIST\\]/,/\\[.*\\]/p\u0026#39; process.cfg | egrep -v \u0026#34;(\\[.*\\]|^$)\u0026#34;` echo \u0026#34;$G_LIST\u0026#34; } function get_all_processes { for g in `get_all_group`;do P_LIST=`sed -n \u0026#39;/\\[\u0026#39;$g\u0026#39;\\]/,/\\[.*\\]/p\u0026#39; process.cfg | egrep -v \u0026#34;^\\[|^$\u0026#34;` echo $P_LIST done } function get_process_pid_by_name { # åªæ¥å—ä¸€ä¸ªå‚æ•° if [ $# != 1 ]; then return 1 # é 0 å³ä¸ºé”™è¯¯ else pids=`ps -ef | grep \u0026#34;$1\u0026#34; | grep -v grep | grep -v $0 | awk \u0026#39;{print $2}\u0026#39;` echo $pids fi } function get_process_info_by_pid { if [ `ps -ef | awk -v p_id=$1 \u0026#39;$2==p_id{print}\u0026#39; | wc -l` == 1 ]; then pro_status=\u0026#34;RUNNING\u0026#34; else pro_status=\u0026#34;STOPED\u0026#34; fi pro_cpu=`ps aux | awk -v p_id=$1 \u0026#39;$2==p_id{print $3}\u0026#39;` pro_mem=`ps aux | awk -v p_id=$1 \u0026#39;$2==p_id{print $4}\u0026#39;` pro_start_time=\u0026#34;`ps -p $1 -o lstart`\u0026#34; } function is_group_in_config { for g in `get_all_group`;do if [ \u0026#34;$1\u0026#34; == $g ];then return 0 fi done echo \u0026#34;Group $1 is not in process.cfg\u0026#34; return 1 } function get_all_processes_by_group { is_group_in_config $1 if [ $? == 0 ];then p_list=`sed -n \u0026#39;/\\[\u0026#39;$1\u0026#39;\\]/,/\\[.*\\]/p\u0026#39; $HOME_DIR/$CONFIG_FILE | egrep -v \u0026#34;(^$|^#|^\\[)\u0026#34;` echo $p_list else echo \u0026#34;GroupName $1 is not in process.cfg\u0026#34; fi } function format_print { ps -ef | grep $1 | grep -v grep | grep -v $this_pid \u0026amp;\u0026gt; /dev/null if [ $? -eq 0 ]; then pids=`get_process_pid_by_name $1` for pid in $pids; do get_process_info_by_pid $pid awk -v p_name=$1 -v g_name=$2 -v p_id=$pid -v p_status=$pro_status -v p_cpu=$pro_cpu -v p_mem=$pro_mem $p_start_time=\u0026#34;$pro_start_time\u0026#34; \u0026#39;BEGIN{printf \u0026#34;%-10s%-10s%-5s%-5s%-5s%-5s%-15s\u0026#34;,p_name,g_name,p_id,p_status,p_cpu,p_mem,p_start_time}\u0026#39; done else # è¿›ç¨‹ä¸å­˜åœ¨ awk -v p_name=$1 -v g_name=$2 \u0026#39;BEGIN{printf \u0026#34;%-10s%-10s%-5s%-5s%-5s%-5s%-15s\u0026#34;,p_name,g_name,\u0026#34;NULL\u0026#34;,\u0026#34;STOPED\u0026#34;,\u0026#34;NULL\u0026#34;,\u0026#34;NULL\u0026#34;,\u0026#34;NULL\u0026#34;}\u0026#39; fi } function is_process_in_config { for pn in `get_all_process`;do if [ $pn == $1 ];then return fi done echo \u0026#34;Process $1 is not in process.cfg\u0026#34; return 1 } function get_group_by_process_name { for gn in `get_all_group`;do for pn in `get_all_process_by_group $gn`;do if [ $pn == $1 ]; then ehco $gn fi done done } if [ $# -gt 0 ];then if [ $1 == \u0026#34;-g\u0026#34; ];then # æ¥å—ç»„å, æŠŠå‚æ•°å·¦ç§», å»æ‰ -g shift for gn in $@; do is_group_in_config $gn || continue for pn in `get_all_processes_by_group`;do is_process_in_config $pn \u0026amp;\u0026amp; format_print $pn $gn done done else for pn in $@;do is_process_in_config $pn \u0026amp;\u0026amp; format_print $pn $gn done fi else # æ²¡æœ‰å‚æ•°, æ‰“å°æ‰€æœ‰ for pn in `get_all_processes`;do gn=`get_group_by_process_name $pn` is_process_in_config $pn \u0026amp;\u0026amp; format_print $pn $gn done fi ","date":"2023-12-17T15:15:36+08:00","image":"https://blog-source-mkt.oss-cn-chengdu.aliyuncs.com/blog_source/public/Putorius-Feature-Default-1200x675.jpg.jpg","permalink":"/p/shell%E8%84%9A%E6%9C%AC%E4%B9%8B%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/","title":"Shellè„šæœ¬ä¹‹è¿›ç¨‹ç®¡ç†"},{"content":"mysql å‘½ä»¤å‚æ•° å‚æ•° å«ä¹‰ -u ç”¨æˆ· -p å¯†ç  -h è¦è¿æ¥çš„ä¸»æœº -D æŒ‡å®šæ•°æ®åº“ -e è¦æ‰§è¡Œçš„ sql è¯­å¥ -B è¾“å‡ºä»¥ tab åˆ†éš” -N ä¸æ˜¾ç¤ºåˆ—å¤´ -E å‚ç›´æ˜¾ç¤º -H ä»¥ html å½¢å¼è¾“å‡º -X xml æ ¼å¼è¾“å‡º shell è„šæœ¬æ¥å— ä¸, æ“ä½œ mysql\n1 2 3 4 5 6 7 8 9 10 11 #!/bin/bash # user=\u0026#34;dbuser\u0026#34; password=\u0026#34;123456\u0026#34; host=\u0026#34;127.0.0.1\u0026#34; db_name=\u0026#34;$1\u0026#34; # å‚æ•°ä¸­ç”¨ç©ºæ ¼æ—¶è¦ç”¨åŒå¼•å· SQL=\u0026#34;$2\u0026#34; mysql -u\u0026#34;$user\u0026#34; -p\u0026#34;$password\u0026#34; -h\u0026#34;$host\u0026#34; -D\u0026#34;db_name\u0026#34; -B -e \u0026#34;$SQL\u0026#34; 1 $ sh operator.sh school \u0026#34;insert into score(\u0026#34;231\u0026#34;,\u0026#34;1234\u0026#34;,100)\u0026#34; ä½¿ç”¨ shell å¯¼å…¥æ•°æ®\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 #/bin/bash # user=\u0026#34;dbuser\u0026#34; password=\u0026#34;123456\u0026#34; host=\u0026#34;127.0.0.1\u0026#34; IFS=\u0026#34;|\u0026#34; # shell é»˜è®¤ä»¥ç©ºæ ¼ä¸ tab åˆ‡åˆ†, é€šè¿‡ IFS æ”¹å˜é»˜è®¤åˆ†éš”ç¬¦ cat data.txt | while read id name birth sex do if [ $id -gt 2023 ];then mysql -u\u0026#34;$user\u0026#34; -p\u0026#34;$password\u0026#34; -h\u0026#34;$host\u0026#34; -e \u0026#34;Insert into school.student values(\u0026#39;$id\u0026#39;,\u0026#39;$name\u0026#39;,\u0026#39;$birth\u0026#39;,\u0026#39;$sex\u0026#39;)\u0026#34; fi done åˆ©ç”¨ mysqldump è¿›è¡Œæ•°æ®åº“å¤‡ä»½ mysqldump å‚æ•° å«ä¹‰ -u -p -h -d \u0026ndash;no-data åªå¯¼å‡ºè¡¨ç»“æ„ -t \u0026ndash;no-create-info åªå¯¼å‡ºæ•°æ®, ä¸å¯¼å‡ºå»ºè¡¨è¯­å¥ -A \u0026ndash;all-databases \u0026ndash;all-databases -B \u0026ndash;databases å¯¼å‡ºä¸€ä¸ªæˆ–å¤šä¸ªæ•°æ®åº“ å¤‡ä»½ school ä¸‹çš„ score è¡¨, é€šè¿‡ ftp ä¸Šä¼ åˆ°ç›®æ ‡æœåŠ¡å™¨\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 #!/bin/bash # db_user=\u0026#34;dbuser\u0026#34; db_password=\u0026#34;123456\u0026#34; db_host=\u0026#34;127.0.0.1\u0026#34; ftp_user=\u0026#34;fpt_user\u0026#34; ftp_password=\u0026#34;123\u0026#34; ftp_host=\u0026#34;127.0.0.1\u0026#34; src_dir=\u0026#34;/data/bak\u0026#34; dst_dir=\u0026#34;/data/backup\u0026#34; time=\u0026#34;`date +%Y%m%d%H%M%S`\u0026#34; filename=\u0026#34;school_score_${time}.bak\u0026#34; function auto_ftp { ftp -inv \u0026lt;\u0026lt; EOF open $ftp_host user $ftp_user $ftp_password cd $dst_dir put $1 bye EOF } # å¤‡ä»½ school æ•°æ®åº“ä¸‹çš„ score è¡¨ # \u0026amp;\u0026amp; åªæœ‰å‰ä¸€å¤©å‘½ä»¤æ­£ç¡®æ‰§è¡Œåœ¨æ‰§è¡Œåé¢å‘½ä»¤ mysqldump -u\u0026#34;$db_user\u0026#34; -p\u0026#34;$db_password\u0026#34; -h\u0026#34;db_host\u0026#34; school score \u0026gt; $src_dir/$filename \u0026amp;\u0026amp; auto_ftp $src_dir/$filename ","date":"2023-12-17T15:14:43+08:00","image":"https://blog-source-mkt.oss-cn-chengdu.aliyuncs.com/blog_source/public/20211026234515.png","permalink":"/p/shell%E8%84%9A%E6%9C%AC%E4%B8%8Emysql%E4%BA%A4%E4%BA%92/","title":"Shellè„šæœ¬ä¸Mysqläº¤äº’"},{"content":"å‡½æ•°å®šä¹‰ä¸ä½¿ç”¨ è¯­æ³•æ ¼å¼\nnginx å®ˆæŠ¤è¿›ç¨‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 #!/bin/bash # while true do ps -ef | grep nginx | grep -v grep | grep -v $$ \u0026amp;\u0026gt; /dev/null if [ $? -eq 0 ]; then echo \u0026#34;nginx is running\u0026#34; sleep 3s else echo \u0026#34;nginx is stop, starting\u0026#34; systemctl start nginx fi done ç®€å•è®¡ç®—å‡½æ•°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 #!/bin/bash # function calcu { case $2 in +) echo `expr $1 + $3` ;; -) echo `expr $1 - $3` ;; \\*) echo `expr $1 \\* $3` ;; /) echo `expr $1 / $3` ;; esac } calcu $1 $2 $3 å‡½æ•°è¿”å›å€¼ return echo return è¿”å›å€¼æ¡ˆä¾‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 #!/bin/bash # function is_nginx_isrunning { ps -ef | grep nginx | grep -v grep | grep $$ \u0026amp;\u0026gt; /dev/null if [ $? -eq 0 ]; then return else return 1 fi } is_nginx_running \u0026amp;\u0026amp; echo \u0026#34;nginx is running\u0026#34; || echo \u0026#34;nginx is not running\u0026#34; echo è¿”å›å€¼æ¡ˆä¾‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 #!/bin/bahs # function get_users { users=`cat /etc/passwd | cut -d \u0026#34;:\u0026#34; -f1` echo $users } userlist=`get_users` index=1 for u in ${userlist[@]} # ä¹Ÿå¯ä»¥ $userlist do echo \u0026#34;This is $index user: $u\u0026#34; index=$(($index+1)) done å…¨å±€å˜é‡ä¸å±€éƒ¨å˜é‡ Shell ä¸­é»˜è®¤ä¸ºå…¨å±€å˜é‡\nå±€éƒ¨å˜é‡ä½¿ç”¨ local å…³é”®å­—\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 #!/bin/bash # var1=1 function set_var2 { var2=2 } echo $var1 echo $var2 set_var2 echo $var2 function set_var3 { local var3=3 } set_var3 echo $var3 è¾“å‡º:\n1 2 3 1 2 å‡½æ•°åº“ åº“æ–‡ä»¶é€šå¸¸ä»¥ .lib ç»“å°¾\nbase_function.lib\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 #!/bin/echo # æç¤ºä¸å¯è¿è¡Œ function add { echo \u0026#34;`expr $1 + $2`\u0026#34; } function divide { echo \u0026#34;`expr $1 / $2`\u0026#34; } function sys_load { echo \u0026#34;Memory Info\u0026#34; echo free -m echo echo \u0026#34;Disk Info\u0026#34; echo df -h echo } use_base_function.sh\n1 2 3 4 5 6 7 8 9 10 #!/bin/bash # . /root/shell/base_function.lib # ä¹Ÿå¯ä»¥ç”¨ source; è¦ç”¨ç»å¯¹è·¯å¾„ add 1 2 divide 7 3 sys_load ","date":"2023-12-17T15:14:06+08:00","image":"https://blog-source-mkt.oss-cn-chengdu.aliyuncs.com/blog_source/post/images/Shellå‡½æ•°/cover.png","permalink":"/p/shell%E5%87%BD%E6%95%B0/","title":"Shellå‡½æ•°"},{"content":"å¸¸ç”¨é€‰é¡¹ (æ‰¾æ–‡ä»¶) è¯­æ³•æ ¼å¼ é€‰é¡¹å‚æ•°è¡¨: å¸¸ç”¨ è§£é‡Š -name find /etc -name \u0026lsquo;*conf\u0026rsquo; -iname find /etc -name \u0026lsquo;*conf\u0026rsquo; å¿½ç•¥å¤§å°å†™ -user find . -user username -group find . -group groupname -type find . -type f -size find /etc -size -10000c æŸ¥æ‰¾å°äº10000å­—èŠ‚çš„æ–‡ä»¶ -type å‚æ•° -type å‚æ•° å¯¹åº”æ–‡ä»¶ç±»å‹ f æ–‡ä»¶ç±»å‹ d ç›®å½• c å­—ç¬¦è®¾å¤‡æ–‡ä»¶ b å—è®¾å¤‡æ–‡ä»¶ l é“¾æ¥æ–‡ä»¶ p ç®¡é“æ–‡ä»¶ -size å‚æ•° -size å‚æ•° è¯´æ˜ -n find /etc -size -10000c æŸ¥æ‰¾å°äº10000å­—èŠ‚çš„æ–‡ä»¶ +n find /etc -size +1M æŸ¥æ‰¾å¤§äº10000å­—èŠ‚çš„æ–‡ä»¶ c : å­—èŠ‚\nk: 1000å­—èŠ‚\nM : Mb\n-mtime ä»¥å¤©ä¸ºå•ä½\n-mtime å‚æ•° è¯´æ˜ -n n å¤©å†…ä¿®æ”¹çš„æ–‡ä»¶ +n n å¤©ä»¥å‰ä¿®æ”¹çš„æ–‡ä»¶ n ç¬¬ n å¤©ä¿®æ”¹çš„æ–‡ä»¶ ç¤ºä¾‹\næŸ¥æ‰¾ /etc ä¸‹ 5 å¤©å†…ä¿®æ”¹çš„æ–‡ä»¶, å¹¶ä»¥ conf ç»“å°¾ æŸ¥æ‰¾ /etc 10 å¤©å‰ä¿®æ”¹çš„æ–‡ä»¶, å±ä¸»ä¸º root 1 2 3 $ find /etc -mtime -5 -name \u0026#39;*conf\u0026#39; $ find /etc -mtime +10 -user root -mmin -mmin å‚æ•° è¯´æ˜ -n n åˆ†é’Ÿå†…ä¿®æ”¹ +n n åˆ†é’Ÿä»¥å‰ä¿®æ”¹ -mindepth è¦ä½œä¸º find ç¬¬ä¸€ä¸ªé€‰é¡¹\nä»ç¬¬ n çº§å­ç›®å½•å¼€å§‹æœç´¢\nè¦æœç´¢çš„ç›®å½•ä¸ºç¬¬ä¸€ä¸ªç›®å½•\n-maxdepth -newer\n1 $ find /etc -newer 123.txt # æŸ¥æ‰¾æ¯” 123.txt æ›´æ–°çš„æ–‡ä»¶ find æ“ä½œ (æ‰§è¡Œ) -print -exec -ok : ä¸ -exec ä¸€è‡´, éœ€è¦ç”¨æˆ·äº¤äº’ -exec åˆ é™¤\n1 $ find ./etc -name \u0026#34;*conf\u0026#34; -exec rm -rf {} \\; å¤åˆ¶\n1 $ find ./etc -size +1M -exec cp {} ./test/ \\; ç»ƒä¹ : æŠŠ /var/log/ ä¸‹ 7 å¤©ä»¥ä¸Šçš„æ–‡ä»¶åˆ é™¤\n1 $ find /var/log/ -name \u0026#34;*.log\u0026#34; -mtime +7 -exec rm -rf {} \\; é€»è¾‘è¿ç®—ç¬¦ -a ä¸ -o æˆ– -not | ! é 1 2 3 4 5 6 7 $ find . -not -user \u0026lt;username\u0026gt; $ find . ! -user \u0026lt;username\u0026gt; $ find -type f -a -user \u0026lt;username\u0026gt; -a -size +300c # å±ä¸»ä¸º ? æˆ–ä»¥ .yml ç»“å°¾çš„æ–‡ä»¶ $ find . -type f -a \\( -user \u0026lt;username\u0026gt; -o -name \u0026#39;*.yml\u0026#39; \\) å…¶ä»–æŸ¥æ‰¾å‘½ä»¤ locate: é»˜è®¤éƒ¨åˆ†åŒ¹é… ä½äºè½¯ä»¶åŒ… mlocate\nfind æ˜¯ç›´æ¥ä»ç£ç›˜ä¸­æŸ¥æ‰¾, locate æ˜¯ä»æ•°æ®åº“ä¸­æŸ¥æ‰¾\næ•°æ®åº“æ–‡ä»¶ä½ç½®: /var/lib/mlocate/mlocate.db -\u0026gt; é€šè¿‡ updatedb æ›´æ–°æ•°æ®åº“æ–‡ä»¶\næ•°æ®åº“é…ç½®æ–‡ä»¶: /etc/updatedb.conf\nåœ¨åå° cron å®šå®šæ—¶ä»»åŠ¡æ‰§è¡Œæ›´æ–°\nwhereis: æŸ¥æ‰¾äºŒè¿›åˆ¶æ–‡ä»¶ é€‰é¡¹ è¯´æ˜ -b äºŒè¿›åˆ¶æ–‡ä»¶ -m è¿”å›å¸®åŠ©æ–‡æ¡£ -s è¿”å›æºä»£ç æ–‡ä»¶ which: æŸ¥æ‰¾äºŒè¿›åˆ¶ç¨‹åºæ–‡ä»¶ 1 which mysql ","date":"2023-12-17T15:13:03+08:00","image":"https://blog-source-mkt.oss-cn-chengdu.aliyuncs.com/blog_source/public/hero.png","permalink":"/p/find%E6%96%87%E4%BB%B6%E6%9F%A5%E6%89%BE/","title":"Findæ–‡ä»¶æŸ¥æ‰¾"},{"content":"1. å˜é‡æ›¿æ¢ è¯­æ³• è§£é‡Š ${å˜é‡#åŒ¹é…è§„åˆ™} ä»å¤´å¼€å§‹åŒ¹é…, åˆ é™¤æœ€çŸ­åŒ¹é… ${å˜é‡##åŒ¹é…è§„åˆ™} ä»å¤´å¼€å§‹åŒ¹é…, åˆ é™¤æœ€é•¿åŒ¹é…(è´ªå©ªåŒ¹é…) ${å˜é‡%åŒ¹é…è§„åˆ™} ä»å°¾éƒ¨å¼€å§‹åŒ¹é…, åˆ é™¤æœ€çŸ­åŒ¹é… ${å˜é‡%%åŒ¹é…è§„åˆ™} ä»å°¾éƒ¨å¼€å§‹åŒ¹é…, åˆ é™¤æœ€é•¿åŒ¹é…(è´ªå©ªåŒ¹é…) ${å˜é‡/æ—§å­—ç¬¦ä¸²/æ–°å­—ç¬¦ä¸²} æ›¿æ¢å˜é‡, åªæ›¿æ¢ç¬¬ä¸€ä¸ªåŒ¹é…é¡¹ ${å˜é‡//æ—§å­—ç¬¦ä¸²/æ–°å­—ç¬¦ä¸²} æ›¿æ¢å˜é‡, æ›¿æ¢æ‰€æœ‰åŒ¹é…é¡¹ ç¤ºä¾‹: 1 $ var=\u0026#34;I love you, Do you love me\u0026#34; ${å˜é‡#åŒ¹é…è§„åˆ™}\n1 2 $ var1=${var#*ov} # åŒ¹é…æ—¶ä»ç¬¬ä¸€ä¸ªå­—ç¬¦å¼€å§‹åŒ¹é… $ echo $var1 è¾“å‡º:\n1 e you, Do you love me ${å˜é‡##åŒ¹é…è§„åˆ™}\n1 2 $ var2=${var##*ov} $ echo $var2 è¾“å‡º:\n1 e me ${å˜é‡%åŒ¹é…è§„åˆ™}\n1 2 $ var3=${var%ov*} $ echo $var3 è¾“å‡º:\n1 I love you, Do you l ${å˜é‡%%åŒ¹é…è§„åˆ™}\n1 2 $ var4=${var%%ov*} $ echo $var4 è¾“å‡º:\n1 I l ${å˜é‡/æ—§å­—ç¬¦ä¸²/æ–°å­—ç¬¦ä¸²}\n1 $ echo $PATH è¾“å‡º:\n1 /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/snap/bin 1 2 $ var5=${PATH/bin/BIN} $ echo $var5 è¾“å‡º:\n1 /usr/local/sBIN:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/snap/bin ${å˜é‡//æ—§å­—ç¬¦ä¸²/æ–°å­—ç¬¦ä¸²}\n1 2 $ var6=${PATH//bin/BIN} $ echo $var6 è¾“å‡º:\n1 /usr/local/sBIN:/usr/local/BIN:/usr/sBIN:/usr/BIN:/sBIN:/BIN:/snap/BIN 2. å˜é‡æµ‹è¯• å˜é‡æµ‹è¯•å®é™…ç”¨å¾—è¾ƒå°‘, å¤§å¤šéƒ½å¯ä»¥é€šè¿‡if-elseæ›¿æ¢\nå˜é‡æ›¿æ¢å‚ç…§è¡¨\nç¤ºä¾‹: var=${str-expr}\n1. æ²¡æœ‰è®¾ç½®å˜é‡\n1 2 $ unset var $ echo ${var-expr} è¾“å‡º:\n1 expr 2. è®¾ç½®å˜é‡, ä¸”å˜é‡ä¸ºç©º\n1 2 $ var= $ echo ${var-expr} è¾“å‡º:\n1 # è¾“å‡ºç©ºå€¼ 3. è®¾ç½®å˜é‡, ä¸”å˜é‡éç©º\n1 2 $ var=test $ echo ${var-expr} è¾“å‡º:\n1 test 3. å­—ç¬¦ä¸²å¤„ç† è®¡ç®—å­—ç¬¦ä¸²é•¿åº¦ è¯­æ³• è¯´æ˜ æ–¹æ³•ä¸€ ${#string} æ—  æ–¹æ³•äºŒ expr length \u0026ldquo;$string\u0026rdquo; string æœ‰ç©ºæ ¼ï¼Œåˆ™å¿…é¡»åŠ åŒå¼•å·, (å»ºè®®åŠ ä¸Š \u0026quot;\u0026quot; ) ç¤ºèŒƒ\n1 2 3 4 5 $ str=shellLearning $ echo ${#str} # 13 $ echo $(expr length \u0026#34;$str\u0026#34;) # 13 è·å–å­—ç¬¦åœ¨å­—ç¬¦ä¸²ä¸­çš„ç´¢å¼•ä½ç½® 1 2 3 4 5 6 7 8 9 $ expr index \u0026#34;$string\u0026#34; $substring $ var=\u0026#34;kubernetes is popular\u0026#34; $ idx=`expr index \u0026#34;$var\u0026#34; t` # var ä¸­æœ‰ç©ºæ ¼, åŠ  \u0026#34;\u0026#34; $ echo $idx # 8 $ idx=`expr index \u0026#34;$var\u0026#34; te` # å­ä¸²ä¼šè¢«æ‹†æˆä¸€ä¸ªä¸ªå­—ç¬¦ä¸€æ¬¡åŒ¹é…, è¿”å›ç¬¬ä¸€ä¸ªåŒ¹é… $ echo $idx # 4 è·å–å­ä¸²é•¿åº¦ 1 2 3 4 5 6 7 8 9 $ expr match \u0026#34;$var\u0026#34; substr # å­ä¸²å¿…é¡»ä»å¤´ç¬¬ä¸€ä¸ªå­—ç¬¦å¼€å§‹åŒ¹é… $ var=\u0026#34;kubernetes is popular\u0026#34; $ idx=`expr match \u0026#34;$var\u0026#34; popu` $ echo $idx # 0 $ idx=`expr match \u0026#34;$var\u0026#34; ku.*` $ echo $idx # 21 æŠ½å–å­ä¸² è¯­æ³• è¯´æ˜ ${string:position} ä» string ä¸­ position å¼€å§‹åˆ°ç»“å°¾ ${string:position:length} ä» string ä¸­ position å¼€å§‹, åŒ¹é…é•¿åº¦ä¸º length ${string: -position} ä»å³è¾¹å¼€å§‹åŒ¹é… ${string:(position)} ä»å·¦è¾¹å¼€å§‹åŒ¹é… expr substr \u0026ldquo;$string\u0026rdquo; $position $length ä» string ä¸­ position å¼€å§‹, åŒ¹é…é•¿åº¦ä¸º length :ç´¢å¼•ä» 0 å¼€å§‹\nexpr ç´¢å¼•ä» 1 å¼€å§‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 $ var=\u0026#34;kubecetes istio etcd operator\u0026#34; $ substr=${var:7} $ echo $substr # es istio etcd operator $ substr=${var:7:6} $ echo $substr # es ist $ substr=${var: -7} $ echo $substr # perator $ substr=${var:(-7)} $ echo $substr # perator $ substr=`expr substr \u0026#34;$var\u0026#34; 7 6` # tes is è„šæœ¬ç»ƒä¹  æ€è·¯:\næ ¹æ®åŠŸèƒ½åˆ’åˆ†, ç¼–å†™å“åº”å‡½æ•° å®ç°å®šä¹‰å‡½æ•° ä¸»æµç¨‹è®¾è®¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 #!/bin/bash # str=\u0026#34;Bigdata process framework is Hadoop,Hadoop is an open source project\u0026#34; function print_tips { echo \u0026#34;************************************\u0026#34; echo \u0026#34;(1) æ‰“å° string é•¿åº¦\u0026#34; echo \u0026#34;(2) åˆ é™¤å­—ç¬¦ä¸²ä¸­æ‰€æœ‰çš„ Hadoop\u0026#34; echo \u0026#34;(3) æ›¿æ¢ç¬¬ä¸€ä¸ª Hadoop ä¸º Mapreduce\u0026#34; echo \u0026#34;(4) æ›¿æ¢å…¨éƒ¨ Hadoop ä¸º Mapreduce\u0026#34; echo \u0026#34;************************************\u0026#34; } function len_of_string { echo \u0026#34;${#str}\u0026#34; } function del_hadoop { echo \u0026#34;${str//Hadoop/}\u0026#34; } function replace_hadoop_mapreduce_first { echo \u0026#34;${str/Hadoop/Mapreduce}\u0026#34; } function replace_hadoop_mapreduce_all { echo \u0026#34;${str//Hadoop/Mapreduce}\u0026#34; } while true do echo \u0026#34;[string: $str]\u0026#34; echo print_tips read -p \u0026#34;Please input your choice(1|2|3|4|q|Q): \u0026#34; choice case $choice in 1) len_of_string ;; 2) del_hadoop ;; 3) replace_hadoop_mapreduce_first ;; 4) replace_hadoop_mapreduce_all ;; q|Q) exit ;; *) echo \u0026#34;Error input, only {1|2|3|4|q|Q}\u0026#34; ;; esac done 4. å‘½ä»¤æ›¿æ¢ ä½¿ç”¨ `command` ä½¿ç”¨ $(command) ç¤ºä¾‹ è·å–ç³»ç»Ÿæ‰€æœ‰ç”¨æˆ·\n1 2 3 4 5 6 7 8 9 #!/bin/bash # index=1 for user in `cat /etc/passwd | cut -d \u0026#34;:\u0026#34; -f 1` do echo \u0026#34;This is $index user: $user\u0026#34; index=$(($index+1)) # ((index++)) done è·å–å¹´ä»½\n1 2 3 4 5 6 $ echo $(($(date +%Y) + 1)) # 2024 # ç­‰ä»· $ echo $((num1+num2)) $ echo $(($num1+$num2)) è®¡ç®—æ˜ŸæœŸ\n1 2 3 4 5 6 #!/bin/bash # echo \u0026#34;Today is the $(date +%j) of year.\u0026#34; echo \u0026#34;This year has passed $(($(date +%j) / 7)) weeks\u0026#34; echo \u0026#34;This year has $(((365-$(date +%j)) / 7))\u0026#34; åˆ¤æ–­è¿›ç¨‹æ˜¯å¦å­˜æ´»\n1 2 3 4 5 6 7 8 #!/bin/bash # nginx_num=$(ps -ef | grep nginx | grep -v grep | wc -l) if [ $nginx_num -eq 0 ]; then systemctl start nginx fi æœ‰ç±»å‹å˜é‡ declare ä¸ typeset å‘½ä»¤\nä¸¤è€…ç­‰ä»·\ndeclare å‘½ä»¤å‚æ•°è¡¨:\nä¸ä¹‹ç›¸å, å–æ¶ˆå˜é‡, æŠŠ-æ”¹ä¸º+\n5. Bash æ•°å­¦è¿ç®— expr ä¸ $(()) $(()) : åªå¯ç”¨äºåŠ å‡ä¹˜é™¤\nå‚æ•°è¡¨\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 $ num1=17 $ num2=5 $ expr $num1 + $num2 # 22 $ expr $num1 - $num2 # 12 $ expr $num1 \\* $num2 # 85 $ expr $num1 / $num2 # 3 $ expr $num1 % $num2 # 2 $ expr $num1 \\\u0026gt; $num2 # çœŸä¸º 1, å‡ä¸º 0 # 1 $ expr $num1 \\\u0026lt; $num2 # 0 ç»ƒä¹ :\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 #!/bin/bash # while true do read -p \u0026#34;Pls input a integer: \u0026#34;: num expr $num + 1 \u0026amp;\u0026gt; /dev/null # expr åªæ”¯æŒæ•´æ•° if [ $? -eq 0 ]; then if [ `expr $num \\\u0026gt; 0` -eq 1 ]; then for((i=1;i\u0026lt;$num;i++)) do sum=`expr $sum + $i ` done echo \u0026#34;1+2+...+$num = $sum\u0026#34; exit else echo \u0026#34;error not positive\u0026#34; fi else echo \u0026#34;error inlegle input\u0026#34; fi done bc åªæ”¯æŒæŒ‡æ•°è¿ç®— 1 2 3 4 $ echo \u0026#34;7.6/3.7\u0026#34; | bc # 2 $ echo \u0026#34;scale=4;7.6/3.7\u0026#34; | bc # bc ä¸­ scale ä¸ºç²¾åº¦ # 2.0540 ","date":"2023-12-17T14:56:44+08:00","image":"https://blog-source-mkt.oss-cn-chengdu.aliyuncs.com/blog_source/post/images/Shellå˜é‡/cover.webp","permalink":"/p/shell%E5%8F%98%E9%87%8F/","title":"Shellå˜é‡"}]